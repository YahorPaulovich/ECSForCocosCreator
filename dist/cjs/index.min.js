/*! *****************************************************************************
 *
 * miski
 * v0.1.4
 *
 * MIT License
 * 
 * Copyright (C) 2021 Peter Hughes<https://www.phugh.es>, all rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
***************************************************************************** */
"use strict";function _createComponent(e){const{id:t,name:n,properties:r}={...e};let o=e.entityLimit??null,i=void 0===e.entityLimit;!function deepAssign(e,...t){return t.forEach((t=>{const n=Object.keys(t).reduce(((e,n)=>{const r=Object.getOwnPropertyDescriptor(t,n);return void 0!==r&&(e[n]=r),e}),{});Object.getOwnPropertySymbols(t).forEach((e=>{const r=Object.getOwnPropertyDescriptor(t,e);r?.enumerable&&(n[e]=r)})),Object.defineProperties(e,n)})),e}(r,e.properties);const c=new Set,s={get id(){return t},get name(){return n},get entities(){return Array.from(c)},get entityLimit(){return o},get properties(){return r},get removable(){return i}};return Object.freeze(Object.assign(s,{hasEntity:function(e){return c.has(e)},setEntityLimit:function(e){o=e},setRemovable:function(e){i=e},_addEntity:function(e){if(null!=o&&c.size>=o)throw new Error(`component "${n}" has reached its entity limit of ${o}.`);c.add(e)},_removeEntity:function(e){if(!i)throw new Error(`component ${n} is not removable.`);c.delete(e)}}))}function createMask(e){"number"==typeof e&&(e=BigInt(e));let{mask:t}={mask:1n<<e};const n={get value(){return t}};return Object.freeze(Object.assign(n,{has:function(e){return"number"==typeof e&&(e=BigInt(e)),Boolean((t&e)===t)},set:function(e){"number"==typeof e&&(e=BigInt(e)),t|=1n<<e},test:function(e){return"number"==typeof e&&(e=BigInt(e)),Boolean(0n!==(t&1n<<e))},toggle:function(e){"number"==typeof e&&(e=BigInt(e)),t^=1n<<e},toString:function(){return t.toString(2)},unset:function(e){"number"==typeof e&&(e=BigInt(e)),t&=~(1n<<e)}}))}function _createEntity(){const e=createMask(0n),t={},n=new Set;let r=0n,o=null;const i=Object.create({components:t},{archetype:{get:function(){return e.value}},allComponents:{get:function(){return Array.from(n)}},id:{get:function(){return r}},world:{get:function(){return o}}});return Object.freeze(Object.assign(i,{_setId:function(e){r=e},_setWorld:function(e){o=e},_addComponent:function(r){t[r.name]||(t[r.name]={...r.properties},e.set(r.id),n.add(r))},_removeComponent:function(r){t[r.name]&&(delete t[r.name],e.unset(r.id),n.delete(r))},hasComponent:function(e){const n="string"==typeof e?e:e.name;return Boolean(t[n])}}))}exports.createWorld=function createWorld(e){const{initialPoolSize:t=10,maxComponents:n=1024n}={...e},isComponentRegistered=function(e){return o.get(e.name)===e},addEntityToArchetypeArray=function(e){void 0===r.get(e.archetype)&&r.set(e.archetype,new Set),r.get(e.archetype)?.add(e)},removeEntityFromArchetypeArray=function(e){r.get(e.archetype)?.delete(e)},r=new Map,o=new Map,i=new Map,c=[],s=function _createPool(e){const{initialSize:t=2,create:n,destroy:r}={...e},o=[];for(let e=0;e<t;e++)o.push(n());return Object.freeze({get:function(){return o.pop()??n()},release:function(e){o.push(r(e))}})}({create:_createEntity,destroy:function(e){return e._setId(-1n),removeComponentsFromEntity(e,...e.allComponents),removeEntityFromArchetypeArray(e),e},initialSize:t});let u=0n,a=0n,f=0n,m={},d={};const p={get archetypes(){return Array.from(r.entries())},get components(){return Array.from(o.values())},get component(){return m},get entities(){return Array.from(i.values())},get entity(){return d},get systems(){return Array.from(c)}},createComponent=function(e){if(void 0!==n&&a>n)throw new Error("Maximum component count reached.");if(o.has(e.name))throw new Error(`component "${e.name}" already exists.`);const t=_createComponent({...e,id:a});return o.set(t.name,t),++a,t},addComponentsToEntity=function(e,...t){if(!e)throw new Error("no entity provided.");return t?.length?(removeEntityFromArchetypeArray(e),t.forEach((t=>{if(!1===isComponentRegistered(t))throw new Error(`component ${t.name} is not registered in this world.`);0==t.hasEntity(e)&&(t._addEntity(e),e._addComponent(t))})),addEntityToArchetypeArray(e),e):e},removeComponentsFromEntity=function(e,...t){if(!e)throw new Error("no entity provided.");return t?.length?(removeEntityFromArchetypeArray(e),t.forEach((t=>{if(!1===isComponentRegistered(t))throw new Error(`component ${t.name} is not registered in this world.`);1==t.hasEntity(e)&&(t._removeEntity(e),e._removeComponent(t))})),addEntityToArchetypeArray(e),e):e},removeSystem=function(e){if(!e?.name)return!1;const t=c.indexOf(e);return t>-1&&(c.splice(t,1),!0)},getSystemByName=function(e){if(e)return c.find((t=>t.name===e))},l=Object.assign(p,{createEntity:function(){const e=s.get();return e._setId(u),e._setWorld(l),i.set(u,e),addEntityToArchetypeArray(e),++u,e},removeEntity:function(e){if(!e)return!1;const t=i.delete(e.id);return!0===t&&s.release(e),t},getEntityById:function(e){return i.get(e)},createComponent:createComponent,removeComponent:function(e){if(!e?.name)return!1;const t=o.delete(e.name);return!0===t&&e.entities.forEach((t=>removeComponentsFromEntity(t,e))),t},getComponentByName:function(e){return o.get(e)},addComponentsToEntity:addComponentsToEntity,removeComponentsFromEntity:removeComponentsFromEntity,createSystem:function(e,t){if(getSystemByName(e.name))throw new Error(`system "${e.name}" already exists.`);{const n=function _createSystem(e){const{components:t=[],id:n,name:r,updateFn:o=(()=>{}),renderFn:i=(()=>{})}={...e},c=createMask(0n);t.forEach((e=>c.set(e.id)));let s=!1;const u={get archetype(){return c.value},get enabled(){return s},get id(){return n},get name(){return r}};return Object.freeze(Object.assign(u,{enable:function(){s=!0},disable:function(){s=!1},update:function(e,t){o(e,t)},render:function(e,t){i(e,t)}}))}({...e,id:f});return void 0!==t?c.splice(t,0,n):c.push(n),++f,n}},removeSystem:removeSystem,moveSystem:function(e,t){if(!e?.id)throw new Error("no system provided.");if(void 0===t||"number"!=typeof t)throw new Error("no new index provided.");return!0===removeSystem(e)&&c.splice(t,0,e),e},getSystemByName:getSystemByName,update:function(e){const t=Array.from(r.entries()),n=t.length-1,o=[];for(let r=c.length-1;r>=0;r--){const i=c[r];if(!1!==i.enabled){for(let e=n;e>=0;e--){const[n,r]=t[e];(i.archetype&n)===i.archetype&&o.push(...r)}i.update(e,o),o.length=0}}},render:function(e){const t=Array.from(r.entries()),n=t.length-1,o=[];for(let r=c.length-1;r>=0;r--){const i=c[r];if(!1!==i.enabled){for(let e=n;e>=0;e--){const[n,r]=t[e];(i.archetype&n)===i.archetype&&o.push(...r)}i.render(e,o),o.length=0}}}});return d=l.createEntity(),m=createComponent({name:"world",entityLimit:1,removable:!1,properties:{world:l}}),addComponentsToEntity(d,m),Object.freeze(l)};
//# sourceMappingURL=index.min.js.map
