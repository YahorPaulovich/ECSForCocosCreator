/*! *****************************************************************************
 *
 * miski
 * v0.1.3
 *
 * MIT License
 * 
 * Copyright (C) 2021 Peter Hughes<https://www.phugh.es>, all rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
***************************************************************************** */
"use strict";function _createComponent(e){const{id:t,name:n}={...e},r=function deepAssign(e,...t){return t.forEach((t=>{const n=Object.keys(t).reduce(((e,n)=>{const r=Object.getOwnPropertyDescriptor(t,n);return void 0!==r&&(e[n]=r),e}),{});Object.getOwnPropertySymbols(t).forEach((e=>{const r=Object.getOwnPropertyDescriptor(t,e);r?.enumerable&&(n[e]=r)})),Object.defineProperties(e,n)})),e}({},e.properties);let{entityLimit:o=null,removable:i=!0}={...e};const{entities:c}={entities:new Set},s={get id(){return t},get name(){return n},get entities(){return Array.from(c)},get entityLimit(){return o},get properties(){return r},get removable(){return i}};return Object.freeze(Object.assign(s,{hasEntity:function(e){return c.has(e)},setEntityLimit:function(e){o=e},setRemovable:function(e){i=e},_addEntity:function(e){if(null!=o&&c.size>=o)throw new Error(`component "${n}" has reached its entity limit of ${o}.`);c.add(e)},_removeEntity:function(e){if(!i)throw new Error(`component ${n} is not removable.`);c.delete(e)}}))}function createMask(e){"number"==typeof e&&(e=BigInt(e));let{mask:t}={mask:1n<<e};const n={get value(){return t}};return Object.freeze(Object.assign(n,{has:function(e){return"number"==typeof e&&(e=BigInt(e)),Boolean((t&e)===t)},set:function(e){"number"==typeof e&&(e=BigInt(e)),t|=1n<<e},test:function(e){return"number"==typeof e&&(e=BigInt(e)),Boolean(0n!==(t&1n<<e))},toggle:function(e){"number"==typeof e&&(e=BigInt(e)),t^=1n<<e},toString:function(){return t.toString(2)},unset:function(e){"number"==typeof e&&(e=BigInt(e)),t&=~(1n<<e)}}))}function _createEntity(){const{archetype:e,components:t,componentObjects:n}={archetype:createMask(0n),components:{},componentObjects:new Set};let{_id:r}={_id:0n};const o=Object.create({components:t},{archetype:{get:function(){return e.value}},allComponents:{get:function(){return Array.from(n)}},id:{get:function(){return r}}});return Object.freeze(Object.assign(o,{_setId:function(e){r=e},_addComponent:function(r){t[r.name]||(t[r.name]={...r.properties},e.set(r.id),n.add(r))},_removeComponent:function(r){t[r.name]&&(delete t[r.name],e.unset(r.id),n.delete(r))},hasComponent:function(e){const n="string"==typeof e?e:e.name;return Boolean(t[n])}}))}function _createPool(e){const{initialSize:t=2,create:n,destroy:r}={...e},o=[];for(let e=0;e<t;e++)o.push(n());return Object.freeze({get:function(){return o.pop()??n()},release:function(e){o.push(r(e))}})}exports.createWorld=function createWorld(e){const{initialPoolSize:t=10,maxComponents:n=1024n}={...e},{archetypes:r,components:o,entities:i,systems:c,entityPool:s}={archetypes:new Map,components:new Map,entities:new Map,systems:[],entityPool:_createPool({create:_createEntity,destroy:function _destroyEntity(e){return e._setId(-1n),removeComponentsFromEntity(e,...e.allComponents),removeEntityFromArchetypeArray(e),e},initialSize:t})};let{componentCount:a,entityCount:u,systemCount:m,worldComponent:p,worldEntity:f}={componentCount:0n,entityCount:0n,systemCount:0n,worldComponent:{},worldEntity:{}};const addEntityToArchetypeArray=e=>{void 0===r.get(e.archetype)&&r.set(e.archetype,new Set),r.get(e.archetype)?.add(e)},removeEntityFromArchetypeArray=e=>{r.get(e.archetype)?.delete(e)},l={get archetypes(){return Array.from(r.entries())},get components(){return Array.from(o.values())},get component(){return p},get entities(){return Array.from(i.values())},get entity(){return f},get systems(){return Array.from(c)}},createEntity=function(){const e=s.get();return e._setId(u),i.set(u,e),addEntityToArchetypeArray(e),++u,e},createComponent=function(e){if(n&&a>n)throw new Error("Maximum component count reached.");const t=_createComponent({...e,id:a});return o.set(t.name,t),++a,t},addComponentsToEntity=function(e,...t){return removeEntityFromArchetypeArray(e),t.forEach((t=>{t._addEntity(e),e._addComponent(t)})),addEntityToArchetypeArray(e),e},removeComponentsFromEntity=function(e,...t){return removeEntityFromArchetypeArray(e),t.forEach((t=>{t._removeEntity(e),e._removeComponent(t)})),addEntityToArchetypeArray(e),e};f=createEntity();const d=Object.freeze(Object.assign(l,{createEntity:createEntity,removeEntity:function(e){const t=i.delete(e.id);return t&&s.release(e),t},createComponent:createComponent,removeComponent:function(e){const t=o.delete(e.name);return t&&e.entities.forEach((t=>removeComponentsFromEntity(t,e))),t},addComponentsToEntity:addComponentsToEntity,removeComponentsFromEntity:removeComponentsFromEntity,createSystem:function(e,t){const n=function _createSystem(e){const{id:t,components:n=[],updateFn:r=(()=>{}),renderFn:o=(()=>{})}={...e},{archetype:i}={archetype:createMask(0n)};n.forEach((e=>i.set(e.id)));let{enabled:c}={enabled:!1};const s={get archetype(){return i.value},get enabled(){return c},get id(){return t}};return Object.freeze(Object.assign(s,{enable:function(){c=!0},disable:function(){c=!1},update:function(e,t){r(e,t)},render:function(e,t){o(e,t)}}))}({...e,id:m});return void 0!==t?c.splice(t,0,n):c.push(n),++m,n},removeSystem:function(e){const t=c.indexOf(e);return t>-1&&(c.splice(t,1),!0)},update:function(e){const t=Array.from(r.entries()),n=t.length-1,o=[];for(let r=c.length-1;r>=0;r--){const i=c[r];if(!1!==i.enabled){for(let e=n;e>=0;e--){const[n,r]=t[e];(i.archetype&n)===i.archetype&&o.push(...r)}i.update(e,o),o.length=0}}},render:function(e){const t=Array.from(r.entries()),n=t.length-1,o=[];for(let r=c.length-1;r>=0;r--){const i=c[r];if(!1!==i.enabled){for(let e=n;e>=0;e--){const[n,r]=t[e];(i.archetype&n)===i.archetype&&o.push(...r)}i.render(e,o),o.length=0}}}}));return p=createComponent({name:"world",entityLimit:1,removable:!1,properties:{world:d}}),addComponentsToEntity(f,p),d};
//# sourceMappingURL=index.min.js.map
