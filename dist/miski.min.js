/*! Miski v0.8.0. MIT license. (C) 2021-2022 P. Hughes<github@phugh.es>(https://www.phugh.es). All rights reserved. **/
const t=1e6,e=Object.freeze(["component","id","isTag","name","schema","size","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]),n=/^(?![0-9])[a-zA-Z0-9$_]+$/,r=Object.freeze([]);function o(t){return!isNaN(t)&&t>=0&&t<=4294967295}function i(t){return Boolean("function"==typeof t&&Object.prototype.hasOwnProperty.call(t,"BYTES_PER_ELEMENT"))}function c(t){return Boolean("string"==typeof t&&t.length>0&&!0===n.test(t)||!e.includes(t))}function a(t){return Boolean("object"==typeof t&&!Array.isArray(t))}function u(t){return a(t)&&Object.entries(t).every((([t,e])=>c(t)&&(t=>{if(!Array.isArray(t))return i(t);{const[e,n]=t;if(!isNaN(n)&&i(e))return!0}return!1})(e)))}function s(t,e){return t+(Array.isArray(e)?e[0].BYTES_PER_ELEMENT:e.BYTES_PER_ELEMENT)}function f(t){return Object.values(t).reduce(s,0)}function y(t){if(!t)throw new SyntaxError("Component creation requires a specification object.");const{name:e,schema:n}=t;if(!c(e))throw new SyntaxError("Component name is invalid.");if(n&&!u(n))throw new SyntaxError("Component schema is invalid.");return Object.freeze({isTag:!n,name:e,schema:n?Object.freeze({...n}):null,size:n?f(n):0})}function p(t){if(!t)throw new SyntaxError("createQuery: specification object is required.");const{all:e=r,any:n=r,none:o=r}=t;if(![...e,...n,...o].every((t=>Object.prototype.hasOwnProperty.call(t,"name"))))throw new SyntaxError("Query specification object is invalid.");return Object.freeze({all:Object.freeze([...e]),any:Object.freeze([...n]),none:Object.freeze([...o])})}function l(t){return function(e){return function(...n){return t(e,...n)}}}function d(t){const{bitfield:e,id:n}=function(t){if(!t)throw new SyntaxError("Archetype: specification object required.");const{bitfield:e,id:n}=t;if(!e)throw new SyntaxError("Archetype: spec.bitfield is required.");return{bitfield:e,id:n||e.toString()}}(t),o=new Set,i=new Set,c=new Set,a={bitfield:e,entered:o,entities:i,exited:c,id:n},{addEntity:u,getEntities:s,removeEntity:f}=function(t){const{entities:e,entered:n,exited:r}=t;return{addEntity:function(r){return e.add(r),n.add(r),t},getEntities:function(){return e.values()},hasEntity:function(t){return e.has(t)},removeEntity:function(n){return e.delete(n),r.add(n),t}}}(a),{cloneInStep:y,cloneWithToggle:p,purgeCloneCache:l}=function(t){const{bitfield:e}=t,n=new Map;return{cloneInStep:function(t){if(n.has(t)){const e=n.get(t);return[e.id,()=>e]}{const{id:r}=t,o=e.copy().toggle(r),i=o.toString();return[i,function(){const e=d({bitfield:o,id:i});return n.set(t,e),e}]}},cloneWithToggle:function(t){if(n.has(t))return n.get(t);const{id:r}=t,o=d({bitfield:e.copy().toggle(r)});return n.set(t,o),o},purgeCloneCache:function(){return n.clear()}}}(a),{isCandidate:E,purgeCandidateCache:h}=function(t){const{bitfield:e}=t,n=e.array,o=new Map;return{isCandidate:function(t){if(o.has(t))return o.get(t)||!1;const{and:e,or:i,not:c}=t,a=c?.array??r,u=e?.array??r,s=i?.array??r,f=n.every((function(t,e){const n=a[e]??0,r=u[e]??0,o=s[e]??0;return 0==(n&t)&&(r&t)===r&&!((o&t)>0)}));return o.set(t,f),f},purgeCandidateCache:function(){return o.clear()}}}(a);return Object.freeze(Object.assign(a,{addEntity:u,cloneInStep:y,cloneWithToggle:p,getEntities:s,isCandidate:E,purge:()=>{h(),l()},refresh:()=>{o.clear(),c.clear()},removeEntity:f}))}function E(t){const{capacity:e,array:n}=function(t){if(!t)throw new SyntaxError("Bitfield: a specification object is required.");const{capacity:e,array:n}=t;if(!o(e))throw new SyntaxError("Bitfield: spec.capacity is invalid.");if(n){if(r=n,!Boolean(ArrayBuffer.isView(r)&&!(r instanceof DataView)))throw new TypeError("Bitfield: spec.array is invalid.");if(n.length!==e+31>>>5)throw new SyntaxError("Bitfield: spec.array is wrong size.")}var r;return{capacity:e,array:n||new Uint32Array(e+31>>>5)}}(t),r={capacity:e,array:n},i=function(t){return function(e){return null==e||isNaN(e)||e<0||e>t?-1:e>>>5}}(e),{clear:c}=function(t){const{array:e}=t;return{clear:function(){return e.fill(0),t}}}(r),{copy:a}=function(t){const{capacity:e,array:n}=t;return{copy:function(){return E({capacity:e,array:n.slice()})}}}(r),{isOn:u}=function(t,e){const{array:n}=t;return{isOn:function(t){const r=e(t);if(-1===r)return!1;const o=n[r];return!!o&&Boolean(o&1<<t-32*r)}}}(r,i),{off:s}=function(t,e){const{array:n}=t;return{off:function(r){const o=e(r);return-1===o||(n[o]&=~(1<<r-32*o)),t}}}(r,i),{on:f}=function(t,e){const{array:n}=t;return{on:function(r){const o=e(r);return-1===o||(n[o]|=1<<r-32*o),t}}}(r,i),{toggle:y}=function(t,e){const{array:n}=t;return{toggle:function(r){const o=e(r);return-1===o||(n[o]^=1<<r-32*o),t}}}(r,i),{toString:p}=function(t){const{array:e}=t;return{toString:function(){return e.toString()}}}(r);return Object.freeze(Object.assign(r,{clear:c,copy:a,isOn:u,off:s,on:f,toggle:y,toString:p}))}function h(t){const{components:e,partitioner:n}=t;return[...new Set(e)].reduce(((t,e,r)=>{const{name:i}=e;if(Object.prototype.hasOwnProperty.call(t,i))throw new Error(`ComponentInstance with name "${i}" already exists.`);const c=n(e);return t[i]=function(t){const{component:e,id:n,storage:r}=t;if(!e)throw new Error("Component instantiation requires as component!");if(!o(n))throw new SyntaxError("Component ID is invalid.");if(r&&!a(r))throw new TypeError("Component storage is malformed.");const i=Object.create(e,{id:{value:n,configurable:!1,enumerable:!0,writable:!1}});return Object.freeze(Object.assign(i,r))}({component:e,id:r,storage:c}),t}),{})}function g(t){const{capacity:e,components:n,getEntityArchetype:r,isValidEntity:o,updateArchetype:i}=t,c=function(t){const{capacity:e,components:n}=t,r=function(t,e){return e.reduce((function(e,n){const{size:r=0}=n;return!r||r<=0?e:e+r*t}),0)}(e,n);return new ArrayBuffer(8*Math.ceil(r/8))}({capacity:e,components:n}),a=function(t){const{buffer:e,capacity:n}=t;let r=0,o=!1;return function(t){if(!0===o)throw new Error("ArrayBuffer is full!");const{schema:i,size:c=0}=t;if(!c||c<=0)return;if(r+c*n>e.byteLength)throw new Error("Component will not fit inside the buffer!");let a=0;const u=Object.entries(i).reduce((function(t,[o,i]){let c=i,u=0;if(Array.isArray(i)){const[t,e]=i;c=t,u=e}return t[o]=new c(e,r+a,n),0!==u&&t[o].fill(u),a+=c.BYTES_PER_ELEMENT*n,t}),{});return r+=a,r>e.byteLength&&(o=!0),u}}({buffer:c,capacity:e}),u=h({components:n,partitioner:a}),s=new Map;Object.values(u).forEach((t=>{s.set(Object.getPrototypeOf(t),t)}));return Object.freeze({componentMap:s,addComponentToEntity(t,e,n){if(!o(e))return!1;const r=s.get(t);return!!r&&(i(e,r),t.schema&&Object.entries(t.schema).forEach((([t,n])=>{Array.isArray(n)&&(r[t][e]=n[1]??0)})),n&&Object.entries(n).forEach((([t,n])=>{r[t][e]=n})),!0)},entityHasComponent(t,e){const n=s.get(e);if(!n)return!1;const o=r(t);if(!o)return!1;const{bitfield:i}=o;return i.isOn(n.id)},getBuffer:()=>c.slice(0),removeComponentFromEntity(t,e){if(!o(e))return!1;const n=s.get(t);return!!n&&(i(e,n),!0)},setBuffer:t=>{if(t.byteLength!==c.byteLength)throw new Error("setBuffer - byteLength mismatch!");const e=new Uint8Array(t);return new Uint8Array(c).set(e),c.slice(0)}})}function m(t){if(!t)throw new SyntaxError("EntityManager creation requires a spec object.");const{capacity:e}=t,n=function(t){const e=[];return e.length=t,e}(e),r=function(t){const e=t-1;return Array.from({length:t},((t,n)=>e-n))}(e),i=function(t){return function(e){return!(!o(e)||e>t)}}(e);return Object.freeze({createEntity:()=>r.pop(),destroyEntity(t){if(!i(t))return!1;const e=n[t];return void 0!==e&&(e.removeEntity(t),delete n[t],r.push(t),!0)},getEntityArchetype:t=>n[t],getVacancyCount:()=>r.length,hasEntity:t=>i(t)&&void 0!==n[t],isValidEntity:i,setEntityArchetype:(t,e)=>!!i(t)&&(n[t]=e,!0)})}function b(t){const{bitfieldFactory:e,componentMap:n}=t,r=new Map,o=t=>{if(!function(t){if(!Array.isArray(t.all)||!Array.isArray(t.any)||!Array.isArray(t.none))return!1;const{any:e,all:n,none:r}=t;return[...n,...e,...r].every((t=>Object.prototype.hasOwnProperty.call(t,"name")))}(t))throw new Error("Object is not a valid query.");const o=function(t){const{componentMap:e,query:n,bitfieldFactory:r}=t,o=new Set,i={},c={},a=(t,n)=>{const r=e.get(n);if(!r)throw new Error(`Component ${n.name} not found.`);return t.push(r),t},u=t=>{i[t.name]=t};if(n.all.length){const t=n.all.reduce(a,[]);t.forEach(u),c.and=r(t)}if(n.any.length){const t=n.any.reduce(a,[]);t.forEach(u),c.or=r(t)}if(n.none.length){const t=n.none.reduce(a,[]);c.not=r(t)}Object.freeze(i);const s=t=>{t.isCandidate(c)&&o.add(t)};return Object.freeze(Object.assign(Object.create(n),{getComponents:()=>i,getEntered:()=>[...o].flatMap((t=>[...t.entered])),getEntities:()=>[...o].flatMap((t=>[...t.entities])),getExited:()=>[...o].flatMap((t=>[...t.exited])),refresh:t=>t.forEach(s)}))}({bitfieldFactory:e,componentMap:n,query:t});return r.set(t,o),o};return{queryMap:r,getQueryEntered:function(t){return(r.get(t)??o(t)).getEntered()},getQueryExited:function(t){return(r.get(t)??o(t)).getExited()},getQueryResult:function(t){const e=r.get(t)??o(t);return[e.getEntities(),e.getComponents()]}}}const w=Object.freeze({version:"0.8.0"});function O(e){const{capacity:n,components:r}=function(e){if(!e)throw new SyntaxError("World creation requires a specification object.");const{capacity:n=t,components:r}=e;if(!o(n))throw new SyntaxError("World creation: spec.capacity invalid.");if(!r.length)throw new SyntaxError("World creation: spec.components invalid.");return{capacity:n,components:r}}(e),i=function(t){return function(t){return function(){return t.copy().clear()}}(E({capacity:t}))}(r.length),{createEntity:c,destroyEntity:a,getEntityArchetype:u,getVacancyCount:s,hasEntity:f,isValidEntity:y,setEntityArchetype:p}=m({capacity:n}),{archetypeMap:l,updateArchetype:h}=function(t){const{bitfieldFactory:e,getEntityArchetype:n,setEntityArchetype:r}=t,o=new Map;return{archetypeMap:o,updateArchetype(t,i){const c=n(t);let a;if(c){c.removeEntity(t);const[e,n]=c.cloneInStep(i);o.has(e)?a=o.get(e):(a=n(),o.set(e,a))}else a=d({bitfield:e([i])}),o.set(a.id,a);return a.addEntity(t),r(t,a),a}}}({bitfieldFactory:i,getEntityArchetype:u,setEntityArchetype:p}),{componentMap:O,addComponentToEntity:j,entityHasComponent:A,getBuffer:S,removeComponentFromEntity:C,setBuffer:v}=g({capacity:n,components:r,getEntityArchetype:u,isValidEntity:y,updateArchetype:h}),{queryMap:_,getQueryEntered:B,getQueryExited:x,getQueryResult:z}=b({bitfieldFactory:i,componentMap:O}),{load:M,save:T}=function(t){const{getBuffer:e,setBuffer:n}=t;return{load:function(t){const{componentBuffer:e}=t;return n(e),!0},save:function(){return Object.freeze({componentBuffer:e()})}}}({getBuffer:S,setBuffer:v});function q(){[...l.values()].forEach((t=>t.purge()))}function P(){const t=[...l.values()];_.forEach((e=>e.refresh(t)));t.forEach((t=>t.refresh()))}return q(),P(),Object.freeze(Object.assign(Object.create(w),{capacity:n,addComponentToEntity:j,createEntity:c,destroyEntity:a,entityHasComponent:A,getEntityArchetype:u,getQueryEntered:B,getQueryExited:x,getQueryResult:z,getVacancyCount:s,hasEntity:f,load:M,purgeCaches:q,refresh:P,removeComponentFromEntity:C,save:T}))}export{y as createComponent,p as createQuery,l as createSystem,O as createWorld};
//# sourceMappingURL=miski.min.js.map
