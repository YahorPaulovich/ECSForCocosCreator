/*! Miski v0.7.0. MIT license. (C) 2021-2022 P. Hughes<github@phugh.es>(https://www.phugh.es). All rights reserved. **/
const t=1e6,e=Object.freeze(["component","id","isTag","name","schema","size","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]),n=/^(?![0-9])[a-zA-Z0-9$_]+$/;function r(t){return!isNaN(t)&&t>=0&&t<=4294967295}function i(t){return Boolean("string"==typeof t&&t.length>0&&!0===n.test(t)||!e.includes(t))}function o(t){return Boolean("object"==typeof t&&!Array.isArray(t))}function c(t,e){return t+e.BYTES_PER_ELEMENT}function a(t){return Object.values(t).reduce(c,0)}function s(t){if(!t)throw new SyntaxError("Component creation requires a specification object.");const{name:e,schema:n}=t;if(!i(e))throw new SyntaxError("Component name is invalid.");if(n&&!function(t){return o(t)&&Object.keys(t).every((t=>i(t)))}(n))throw new SyntaxError("Component schema is invalid.");const r={isTag:!n,name:e,schema:n?Object.freeze({...n}):null,size:n?a(n):0};var c;return r.instance=(c=r,function(t){return t.components.get(c)}),Object.freeze(r)}function y(t){if(!t)throw new SyntaxError("createQuery: specification object is required.");const{all:e=[],any:n=[],none:r=[]}=t;if(![...e,...n,...r].every((t=>Object.prototype.hasOwnProperty.call(t,"name"))))throw new SyntaxError("Query specification object is invalid.");const i={all:Object.freeze([...e]),any:Object.freeze([...n]),none:Object.freeze([...r])};return i.getResult=function(t){const{components:e,bitfieldFactory:n,queries:r}=t;let o=r.get(i);return o||(o=function(t){const{components:e,bitfieldFactory:n,query:r}=t,i={},o={},c={};let a,s,y;r.all.length&&(a=n(r.all.reduce(((t,n)=>{const r=e.get(n);if(!r)throw new Error(`Component ${n.name} not found.`);return i[n.name]=r,t.push(r),t}),[])));r.any.length&&(s=n(r.any.reduce(((t,n)=>{const r=e.get(n);if(!r)throw new Error(`Component ${n.name} not found.`);return o[n.name]=r,t.push(r),t}),[])));r.none.length&&(y=n(r.none.reduce(((t,n)=>{const r=e.get(n);if(!r)throw new Error(`Component ${n.name} not found.`);return c[n.name]=r,t.push(r),t}),[])));const u=Object.freeze({...o,...i}),f={and:a,archetypeCache:new Map,archetypes:new Set,components:u,not:y,or:s};return Object.freeze(Object.assign(f,{getComponents:()=>u,getEntities:()=>[...new Set([...f.archetypes].flatMap((t=>[...t.entities])))],refresh:t=>{t.forEach((t=>{const e=f.archetypeCache.get(t);!0===e?f.archetypes.add(t):!1===e?f.archetypes.delete(t):t.isCandidate(f)?(f.archetypes.add(t),f.archetypeCache.set(t,!0)):(f.archetypes.delete(t),f.archetypeCache.set(t,!1))}))}}))}({components:e,bitfieldFactory:n,query:i}),r.set(i,o)),[o.getEntities(),o.getComponents()]},Object.freeze(i)}function u(t){const{id:e,bitfield:n}=function(t){if(!t)throw new SyntaxError("Archetype: specification object required.");const{bitfield:e,id:n}=t;if(!e)throw new SyntaxError("Archetype: spec.bitfield is required.");return{bitfield:e,id:n||e.toString()}}(t),r={entities:new Set,id:e,bitfield:n},{addEntity:i,getEntities:o,removeEntity:c}=function(t){const{entities:e}=t;return{addEntity:function(n){return e.add(n),t},getEntities:function(){return[...e]},hasEntity:function(t){return e.has(t)},removeEntity:function(n){return e.delete(n),t}}}(r),{cloneWithToggle:a,cloneInStep:s}=function(t){const{bitfield:e}=t,n=new Map;return{cloneWithToggle:function(t){if(n.has(t))return n.get(t);const{id:r}=t,i=e.copy().toggle(r),o=u({bitfield:i,id:i.toString()});return n.set(t,o),o},cloneInStep:function(t){if(n.has(t)){const e=n.get(t);return[e.id,()=>e]}{const{id:r}=t,i=e.copy().toggle(r);return[i.toString(),function(){const e=u({bitfield:i,id:i.toString()});return n.set(t,e),e}]}}}}(r),{isCandidate:y}=function(t){const{bitfield:e}=t,n=e.array,r=[],i=new Map;return{isCandidate:function(t){if(i.has(t))return i.get(t)||!1;const{and:e,or:o,not:c}=t,a=c?.array??r,s=e?.array??r,y=o?.array??r,u=n.every((function(t,e){const n=a[e]??0,r=s[e]??0,i=y[e]??0;return 0==(n&t)&&(r&t)===r&&!((i&t)>0)}));return i.set(t,u),u}}}(r),f=Object.assign(r,{addEntity:i,getEntities:o,removeEntity:c,cloneInStep:s,cloneWithToggle:a,isCandidate:y});return Object.freeze(f)}function f(t){const{components:e,partitioner:n}=t;return[...new Set(e)].reduce(((t,e,i)=>{const{name:c}=e;if(c in t)throw new Error(`ComponentInstance with name "${c}" already exists.`);const a=n(e);return t[c]=function(t){const{component:e,id:n,storage:i}=t;if(!e)throw new Error("Component instantiation requires as component!");if(!r(n))throw new SyntaxError("Component ID is invalid.");if(i&&!o(i))throw new TypeError("Component storage is malformed.");const c=Object.create(e,{component:{value:e,configurable:!1,enumerable:!0,writable:!1},id:{value:n,configurable:!1,enumerable:!0,writable:!1}});return Object.freeze(Object.assign(c,i))}({component:e,id:i,storage:a}),t}),{})}function p(t){const{components:e,entityCapacity:n,getEntityArchetype:r,updateArchetype:i}=t,o=(()=>{const t=function(t){const{buffer:e,entityCapacity:n}=t;let r=0,i=!1;return function(t){if(!0===i)throw new Error("ArrayBuffer is full!");const{schema:o,size:c=0}=t;if(!c||c<=0)return;if(r+c*n>e.byteLength)throw new Error("Component will not fit inside the buffer!");let a=0;const s=Object.entries(o).reduce((function(t,[i,o]){return t[i]=new o(e,r+a,n),a+=o.BYTES_PER_ELEMENT*n,t}),{});return r+=a,r>e.byteLength&&(i=!0),s}}({buffer:function(t){const{entityCapacity:e,components:n}=t,r=function(t,e){return e.reduce((function(e,n){const{size:r=0}=n;return!r||r<=0?e:e+r*t}),0)}(e,n);return new ArrayBuffer(8*Math.ceil(r/8))}({entityCapacity:n,components:e}),entityCapacity:n});return f({components:e,partitioner:t})})(),c=new Map;function a(t){return"string"==typeof t?o[t]:c.get(t)}return Object.values(o).forEach((t=>{c.set(t.component,t)})),Object.freeze({componentMap:c,addComponentToEntity(t,e,n){const r=a(t);return!!r&&(i(e,r),n&&Object.entries(n).forEach((([t,n])=>{r[t][e]=n})),!0)},entityHasComponent(t,e){const n=a(t);if(!n)return!1;const i=r(e);if(!i)return!1;const{bitfield:o}=i;return o.isOn(n.id)},removeComponentFromEntity(t,e){const n=a(t);return!!n&&(i(e,n),!0)}})}function l(t){if(!t)throw new SyntaxError("EntityManager creation requires a spec object.");const{availableEntities:e,entityArchetypes:n,entityCapacity:i}=t,o=(c=i,function(t){return!(!r(t)||t>c)});var c;return Object.freeze({createEntity:()=>e.pop(),destroyEntity(t){if(o(t)&&null!=n[t]){const r=n[t];return r&&r.removeEntity(t),e.push(t),delete n[t],!0}return delete n[t],!1},getEntityArchetype:t=>n[t],hasEntity:t=>o(t)&&void 0!==n[t],setEntityArchetype:(t,e)=>!!o(t)&&(n[t]=e,!0)})}function d(t){const{capacity:e,array:n}=function(t){if(!t)throw new SyntaxError("Bitfield: a specification object is required.");const{capacity:e,array:n}=t;if(!r(e))throw new SyntaxError("Bitfield: spec.capacity is invalid.");if(n){if(i=n,!Boolean(ArrayBuffer.isView(i)&&!(i instanceof DataView)))throw new TypeError("Bitfield: spec.array is invalid.");if(n.length!==e+31>>>5)throw new SyntaxError("Bitfield: spec.array is wrong size.")}var i;return{capacity:e,array:n||new Uint32Array(e+31>>>5)}}(t),i={capacity:e,array:n},o=function(t){return function(e){return null==e||isNaN(e)||e<0||e>t?-1:e>>>5}}(e),{clear:c}=function(t){const{array:e}=t;return{clear:function(){return e.fill(0),t}}}(i),{copy:a}=function(t){const{capacity:e,array:n}=t;return{copy:function(){return d({capacity:e,array:n.slice()})}}}(i),{isOn:s}=function(t,e){const{array:n}=t;return{isOn:function(t){const r=e(t);if(-1===r)return!1;const i=n[r];return!!i&&Boolean(i&1<<t-32*r)}}}(i,o),{off:y}=function(t,e){const{array:n}=t;return{off:function(r){const i=e(r);return-1===i||(n[i]&=~(1<<r-32*i)),t}}}(i,o),{on:u}=function(t,e){const{array:n}=t;return{on:function(r){const i=e(r);return-1===i||(n[i]|=1<<r-32*i),t}}}(i,o),{toggle:f}=function(t,e){const{array:n}=t;return{toggle:function(r){const i=e(r);return-1===i||(n[i]^=1<<r-32*i),t}}}(i,o),{toString:p}=function(t){const{array:e}=t;return{toString:function(){return e.toString()}}}(i);return Object.freeze(Object.assign(i,{clear:c,copy:a,isOn:s,off:y,on:u,toggle:f,toString:p}))}const h=Object.freeze({version:"0.7.0"});function E(e){const{components:n,entityCapacity:i}=function(e){if(!e)throw new SyntaxError("World creation requires a specification object.");const{components:n=[],entityCapacity:i=t}=e;if(!r(i))throw new SyntaxError("World creation: spec.entityCapacity invalid.");if(!n.length)throw new SyntaxError("World creation: spec.components invalid.");return{components:n,entityCapacity:i}}(e),{availableEntities:o}=function({entityCapacity:t}){return{availableEntities:(t=>{const e=t-1;return Array.from({length:t},((t,n)=>e-n))})(t)}}({entityCapacity:i}),{entityArchetypes:c}=function({entityCapacity:t}){const e=[];return e.length=t,{entityArchetypes:e}}({entityCapacity:i}),{emptyBitfield:a,bitfieldFactory:s}=function({capacity:t}){const e=d({capacity:t});return{emptyBitfield:e,bitfieldFactory:function(t){return function(){return t.copy().clear()}}(e)}}({capacity:n.length}),{createEntity:y,destroyEntity:f,getEntityArchetype:E,hasEntity:m,setEntityArchetype:g}=l({availableEntities:o,entityArchetypes:c,entityCapacity:i}),{archetypeMap:b,updateArchetype:w}=function(t){const{bitfieldFactory:e,getEntityArchetype:n,setEntityArchetype:r}=t,i=new Map,o=new Map;return{archetypeMap:o,updateArchetype(t,c){const a=n(t);let s;if(a){a.removeEntity(t);const[e,n]=a.cloneInStep(c);o.has(e)?s=o.get(e):(s=n(),o.set(e,s))}else i.has(c)?s=i.get(c):(s=u({bitfield:e([c])}),i.set(c,s),o.set(s.id,s));return s.addEntity(t),r(t,s),s}}}({bitfieldFactory:s,getEntityArchetype:E,setEntityArchetype:g}),{componentMap:C,addComponentToEntity:j,entityHasComponent:O,removeComponentFromEntity:S}=p({components:n,entityCapacity:i,getEntityArchetype:E,updateArchetype:w}),v=new Map,A=Object.assign(Object.create(h),{entityCapacity:i,availableEntities:o,entityArchetypes:c,archetypes:b,components:C,queries:v,emptyBitfield:a,bitfieldFactory:s});function _(){const t=[...b.values()];v.forEach((e=>e.refresh(t)))}return _(),Object.freeze(Object.assign(Object.create(A),{createEntity:y,destroyEntity:f,getEntityArchetype:E,hasEntity:m,addComponentToEntity:j,entityHasComponent:O,removeComponentFromEntity:S,refreshWorld:_}))}export{s as createComponent,y as createQuery,E as createWorld};
//# sourceMappingURL=miski.min.js.map
