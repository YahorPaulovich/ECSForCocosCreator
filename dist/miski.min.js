/*! Miski v0.11.1. MIT license. (C) 2021-2022 the Miski authors. All rights reserved. **/
/*! @author P. Hughes<github@phugh.es>(https://www.phugh.es) **/
const e=Object.freeze(["changed","component","count","eid","entity","id","isTag","maxEntities","name","owners","proxy","schema","size","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]),t=/^(?![0-9])[a-zA-Z0-9$_]+$/,n=Object.freeze([]),r=Symbol("changed"),i=Symbol("owners"),s=Object.freeze({1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10,2048:11,4096:12,8192:13,16384:14,32768:15,65536:16,131072:17,262144:18,524288:19,1048576:20,2097152:21,4194304:22,8388608:23,16777216:24,33554432:25,67108864:26,134217728:27,268435456:28,536870912:29,1073741824:30,2147483648:31});function o(e){return!isNaN(e)&&e>=0&&e<=4294967295}function a(e){return o(e)&&e>0}function c(e){return Boolean("function"==typeof e&&Object.prototype.hasOwnProperty.call(e,"BYTES_PER_ELEMENT"))}function h(n){return Boolean("string"==typeof n&&n.length>0&&!1===e.includes(n)&&t.test(n))}function u(e){return Boolean("object"==typeof e&&!Array.isArray(e))}function y(e=0,t=0){return e&t}function p([e,t]){return h(e)&&function(e){if(Array.isArray(e)){const[t,n]=e;return!isNaN(n)&&c(t)}return c(e)}(t)}function l(e){try{if(void 0===e)return!1;if(null===e)return!0;if(!u(e))return!1;const t=Object.entries(e);return!!t.length&&t.every(p)}catch(e){return!1}}function f(e,t){return e+(Array.isArray(t)?t[0].BYTES_PER_ELEMENT:t.BYTES_PER_ELEMENT)}class d{isTag;maxEntities;name;schema;size;constructor(e){if(!e)throw new SyntaxError("A specification object is required.");const{maxEntities:t=null,name:n,schema:r=null}=e;if(t&&!a(t))throw new SyntaxError("spec.maxEntities must be a Uint32 > 0.");if(!h(n))throw new SyntaxError("spec.name is invalid.");if(!l(r))throw new SyntaxError("spec.schema is invalid.");this.isTag=!r,this.maxEntities=t??null,this.name=n,this.schema=r?Object.freeze({...r}):null,this.size=r?function(e){try{return l(e)?null===e?0:Object.values(e).reduce(f,0):Number.NaN}catch(e){return Number.NaN}}(r):0,Object.freeze(this)}}function g(e){return e instanceof d}class m{all;any;none;constructor(e){if(!e)throw new SyntaxError("Query specification object is required.");const{all:t=n,any:r=n,none:i=n}=e;if(![...t,...r,...i].every(g))throw new SyntaxError("Query specification object is invalid.");this.all=Object.freeze([...new Set(t)]),this.any=Object.freeze([...new Set(r)]),this.none=Object.freeze([...new Set(i)]),Object.freeze(this)}}class E{system;query;constructor(e){const{system:t,query:n}=e;this.system=t,this.query=n}init(e){const t=e.getQueryComponents(this.query),n=[];return(...r)=>this.system(t,e.getQueryEntities(this.query,n),...r)}}class w extends Uint32Array{static getSetBitCount(e){const t=e-(e>>1&1431655765),n=(858993459&t)+(t>>2&858993459);return 16843009*(n+(n>>4)&252645135)>>24}static getSetBitCountInBitfield(e){return e.reduce(((e,t)=>0===t?e:e+w.getSetBitCount(t)),0)}static fromObjects(e,t,n){return n.reduce(((e,n)=>(e.toggle(n[t]),e)),new w(e))}static indexOf(e){return isNaN(e)||e<0?-1:e>>>5}constructor(e){super(Math.ceil(e/32))}get size(){return this.length<<5}clone(){const e=new w(this.size);return e.set(this),e}cloneWithToggle(e,t){const n=this.clone();return t.forEach((t=>n.toggle(t[e]))),n}getPosition(e){const t=w.indexOf(e);return{index:t,position:e-(t<<5)}}isSet(e){const t=w.indexOf(e);return-1===t||void 0===this[t]?null:!!(this[t]&1<<e-32*t)}toggle(e){const t=w.indexOf(e);return-1===t?null:(this[t]^=1<<e-32*t,!!(this[t]&1<<e-32*t))}}class b{bitfield;candidateCache;components;entered;entities;exited;isDirty;constructor(e,t,n){this.bitfield=n??w.fromObjects(e,"id",t),this.candidateCache=new Map,this.components=t,this.entered=new Set,this.entities=new Set,this.exited=new Set,this.isDirty=!0}get id(){return this.bitfield.toString()}get isEmpty(){return 0===this.entities.size}addEntity(e){return this.entities.add(e),this.entered.add(e),this.isDirty=!0,this}clone(){return new b(this.bitfield.length,this.components,this.bitfield.clone())}isCandidate(e){const t=this.candidateCache.get(e);if(void 0!==t)return t;const n=this.bitfield.every(e.checkCandidacy);return this.candidateCache.set(e,n),n}refresh(){return this.entered.clear(),this.exited.clear(),this.isDirty=!1,this}removeEntity(e){return this.entities.delete(e),this.exited.add(e),this.isDirty=!0,this}toString(){return`\n{\n  bitfield: ${this.bitfield.toString()},\n  components: ${this.components.map((e=>e.id)).join(",")},\n  entities: ${[...this.entities.values()].join(",")},\n},\n    `}}class M{archetypeMap=new Map;entityArchetypes;rootArchetype;constructor(e){const{capacity:t,components:n}=e;this.rootArchetype=new b(n.length,[]),this.archetypeMap=new Map,this.archetypeMap.set(this.rootArchetype.id,this.rootArchetype),this.entityArchetypes=Array.from({length:t},((e,t)=>this.rootArchetype.addEntity(t)))}getArchetype(e){return this.entityArchetypes[e]}resetArchetype(e){return this.entityArchetypes[e]===this.rootArchetype||(this.entityArchetypes[e]?.removeEntity(e),this.entityArchetypes[e]=this.rootArchetype.addEntity(e)),this}refreshArchetypes(e){return this.archetypeMap.forEach((t=>{t.isEmpty||e.forEach((e=>{!e.archetypes.has(t)&&t.isCandidate(e)&&(e.isDirty=!0,e.archetypes.add(t))})),t.refresh()})),this}setArchetype(e,t){if(!this.archetypeMap.has(t.id))throw new Error("Invalid archetype.");return this.entityArchetypes[e]===t||(this.entityArchetypes[e]?.removeEntity(e),this.entityArchetypes[e]=t.addEntity(e)),this}updateArchetype(e,t){const n=this.entityArchetypes[e];n.removeEntity(e);const r=n.bitfield.cloneWithToggle("id",t),i=r.toString();let s=this.archetypeMap.get(i);return s||(s=new b(this.rootArchetype.bitfield.size,t,r),this.archetypeMap.set(i,s)),this.entityArchetypes[e]=s.addEntity(e),s}}function A(e,t){if(!e)throw new SyntaxError("Proxy can only be used on components, not tags.");if(!t)throw new SyntaxError("Proxy requires a changed set.");let n=0;return Object.freeze(Object.keys(e).reduce(((r,i)=>(Object.defineProperty(r,i,{get:()=>e[i][n],set(r){e[i][n]!==r&&(e[i][n]=r,t.add(n))}}),r)),{getEntity:()=>n,setEntity(e){if(isNaN(e))throw new TypeError("Expected entity to be a number.");return n=e,n}}))}function S(e){return e[r].clear(),e}class v extends w{nextAvailable=0;constructor(e){super(e),this.fill(4294967295)}get setCount(){return w.getSetBitCountInBitfield(this)}acquire(){const{nextAvailable:e}=this;if(!~e)return-1;const t=this[e],n=2147483648===(r=t)?31:s[r&-r]??-1;var r;if(this[e]&=~(1<<n),0===this[e]){this.nextAvailable=-1;for(let e=0;e<this.length;e++)if(0!==this[e]){this.nextAvailable=e;break}}return(e<<5)+n}release(e){const{index:t,position:n}=this.getPosition(e);return-1===t||(this[t]|=1<<n,this.nextAvailable=t),this}}function x(e){const t=new Map,n=new v(e.length);return new Proxy(e,{get:(n,r)=>{return i=r,e[t.get(i)??-1];var i},set:(r,i,s)=>((r,i)=>{const s=t.get(r)??n.acquire();return void 0!==s&&(e[s]=i,t.set(r,s),!0)})(i,s),deleteProperty:(r,i)=>(r=>{const i=t.get(r);return void 0!==i&&(e[i]=0,t.delete(r),n.release(i),!0)})(i)})}class C extends ArrayBuffer{static calculateSize(e,t){return t.reduce(((t,n)=>{const{size:r}=n;return!r||r<0?t:t+r*e}),0)}static partition(e,t,n){let r=0;return n.forEach((n=>{const{maxEntities:i,schema:s}=n;if(!s)return;const o={},a=i??t;Object.entries(s).forEach((([t,n])=>{let s=n,c=0;Array.isArray(n)&&([s,c]=n);const h=new s(e,r,a);o[t]=null===i?h:x(h),o[t].fill(c),r+=s.BYTES_PER_ELEMENT*a})),e.map.set(n,o)})),e}capacity;map=new Map;constructor(e){const{capacity:t,components:n}=e;super(C.calculateSize(t,n)),C.partition(this,t,n),this.capacity=t}}function O(e,t,n){return n.reduce(((n,s,c)=>{const h=function(e){const{capacity:t,component:n,id:s,storage:c}=e;if(!a(t))throw new SyntaxError("Capacity must be integer > 0.");if(!n)throw new Error("Component instantiation requires as component!");if(!o(s))throw new SyntaxError("Component ID is invalid.");if(c&&!u(c))throw new TypeError("Component storage is malformed.");const h=new Set,y=new w(t),p=Object.create(n,{[r]:{value:h,configurable:!1,enumerable:!1,writable:!1},[i]:{value:y,configurable:!1,enumerable:!1,writable:!1},changed:{get:()=>h.values()},count:{get:()=>w.getSetBitCountInBitfield(y)},id:{value:s,configurable:!1,enumerable:!0,writable:!1}});return c&&(Object.defineProperty(p,"proxy",{value:A(c,h),configurable:!1,enumerable:!0,writable:!1}),Object.keys(c).forEach((e=>{Object.defineProperty(p,e,{value:c[e]})}))),Object.freeze(p)}({capacity:t,component:s,id:c,storage:e.map.get(s)});return n.set(s,h),n}),new Map)}const j=(e,t,n)=>function(e,t,n){const{maxEntities:r,name:s,schema:o}=e;if(r&&e.count>=r)throw new Error(`Component "${s}".maxEntities reached.`);return e[i].isSet(t)?null:(e[i].toggle(t),o&&Object.entries(o).forEach((([r,i])=>{e[r][t]=n?n[s][r]??i[1]??0:i[1]??0})),e)}(e,t,n);const q=(e,t)=>function(e,t){const{maxEntities:n,schema:r}=e;return e[i].isSet(t)?(e[i].toggle(t),r&&Object.entries(r).forEach((([r,i])=>{const s=e[r];s&&(n?delete s[t]:s[t]=Array.isArray(i)?i[1]:0)})),e):null}(e,t);class _{buffer;componentMap;constructor(e){const{capacity:t,components:n}=e;this.buffer=new C({capacity:t,components:n}),this.componentMap=O(this.buffer,t,n)}addComponentsToEntity(e){const t=this.getInstances(e).filter(Boolean);if(t.length!==e.length)throw new Error("Some components are not registered in this world!");return(e,n)=>t.map((t=>j(t,e,n))).filter(Boolean)}removeComponentsFromEntity(e){const t=this.getInstances(e).filter(Boolean);if(t.length!==e.length)throw new Error("Some components are not registered in this world!");return e=>t.map((t=>q(t,e))).filter(Boolean)}getBuffer(){return this.buffer.slice(0)}getInstance(e){return this.componentMap.get(e)}getInstances(e){return e.map(this.getInstance,this)}setBuffer(e){if(e.byteLength!==this.buffer.byteLength)throw new Error("setBuffer: byteLength mismatch!");const t=new Uint8Array(e);return new Uint8Array(this.buffer).set(t),this}refreshComponents(){return this.componentMap.forEach(S),this}export(){return{buffer:this.buffer.slice(0),components:[...this.componentMap.values()]}}}function z({entered:e}){e.forEach(this.add,this)}function Q({entities:e}){e.forEach(this.add,this)}function B({exited:e}){e.forEach(this.add,this)}function I(e){e.isDirty=!1}class N{componentMap;entityCache;queryMap;constructor(e){const{componentManager:t}=e;this.componentMap=t.componentMap,this.entityCache=new Map,this.queryMap=new Map}getComponentsFromQuery(e){return this.getQueryInstance(e).components}getEnteredFromQuery(e,t=[]){t.length=0;const n=new Set;return this.getQueryInstance(e)?.archetypes.forEach(z,n),t.push(...n),t}getEntitiesFromQuery(e,t=[]){t.length=0;const n=this.getQueryInstance(e),{archetypes:r,isDirty:i}=n,s=this.entityCache.get(n);if(!s){const e=new Set;return r.forEach(Q,e),this.entityCache.set(n,e),t.push(...e),t}return!0===i?(s.clear(),r.forEach(Q,s),t.push(...s),t):(r.forEach((e=>{!0===e.isDirty&&(e.entered.forEach(s.add,s),e.exited.forEach(s.delete,s))})),t.push(...s),t)}getExitedFromQuery(e,t=[]){t.length=0;const n=new Set;return this.getQueryInstance(e)?.archetypes.forEach(B,n),t.push(...n),t}getQueryInstance(e){return this.registerQuery(e)}registerQuery(e){if(!(e instanceof m))throw new Error("Object is not a valid query.");const t=this.queryMap.get(e);if(t)return t;const n=function(e){const{componentMap:t,query:n}=e,{all:r,any:i,none:s}=n,o=(e,n,r)=>{const i=t.get(n);if(!i)throw new Error(`Component ${n.name} not found.`);return e[r]=i,e},a=t.size,c=r.reduce(o,new Array(r.length)),h=w.fromObjects(a,"id",c),u=i.reduce(o,new Array(i.length)),p=w.fromObjects(a,"id",u),l=s.reduce(o,new Array(s.length)),f=w.fromObjects(a,"id",l),d=[...c,...u].reduce(((e,t)=>(e[t.name]=t,e)),{});Object.freeze(d);const g=new Set;return Object.assign(Object.create(n),{isDirty:!0,archetypes:g,and:h,checkCandidacy:(e,t)=>(0===p[t]||y(e,p[t])>0)&&(!(y(e,h[t])!==h[t])&&0===y(e,f[t])),components:d,not:f,or:p})}({componentMap:this.componentMap,query:e});return this.queryMap.set(e,n),n}refreshQueries(){return this.queryMap.forEach(I),this}export(){return{queries:[...this.queryMap.values()]}}}class T{archetypeManager;componentManager;queryManager;entities;capacity;version="0.11.1";constructor(e){const{capacity:t,components:n}=function(e){if(!e||!u(e))throw new SyntaxError("World creation requires a specification object.");const{capacity:t,components:n}=e;if(!a(t))throw new SyntaxError("World: spec.capacity invalid.");if(!Array.isArray(n)||!n.every((e=>Object.prototype.hasOwnProperty.call(e,"name"))))throw new TypeError("World: spec.components invalid.");return{...e,components:[...new Set(n)]}}(e);this.capacity=t,this.entities=new v(t),this.archetypeManager=new M({capacity:t,components:n}),this.componentManager=new _({capacity:t,components:n}),this.queryManager=new N({componentManager:this.componentManager}),this.refresh(),Object.freeze(this)}get residents(){return this.capacity-(this.entities.setCount-(this.entities.size-this.capacity))}get vacancies(){return this.capacity-this.residents}addComponentsToEntity(...e){const t=this.componentManager.addComponentsToEntity(e),n=this;return(e,r)=>{if(!this.isValidEntity(e))throw new SyntaxError(`Entity ${e} is not valid!`);return this.archetypeManager.updateArchetype(e,t(e,r)),n}}createEntity(){if(this.residents>=this.capacity)return;const e=this.entities.acquire();return e<0?void 0:(this.archetypeManager.setArchetype(e,this.archetypeManager.rootArchetype),e)}destroyEntity(e){if(!this.isValidEntity(e))throw new SyntaxError(`Entity ${e} is not valid!`);return this.archetypeManager.entityArchetypes[e]?.components.forEach((t=>q(t,e))),this.archetypeManager.resetArchetype(e),this.entities.release(e),this}getChangedFromComponents(...e){const t=this.componentManager.getInstances(e).filter((e=>e));if(t.length!==e.length)throw new Error("Not all components registered!");return[...new Set(t.reduce(((e,t)=>(e.push(...t.changed),e)),[]))]}getChangedFromQuery(e,t=[]){const n=this.queryManager.getQueryInstance(e);return t.length=0,Object.values(n.components).forEach((e=>t.push(...e.changed))),[...new Set(t)]}getComponentInstance(e){return this.componentManager.componentMap.get(e)}getComponentInstances(...e){return this.componentManager.getInstances(e)}getEntityProperties(e){const t=this.archetypeManager.getArchetype(e);return t?t.components.reduce(((t,n)=>{const{name:r,schema:i}=n;return t[r]={},t[r]=null===i||Object.keys(i).reduce(((t,r)=>(t[r]=n[r][e],t)),{}),t}),{}):{}}getQueryComponents(e){return this.queryManager.getComponentsFromQuery(e)}getQueryEntered(e,t=[]){return this.queryManager.getEnteredFromQuery(e,t)}getQueryEntities(e,t=[]){return this.queryManager.getEntitiesFromQuery(e,t)}getQueryExited(e,t=[]){return this.queryManager.getExitedFromQuery(e,t)}hasComponent(e){const t=this.componentManager.getInstance(e);if(!t)throw new Error("Component is not registered.");return e=>t[i].isSet(e)}hasComponents(...e){const t=this.componentManager.getInstances(e).filter((e=>e));if(t.length!==e.length)throw new Error("Not all components registered!");return e=>t.map((t=>t[i].isSet(e)))}isEntityActive(e){return this.isValidEntity(e)?this.entities.isSet(e):null}isValidEntity(e){return o(e)&&e<this.entities.size}load(e){const{buffer:t,capacity:n,version:r}=e;if(r!==this.version)throw new Error(`Version mismatch. Trying to load ${r} data into ${this.version} world.`);if(n!==this.capacity)throw new Error(`Capacity mismatch. Data requires a world with a capacity of ${n}.`);return this.componentManager.setBuffer(t),this.refresh(),this}refresh(){return this.queryManager.refreshQueries(),this.archetypeManager.refreshArchetypes(this.queryManager.queryMap),this.componentManager.refreshComponents(),this}removeComponentsFromEntity(...e){const t=this.componentManager.removeComponentsFromEntity(e),n=this;return e=>{if(!this.isValidEntity(e))throw new SyntaxError(`Entity ${e} is not valid!`);return this.archetypeManager.updateArchetype(e,t(e)),n}}save(){return Object.freeze({buffer:this.componentManager.getBuffer(),capacity:this.capacity,version:this.version})}}export{d as Component,m as Query,E as System,T as World};
//# sourceMappingURL=miski.min.js.map
