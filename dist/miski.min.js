/*! Miski v0.7.0. MIT license. (C) 2021-2022 P. Hughes<github@phugh.es>(https://www.phugh.es). All rights reserved. **/
const t=1e6,e=Object.freeze(["component","id","isTag","name","schema","size","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]),n=/^(?![0-9])[a-zA-Z0-9$_]+$/,r=Object.freeze([]);function o(t){return!isNaN(t)&&t>=0&&t<=4294967295}function i(t){return Boolean("string"==typeof t&&t.length>0&&!0===n.test(t)||!e.includes(t))}function c(t){return Boolean("object"==typeof t&&!Array.isArray(t))}function a(t,e){return t+(Array.isArray(e)?e[0].BYTES_PER_ELEMENT:e.BYTES_PER_ELEMENT)}function s(t){return Object.values(t).reduce(a,0)}function u(t){if(!t)throw new SyntaxError("Component creation requires a specification object.");const{name:e,schema:n}=t;if(!i(e))throw new SyntaxError("Component name is invalid.");if(n&&!function(t){return c(t)&&Object.keys(t).every((t=>i(t)))}(n))throw new SyntaxError("Component schema is invalid.");return Object.freeze({isTag:!n,name:e,schema:n?Object.freeze({...n}):null,size:n?s(n):0})}function f(t){if(!t)throw new SyntaxError("createQuery: specification object is required.");const{all:e=r,any:n=r,none:o=r}=t;if(![...e,...n,...o].every((t=>Object.prototype.hasOwnProperty.call(t,"name"))))throw new SyntaxError("Query specification object is invalid.");return Object.freeze({all:Object.freeze([...e]),any:Object.freeze([...n]),none:Object.freeze([...o])})}function y(t){return function(e){return function(...n){return t(e,...n)}}}function p(t){const{id:e,bitfield:n}=function(t){if(!t)throw new SyntaxError("Archetype: specification object required.");const{bitfield:e,id:n}=t;if(!e)throw new SyntaxError("Archetype: spec.bitfield is required.");return{bitfield:e,id:n||e.toString()}}(t),o={entities:new Set,id:e,bitfield:n},{addEntity:i,getEntities:c,removeEntity:a}=function(t){const{entities:e}=t;return{addEntity:function(n){return e.add(n),t},getEntities:function(){return e.values()},hasEntity:function(t){return e.has(t)},removeEntity:function(n){return e.delete(n),t}}}(o),{cloneWithToggle:s,cloneInStep:u}=function(t){const{bitfield:e}=t,n=new Map;return{cloneWithToggle:function(t){if(n.has(t))return n.get(t);const{id:r}=t,o=p({bitfield:e.copy().toggle(r)});return n.set(t,o),o},cloneInStep:function(t){if(n.has(t)){const e=n.get(t);return[e.id,()=>e]}{const{id:r}=t,o=e.copy().toggle(r),i=o.toString();return[i,function(){const e=p({bitfield:o,id:i});return n.set(t,e),e}]}}}}(o),{isCandidate:f}=function(t){const{bitfield:e}=t,n=e.array,o=new Map;return{isCandidate:function(t){if(o.has(t))return o.get(t)||!1;const{and:e,or:i,not:c}=t,a=c?.array??r,s=e?.array??r,u=i?.array??r,f=n.every((function(t,e){const n=a[e]??0,r=s[e]??0,o=u[e]??0;return 0==(n&t)&&(r&t)===r&&!((o&t)>0)}));return o.set(t,f),f}}}(o),y=Object.assign(o,{addEntity:i,getEntities:c,removeEntity:a,cloneInStep:u,cloneWithToggle:s,isCandidate:f});return Object.freeze(y)}function l(t){const{components:e,partitioner:n}=t;return[...new Set(e)].reduce(((t,e,r)=>{const{name:i}=e;if(i in t)throw new Error(`ComponentInstance with name "${i}" already exists.`);const a=n(e);return t[i]=function(t){const{component:e,id:n,storage:r}=t;if(!e)throw new Error("Component instantiation requires as component!");if(!o(n))throw new SyntaxError("Component ID is invalid.");if(r&&!c(r))throw new TypeError("Component storage is malformed.");const i=Object.create(e,{id:{value:n,configurable:!1,enumerable:!0,writable:!1}});return Object.freeze(Object.assign(i,r))}({component:e,id:r,storage:a}),t}),{})}function d(t){const{components:e,capacity:n,getEntityArchetype:r,updateArchetype:o}=t,i=function(t){const{capacity:e,components:n}=t,r=function(t,e){return e.reduce((function(e,n){const{size:r=0}=n;return!r||r<=0?e:e+r*t}),0)}(e,n);return new ArrayBuffer(8*Math.ceil(r/8))}({capacity:n,components:e}),c=function(t){const{buffer:e,capacity:n}=t;let r=0,o=!1;return function(t){if(!0===o)throw new Error("ArrayBuffer is full!");const{schema:i,size:c=0}=t;if(!c||c<=0)return;if(r+c*n>e.byteLength)throw new Error("Component will not fit inside the buffer!");let a=0;const s=Object.entries(i).reduce((function(t,[o,i]){let c=i,s=0;if(Array.isArray(i)){const[t,e]=i;c=t,s=e}return t[o]=new c(e,r+a,n),0!==s&&t[o].fill(s),a+=c.BYTES_PER_ELEMENT*n,t}),{});return r+=a,r>e.byteLength&&(o=!0),s}}({buffer:i,capacity:n}),a=l({components:e,partitioner:c}),s=new Map;return Object.values(a).forEach((t=>{s.set(Object.getPrototypeOf(t),t)})),Object.freeze({componentMap:s,addComponentToEntity(t,e,n){const r=s.get(t);return!!r&&(o(e,r),t.schema&&Object.entries(t.schema).forEach((([t,n])=>{Array.isArray(n)&&(r[t][e]=n[1]??0)})),n&&Object.entries(n).forEach((([t,n])=>{r[t][e]=n})),!0)},entityHasComponent(t,e){const n=s.get(e);if(!n)return!1;const o=r(t);if(!o)return!1;const{bitfield:i}=o;return i.isOn(n.id)},removeComponentFromEntity(t,e){const n=s.get(t);return!!n&&(o(e,n),!0)}})}function h(t){if(!t)throw new SyntaxError("EntityManager creation requires a spec object.");const{capacity:e}=t,n=function(t){const e=[];return e.length=t,e}(e),r=function(t){const e=t-1;return Array.from({length:t},((t,n)=>e-n))}(e),i=function(t){return function(e){return!(!o(e)||e>t)}}(e);return Object.freeze({createEntity:()=>r.pop(),destroyEntity(t){const e=n[t];return!(!i(t)||void 0===e)&&(e.removeEntity(t),delete n[t],r.push(t),!0)},getEntityArchetype:t=>n[t],getVacancyCount:()=>r.length,hasEntity:t=>i(t)&&void 0!==n[t],setEntityArchetype:(t,e)=>!!i(t)&&(n[t]=e,!0)})}function E(t){const{capacity:e,array:n}=function(t){if(!t)throw new SyntaxError("Bitfield: a specification object is required.");const{capacity:e,array:n}=t;if(!o(e))throw new SyntaxError("Bitfield: spec.capacity is invalid.");if(n){if(r=n,!Boolean(ArrayBuffer.isView(r)&&!(r instanceof DataView)))throw new TypeError("Bitfield: spec.array is invalid.");if(n.length!==e+31>>>5)throw new SyntaxError("Bitfield: spec.array is wrong size.")}var r;return{capacity:e,array:n||new Uint32Array(e+31>>>5)}}(t),r={capacity:e,array:n},i=function(t){return function(e){return null==e||isNaN(e)||e<0||e>t?-1:e>>>5}}(e),{clear:c}=function(t){const{array:e}=t;return{clear:function(){return e.fill(0),t}}}(r),{copy:a}=function(t){const{capacity:e,array:n}=t;return{copy:function(){return E({capacity:e,array:n.slice()})}}}(r),{isOn:s}=function(t,e){const{array:n}=t;return{isOn:function(t){const r=e(t);if(-1===r)return!1;const o=n[r];return!!o&&Boolean(o&1<<t-32*r)}}}(r,i),{off:u}=function(t,e){const{array:n}=t;return{off:function(r){const o=e(r);return-1===o||(n[o]&=~(1<<r-32*o)),t}}}(r,i),{on:f}=function(t,e){const{array:n}=t;return{on:function(r){const o=e(r);return-1===o||(n[o]|=1<<r-32*o),t}}}(r,i),{toggle:y}=function(t,e){const{array:n}=t;return{toggle:function(r){const o=e(r);return-1===o||(n[o]^=1<<r-32*o),t}}}(r,i),{toString:p}=function(t){const{array:e}=t;return{toString:function(){return e.toString()}}}(r);return Object.freeze(Object.assign(r,{clear:c,copy:a,isOn:s,off:u,on:f,toggle:y,toString:p}))}function g(t){const{bitfieldFactory:e,componentMap:n}=t,r=new Map;return{queryMap:r,getQueryResult:function(t){let o=r.get(t);return o||(o=function(t){const{componentMap:e,bitfieldFactory:n,query:r}=t,o=new Set,i={},c={},a=(t,n)=>{const r=e.get(n);if(!r)throw new Error(`Component ${n.name} not found.`);return t.push(r),t},s=t=>{i[t.name]=t};if(r.all.length){const t=r.all.reduce(a,[]);t.forEach(s),c.and=n(t)}if(r.any.length){const t=r.any.reduce(a,[]);t.forEach(s),c.or=n(t)}if(r.none.length){const t=r.none.reduce(a,[]);c.not=n(t)}Object.freeze(i);const u=t=>{t.isCandidate(c)&&o.add(t)};return Object.freeze(Object.assign(Object.create(r),{getComponents:()=>i,getEntities:()=>[...o].flatMap((t=>[...t.entities])),refresh:t=>t.forEach(u)}))}({bitfieldFactory:e,componentMap:n,query:t}),r.set(t,o)),[o.getEntities(),o.getComponents()]}}}const m=Object.freeze({version:"0.7.0"});function b(e){const{components:n,capacity:r}=function(e){if(!e)throw new SyntaxError("World creation requires a specification object.");const{components:n,capacity:r=t}=e;if(!o(r))throw new SyntaxError("World creation: spec.capacity invalid.");if(!n.length)throw new SyntaxError("World creation: spec.components invalid.");return{components:n,capacity:r}}(e),i=function(t){return function(t){return function(){return t.copy().clear()}}(E({capacity:t}))}(n.length),{createEntity:c,destroyEntity:a,getEntityArchetype:s,getVacancyCount:u,hasEntity:f,setEntityArchetype:y}=h({capacity:r}),{archetypeMap:l,updateArchetype:b}=function(t){const{bitfieldFactory:e,getEntityArchetype:n,setEntityArchetype:r}=t,o=new Map;return{archetypeMap:o,updateArchetype(t,i){const c=n(t);let a;if(c){c.removeEntity(t);const[e,n]=c.cloneInStep(i);o.has(e)?a=o.get(e):(a=n(),o.set(e,a))}else a=p({bitfield:e([i])}),o.set(a.id,a);return a.addEntity(t),r(t,a),a}}}({bitfieldFactory:i,getEntityArchetype:s,setEntityArchetype:y}),{componentMap:w,addComponentToEntity:O,entityHasComponent:j,removeComponentFromEntity:S}=d({components:n,capacity:r,getEntityArchetype:s,updateArchetype:b}),{queryMap:A,getQueryResult:v}=g({bitfieldFactory:i,componentMap:w});function C(){const t=[...l.values()];A.forEach((e=>e.refresh(t)))}return C(),Object.freeze(Object.assign(Object.create(m),{capacity:r,addComponentToEntity:O,createEntity:c,destroyEntity:a,entityHasComponent:j,getEntityArchetype:s,getQueryResult:v,getVacancyCount:u,hasEntity:f,refresh:C,removeComponentFromEntity:S}))}export{u as createComponent,f as createQuery,y as createSystem,b as createWorld};
//# sourceMappingURL=miski.min.js.map
