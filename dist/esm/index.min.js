/*! *****************************************************************************
 *
 * miski
 * v0.3.0
 *
 * MIT License
 * 
 * Copyright (C) 2021 Peter Hughes<https://www.phugh.es>, all rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
***************************************************************************** */
const e=Object.freeze(["_world","defaults","id","name","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]);function bitIntersection(e,t){return e&t}function clamp(e,t,n){return null!=t&&e<t?t:null!=n&&e>n?n:e}function validName(t){return/^(?![0-9])[a-zA-Z0-9$_]+$/.test(t)&&!e.includes(t)}function isObject(e){return Boolean(e&&"object"==typeof e&&!Array.isArray(e))}function deepAssignObjects(e,...t){if(!t||!t.length)return e;const n={},r=t.shift();return isObject(e)&&isObject(r)&&(Object.keys(r).forEach((e=>{const t=Object.getOwnPropertyDescriptor(r,e);void 0!==t&&(n[e]={...t},isObject(t.value)?deepAssignObjects(t.value,r[e]):Array.isArray(t.value)&&(t.value=[...r[e]]))})),Object.getOwnPropertySymbols(r).forEach((e=>{const t=Object.getOwnPropertyDescriptor(r,e);void 0!==t&&t.enumerable&&(n[e]={...t},isObject(t.value)?deepAssignObjects(t.value,r[e]):Array.isArray(t.value)&&(t.value=[...r[e]]))})),Object.defineProperties(e,n)),deepAssignObjects(e,...t)}class Archetype{constructor(e,t=[]){this.id=e,this._registry=new Set(t)}get entities(){return[...this._registry]}addEntity(e){this._registry.add(e)}isEmpty(){return 0===this._registry.size}removeEntity(e){this._registry.delete(e)}}function createGetArchetype(e){return function getArchetype(t){return e.get(t)}}function createGetArchetypes(e){return function getArchetypes(){return[...e.values()]}}function createGetEntitiesByComponents(e){return function getEntitiesByComponents(...t){const n=new Set;return t.forEach((t=>{e.forEach(((e,r)=>{bitIntersection(t.id,r)>0&&e.entities.forEach((e=>n.add(e)))}))})),[...n]}}function createIsArchetypeRegistered(e){return function isArchetypeRegistered(t){return e.has(t.id)||[...e.values()].includes(t)}}function createUpdateArchetype(e,t){return function updateArchetype(n,r){if(void 0!==r){const t=e.get(r);t&&(t.removeEntity(n),t.isEmpty()&&e.delete(r))}const s=n.archetype;return e.has(s)?e.get(s)?.addEntity(n):e.set(s,new Archetype(s,[n])),t}}class Component{constructor(e,t,n){const{name:r}=n;this.id=t,this.name=r,this._world=e,this.defaults=deepAssignObjects({},n.defaults),Object.keys(this.defaults).forEach((e=>{Object.defineProperty(this,e,Object.getOwnPropertyDescriptor(this.defaults,e))}))}get entities(){return this._world.getEntitiesByComponents(this)}get isRegistered(){return this._world.isComponentRegistered(this)}}function createGetComponents(e){return function getComponents(){return[...e.values()]}}function createGetComponentById(e){return function getComponentById(t){return[...e.values()].find((e=>e.id===t))}}function createGetComponentByName(e){return function getComponentByName(t){return e.get(t)}}function createIsComponentRegistered(e){return function isComponentRegistered(t){return e.has(t.name)||[...e.values()].includes(t)}}function createRegisterComponent(e,t,n,r){return function registerComponent(s){if(e.size>=n)throw new Error("Maximum number of components reached.");if(!validName(s.name))throw new SyntaxError(`"${s.name}" is not a valid component name.`);if(e.has(s.name))throw new Error(`Component with name "${s.name}" already registered.`);const i=t.pop();if(void 0===i)throw new Error("No available component ids.");const o=new Component(r,i,s);return e.set(o.name,o),o}}function createUnregisterComponent(e,t,n){return function unregisterComponent(r){if(!e.has(r.name))throw new Error(`Component "${r.name}" is not registered.`);return r.entities.forEach((e=>e.removeComponent(r))),e.delete(r.name),t.unshift(r.id),n}}class Pool{constructor(e){const{create:t,destroy:n,initialSize:r,growthFactor:s,maxSize:i,world:o}=e;this.initialSize=r,this.growthFactor=s,this.maxSize=i,this._create=t,this._destroy=n,this._firstAvailable=null,this._pool=new Array(r),this._world=o,this.add(r)}add(e=1){for(let t=0;t<e;t++){if(this._pool.length>=this.maxSize)throw new Error("The pool is full!");const e=this._create(this._world);e.next=this._firstAvailable,this._firstAvailable=e,this._pool.push(e)}}clear(){this._pool.length=0,this._firstAvailable=null,this.add(this.initialSize)}get(){this._firstAvailable||this.add(this.initialSize*this.growthFactor);const e=this._firstAvailable;return this._firstAvailable=e.next,e}release(e){this._destroy(e),e.next=this._firstAvailable,this._firstAvailable=e}}class Mask{constructor(e=0n){this.mask=0n,this.mask=e}get value(){return this.mask}clear(){this.mask=0n}hasAll(e){return Boolean((e&this.mask)===this.mask)}hasAny(e){return Boolean(0n===this.mask||(e&this.mask)>0)}hasNone(e){return Boolean(0n===(e&this.mask))}off(e){return this.mask&=~(1n<<BigInt(e)),this.mask}on(e){return this.mask|=1n<<BigInt(e),this.mask}}class Entity{constructor(e){this.id=`${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`,this._archetype=new Mask,this._enabled=!1,this._next=null,this._properties=new Map,this._world=e}get archetype(){return this._archetype.value}get enabled(){return this._enabled}get next(){return this._next}set next(e){this._next=e}addComponent(e,t){if("string"==typeof e){const t=this._world.getComponentByName(e);if(!t)throw new Error(`Component "${e}" not found!`);e=t}if(e instanceof Component){if(this._properties.has(e))throw new Error(`Entity already has component "${e.name}".`);this._properties.set(e,deepAssignObjects({},e.defaults,t??{})),Object.defineProperty(this,e.name,{get:()=>this._properties.get(e),set:t=>{const n=this._properties.get(e);if(Object.isFrozen(n))throw new Error(`Properties in component "${e.name}" cannot be modified.`);if(!n)throw new Error(`Component "${e.name}" does not exist in entity.`);Object.entries(t).forEach((([t,r])=>{if(!(t in n))throw new Error(`Property "${t}" does not exist in component "${e.name}".`);n[t]=r}))},enumerable:!0,configurable:!0});const n=this._archetype.value;return this._archetype.on(e.id),this._world.updateArchetype(this,n),!0}throw new SyntaxError("Invalid or unregistered component.")}clear(){Object.keys(this._properties).forEach((e=>delete this[e])),this._properties.clear();const e=this._archetype.value;this._archetype.clear(),this._world.updateArchetype(this,e)}disable(){this._enabled=!1}enable(){this._enabled=!0}hasComponent(e){const t="string"==typeof e?e:e.name;return Boolean(Reflect.has(this._properties,t))}removeComponent(e){if("string"==typeof e){const t=this._world.getComponentByName(e);if(!t)throw new Error(`Component "${e}" not found!`);e=t}if(!this._properties.has(e))throw new Error(`Entity ${this.id} has no component "${e.name}".`);this._properties.delete(e);try{delete this[e.name]}catch(t){console.warn(`Could not remove property ${e.name} from entity.`)}const t=this._archetype.value;return this._archetype.off(e.id),this._world.updateArchetype(this,t),!0}}function createCreateEntity(e,t,n){return function createEntity(){const r=e.get();if(!(r&&r instanceof Entity))throw new Error("No entities left! Pool is empty.");return t.set(r.id,r),n.updateArchetype(r),r}}function createDestroyEntity(e,t,n){return function destroyEntity(r){return!!t.has(r.id)&&(n.getArchetype(r.archetype)?.removeEntity(r),t.delete(r.id),e.release(r),!0)}}function createGetEntities(e){return function getEntities(){return[...e.values()]}}function createGetEntityById(e){return function getEntityById(t){return e.get(t)}}function createIsEntityRegistered(e){return function isEntityRegistered(t){return e.has(t.id)||[...e.values()].includes(t)}}class Query{constructor(e,t){this._cache=new WeakSet,this._registry=new Set,this._world=e,this._all=new Set,this._any=new Set,this._none=new Set,this._mskAll=t.all?.reduce(((e,t)=>(this._all.add(t),e.on(t.id),e)),new Mask)??new Mask,this._mskAny=t.any?.reduce(((e,t)=>(this._any.add(t),e.on(t.id),e)),new Mask)??new Mask,this._mskNone=t.none?.reduce(((e,t)=>(this._none.add(t),e.on(t.id),e)),new Mask)??new Mask}get entities(){return[...this._registry]}get size(){return this._registry.size}hasEntity(e){return this._registry.has(e)}matches(e){const t=0n===this._mskAny.value||bitIntersection(e,this._mskAny.value)>0,n=bitIntersection(e,this._mskAll.value)===this._mskAll.value,r=0n===bitIntersection(e,this._mskNone.value);return t&&n&&r}update(){this._registry.clear(),this._world.getArchetypes().forEach((e=>{(this._cache.has(e)||this.matches(e.id))&&(e.entities.forEach((e=>this._registry.add(e))),this._cache.add(e))}))}}function createIsQueryRegistered(e){return function isQueryRegistered(t){return e.has(t)}}function createRegisterQuery(e,t){return function registerQuery(n){const r=new Query(t,n);return e.add(r),r}}function createUnregisterQuery(e,t){return function unregisterQuery(n){return e.delete(n),t}}function createUpdateQueries(e,t){return function updateQueries(){return e.forEach((e=>e.update())),t}}function createPre(e){return function pre(){return e.getPreSystems().forEach((t=>t.pre(t.entities,e.global))),e}}function createPost(e){return function post(t=0){return e.getPostSystems().forEach((n=>n.post(n.entities,e.global,t))),e.updateQueries(),e}}function createStep(e,t,n){let r=null,s=0;const i=t;return function step(o=0){if(null!==r){s+=.001*(o-r);let t=0;for(n.pre();s>i;){if(t>=e){s=1;break}n.update(i),s-=i,t++}}return r=o,n.post(s/t),n}}function createUpdate(e){return function update(t=0){return e.getUpdateSystems().forEach((n=>n.update(n.entities,e.global,t))),e}}function noopPre(e,t){}function noopPost(e,t,n){}function noopUpdate(e,t,n){}class System{constructor(e,t){const{name:n,query:r=null,pre:s=noopPre,post:i=noopPost,update:o=noopUpdate}=t;this.name=n,this.query=r,this.pre=s,this.post=i,this.update=o,this._enabled=!1,this._world=e}get enabled(){return this._enabled}get entities(){return null===this.query?this._world.getEntities():this.query.entities}disable(){this._enabled=!1}enable(){this._enabled=!0}}function createGetSystems(e){return function getSystems(){return[...e]}}function createGetPostSystems(e){return function getPostSystems(){return e.filter((e=>e.post&&e.post!==noopPost&&e.enabled))}}function createGetPreSystems(e){return function getPreSystems(){return e.filter((e=>e.pre&&e.pre!==noopPre&&e.enabled))}}function createGetUpdateSystems(e){return function getUpdateSystems(){return e.filter((e=>e.update&&e.update!==noopUpdate&&e.enabled))}}function createGetSystemByIdx(e){return function getSystemByIdx(t){return e[t]}}function createGetSystemByName(e){return function getSystemByName(t){return e.get(t)}}function createIsSystemRegistered(e){return function isSystemRegistered(t){return e.has(t.name)||[...e.values()].includes(t)}}function createMoveSystem(e){return function moveSystem(t,n){const r=e.indexOf(t);if(-1===r)return-1;const s=clamp(n,0,e.length);return e.splice(s,1),e.splice(r,0,t),s}}function createRegisterSystem(e,t,n){return function registerSystem(r,s){if(!validName(r.name))throw new SyntaxError(`"${r.name}" is not a valid system name.`);if(t.has(r.name))throw new Error(`System "${r.name}" is already registered!`);const i=new System(n,r);return void 0!==s?e.splice(clamp(s,0,e.length),0,i):e.push(i),t.set(i.name,i),i}}function createUnregisterSystem(e,t,n){return function unregisterSystem(r){if(!t.has(r.name))throw new Error(`System "${r.name}" is not registered!`);t.delete(r.name);const s=e.indexOf(r);return s>-1&&e.splice(s,1),n}}function createWorld(t={}){const{entityPoolGrowthFactor:n=.25,initialEntityPoolSize:r=128,maxComponents:s=256,maxEntities:i=Number.POSITIVE_INFINITY,maxUpdates:o=240,tempo:a=1/60}=t,c=Object.create(null);return Object.assign(c,function createArchetypeManager(e,t){const n=new Map;return{getArchetype:createGetArchetype(n),getArchetypes:createGetArchetypes(n),getEntitiesByComponents:createGetEntitiesByComponents(n),isArchetypeRegistered:createIsArchetypeRegistered(n),updateArchetype:createUpdateArchetype(n,e)}}(c),function createComponentManager(e,t){const{maxComponents:n}=t,r=new Array(n),s=new Map;for(let e=n,t=0n;e>=0;e--)r[e]=t++;return{getComponentById:createGetComponentById(s),getComponentByName:createGetComponentByName(s),getComponents:createGetComponents(s),isComponentRegistered:createIsComponentRegistered(s),registerComponent:createRegisterComponent(s,r,n,e),unregisterComponent:createUnregisterComponent(s,r,e)}}(c,{maxComponents:s}),function createEntityManager(e,t){const{entityPoolGrowthFactor:n,initialEntityPoolSize:r,maxEntities:s}=t,i=new Pool({create:function(){return new Entity(e)},destroy:function(e){e.clear()},initialSize:r,growthFactor:n,maxSize:s,world:e}),o=new Map;return{createEntity:createCreateEntity(i,o,e),destroyEntity:createDestroyEntity(i,o,e),getEntities:createGetEntities(o),getEntityById:createGetEntityById(o),isEntityRegistered:createIsEntityRegistered(o)}}(c,{entityPoolGrowthFactor:n,initialEntityPoolSize:r,maxEntities:i}),function createQueryManager(e,t){const n=new Set;return{isQueryRegistered:createIsQueryRegistered(n),registerQuery:createRegisterQuery(n,e),unregisterQuery:createUnregisterQuery(n,e),updateQueries:createUpdateQueries(n,e)}}(c),function createStepManager(e,t){const{maxUpdates:n,tempo:r}=t;return{post:createPost(e),pre:createPre(e),step:createStep(n,r,e),update:createUpdate(e)}}(c,{maxUpdates:o,tempo:a}),function createSystemManager(e,t){const n=[],r=new Map;return{getSystems:createGetSystems(n),getPostSystems:createGetPostSystems(n),getPreSystems:createGetPreSystems(n),getUpdateSystems:createGetUpdateSystems(n),getSystemByIdx:createGetSystemByIdx(n),getSystemByName:createGetSystemByName(r),isSystemRegistered:createIsSystemRegistered(r),moveSystem:createMoveSystem(n),registerSystem:createRegisterSystem(n,r,e),unregisterSystem:createUnregisterSystem(n,r,e)}}(c)),c.global=c.createEntity(),c.FORBIDDEN_NAMES=[...e],c}export{createWorld};
//# sourceMappingURL=index.min.js.map
