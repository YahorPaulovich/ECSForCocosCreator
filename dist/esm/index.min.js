/*! *****************************************************************************
 *
 * miski
 * v0.4.0
 *
 * MIT License
 * 
 * Copyright (C) 2021 Peter Hughes<https://www.phugh.es>, all rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
***************************************************************************** */
function ownKeys$2(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys$2(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys$2(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,fails$7=function(e){try{return!!e()}catch(e){return!0}},r=!fails$7((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),check=function(e){return e&&e.Math==Math&&e},n=check("object"==typeof globalThis&&globalThis)||check("object"==typeof window&&window)||check("object"==typeof self&&self)||check("object"==typeof e&&e)||function(){return this}()||Function("return this")(),isObject$7=function(e){return"object"==typeof e?null!==e:"function"==typeof e},requireObjectCoercible$2=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},o=requireObjectCoercible$2,toObject$2=function(e){return Object(o(e))},i=toObject$2,a={}.hasOwnProperty,c=Object.hasOwn||function hasOwn(e,t){return a.call(i(e),t)},u={exports:{}},s={},f=isObject$7,p=n.document,l=f(p)&&f(p.createElement),createElement=function(e){return l?p.createElement(e):{}},y=!r&&!fails$7((function(){return 7!=Object.defineProperty(createElement("div"),"a",{get:function(){return 7}}).a})),d=isObject$7,anObject$z=function(e){if(!d(e))throw TypeError(String(e)+" is not an object");return e},m=isObject$7,toPrimitive$2=function(e,t){if(!m(e))return e;var r,n;if(t&&"function"==typeof(r=e.toString)&&!m(n=r.call(e)))return n;if("function"==typeof(r=e.valueOf)&&!m(n=r.call(e)))return n;if(!t&&"function"==typeof(r=e.toString)&&!m(n=r.call(e)))return n;throw TypeError("Can't convert object to primitive value")},g=r,h=y,b=anObject$z,E=toPrimitive$2,v=Object.defineProperty;s.f=g?v:function defineProperty(e,t,r){if(b(e),t=E(t,!0),b(r),h)try{return v(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(e[t]=r.value),e};var createPropertyDescriptor$2=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},w=s,S=createPropertyDescriptor$2,T=r?function(e,t,r){return w.f(e,t,S(1,r))}:function(e,t,r){return e[t]=r,e},A=n,O=T,setGlobal$3=function(e,t){try{O(A,e,t)}catch(r){A[e]=t}return t},_=setGlobal$3,j=n["__core-js_shared__"]||_("__core-js_shared__",{}),I=j;(u.exports=function(e,t){return I[e]||(I[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.15.2",mode:"global",copyright:"Â© 2021 Denis Pushkarev (zloirock.ru)"});var R,C,P=0,M=Math.random(),uid$3=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++P+M).toString(36)},B=n,x=n,aFunction$m=function(e){return"function"==typeof e?e:void 0},getBuiltIn$c=function(e,t){return arguments.length<2?aFunction$m(B[e])||aFunction$m(x[e]):B[e]&&B[e][t]||x[e]&&x[e][t]},N=getBuiltIn$c("navigator","userAgent")||"",U=N,k=n.process,D=k&&k.versions,Q=D&&D.v8;Q?C=(R=Q.split("."))[0]<4?1:R[0]+R[1]:U&&(!(R=U.match(/Edge\/(\d+)/))||R[1]>=74)&&(R=U.match(/Chrome\/(\d+)/))&&(C=R[1]);var $=C&&+C,V=$,q=fails$7,z=!!Object.getOwnPropertySymbols&&!q((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&V&&V<41})),K=z&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,L=n,Y=u.exports,W=c,G=uid$3,H=z,J=K,Z=Y("wks"),X=L.Symbol,ee=J?X:X&&X.withoutSetter||G,wellKnownSymbol$6=function(e){return W(Z,e)&&(H||"string"==typeof Z[e])||(H&&W(X,e)?Z[e]=X[e]:Z[e]=ee("Symbol."+e)),Z[e]},te={};te[wellKnownSymbol$6("toStringTag")]="z";var re="[object z]"===String(te),ne={}.toString,classofRaw$1=function(e){return ne.call(e).slice(8,-1)},oe=re,ie=classofRaw$1,ae=wellKnownSymbol$6("toStringTag"),ce="Arguments"==ie(function(){return arguments}()),ue=oe?ie:function(e){var t,r,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),ae))?r:ce?ie(t):"Object"==(n=ie(t))&&"function"==typeof t.callee?"Arguments":n},se={exports:{}},fe=j,pe=Function.toString;"function"!=typeof fe.inspectSource&&(fe.inspectSource=function(e){return pe.call(e)});var le,ye,de,me=fe.inspectSource,ge=me,he=n.WeakMap,be="function"==typeof he&&/native code/.test(ge(he)),Ee=u.exports,ve=uid$3,we=Ee("keys"),sharedKey$2=function(e){return we[e]||(we[e]=ve(e))},Se={},Te=be,Ae=isObject$7,Oe=T,_e=c,je=j,Ie=sharedKey$2,Re=Se,Ce=n.WeakMap;if(Te||je.state){var Pe=je.state||(je.state=new Ce),Me=Pe.get,Be=Pe.has,xe=Pe.set;le=function(e,t){if(Be.call(Pe,e))throw new TypeError("Object already initialized");return t.facade=e,xe.call(Pe,e,t),t},ye=function(e){return Me.call(Pe,e)||{}},de=function(e){return Be.call(Pe,e)}}else{var Ne=Ie("state");Re[Ne]=!0,le=function(e,t){if(_e(e,Ne))throw new TypeError("Object already initialized");return t.facade=e,Oe(e,Ne,t),t},ye=function(e){return _e(e,Ne)?e[Ne]:{}},de=function(e){return _e(e,Ne)}}var Ue={set:le,get:ye,has:de,enforce:function(e){return de(e)?ye(e):le(e,{})},getterFor:function(e){return function(t){var r;if(!Ae(t)||(r=ye(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return r}}},ke=n,Fe=T,De=c,Qe=setGlobal$3,$e=me,Ve=Ue.get,qe=Ue.enforce,ze=String(String).split("String");(se.exports=function(e,t,r,n){var o,i=!!n&&!!n.unsafe,a=!!n&&!!n.enumerable,c=!!n&&!!n.noTargetGet;"function"==typeof r&&("string"!=typeof t||De(r,"name")||Fe(r,"name",t),(o=qe(r)).source||(o.source=ze.join("string"==typeof t?t:""))),e!==ke?(i?!c&&e[t]&&(a=!0):delete e[t],a?e[t]=r:Fe(e,t,r)):a?e[t]=r:Qe(t,r)})(Function.prototype,"toString",(function toString(){return"function"==typeof this&&Ve(this).source||$e(this)}));var Ke,Le=!fails$7((function(){function F(){}return F.prototype.constructor=null,Object.getPrototypeOf(new F)!==F.prototype})),Ye=c,We=toObject$2,Ge=Le,He=sharedKey$2("IE_PROTO"),Je=Object.prototype,Ze=Ge?Object.getPrototypeOf:function(e){return e=We(e),Ye(e,He)?e[He]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?Je:null},Xe=isObject$7,et=anObject$z,aPossiblePrototype=function(e){if(!Xe(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype");return e},tt=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(r,[]),t=r instanceof Array}catch(e){}return function setPrototypeOf(r,n){return et(r),aPossiblePrototype(n),t?e.call(r,n):r.__proto__=n,r}}():void 0),rt=t,nt=r,ot=n,it=isObject$7,at=c,ct=ue,ut=T,st=se.exports,ft=s.f,pt=Ze,lt=tt,yt=wellKnownSymbol$6,dt=uid$3,mt=ot.Int8Array,gt=mt&&mt.prototype,ht=ot.Uint8ClampedArray,bt=ht&&ht.prototype,Et=mt&&pt(mt),vt=gt&&pt(gt),wt=Object.prototype,St=wt.isPrototypeOf,Tt=yt("toStringTag"),At=dt("TYPED_ARRAY_TAG"),Ot=rt&&!!lt&&"Opera"!==ct(ot.opera),_t=!1,jt={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},It={BigInt64Array:8,BigUint64Array:8},isTypedArray$1=function(e){if(!it(e))return!1;var t=ct(e);return at(jt,t)||at(It,t)};for(Ke in jt)ot[Ke]||(Ot=!1);if((!Ot||"function"!=typeof Et||Et===Function.prototype)&&(Et=function TypedArray(){throw TypeError("Incorrect invocation")},Ot))for(Ke in jt)ot[Ke]&&lt(ot[Ke],Et);if((!Ot||!vt||vt===wt)&&(vt=Et.prototype,Ot))for(Ke in jt)ot[Ke]&&lt(ot[Ke].prototype,vt);if(Ot&&pt(bt)!==vt&&lt(bt,vt),nt&&!at(vt,Tt))for(Ke in _t=!0,ft(vt,Tt,{get:function(){return it(this)?this[At]:void 0}}),jt)ot[Ke]&&ut(ot[Ke],At,Ke);var Rt={NATIVE_ARRAY_BUFFER_VIEWS:Ot,TYPED_ARRAY_TAG:_t&&At,aTypedArray:function(e){if(isTypedArray$1(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(lt){if(St.call(Et,e))return e}else for(var t in jt)if(at(jt,Ke)){var r=ot[t];if(r&&(e===r||St.call(r,e)))return e}throw TypeError("Target is not a typed array constructor")},exportTypedArrayMethod:function(e,t,r){if(nt){if(r)for(var n in jt){var o=ot[n];if(o&&at(o.prototype,e))try{delete o.prototype[e]}catch(e){}}vt[e]&&!r||st(vt,e,r?t:Ot&&gt[e]||t)}},exportTypedArrayStaticMethod:function(e,t,r){var n,o;if(nt){if(lt){if(r)for(n in jt)if((o=ot[n])&&at(o,e))try{delete o[e]}catch(e){}if(Et[e]&&!r)return;try{return st(Et,e,r?t:Ot&&Et[e]||t)}catch(e){}}for(n in jt)!(o=ot[n])||o[e]&&!r||st(o,e,t)}},isView:function isView(e){if(!it(e))return!1;var t=ct(e);return"DataView"===t||at(jt,t)||at(It,t)},isTypedArray:isTypedArray$1,TypedArray:Et,TypedArrayPrototype:vt},aFunction$l=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},Ct=Math.ceil,Pt=Math.floor,toInteger$2=function(e){return isNaN(e=+e)?0:(e>0?Pt:Ct)(e)},Mt=toInteger$2,Bt=Math.min,toLength$3=function(e){return e>0?Bt(Mt(e),9007199254740991):0},xt=Math.floor,mergeSort=function(e,t){var r=e.length,n=xt(r/2);return r<8?insertionSort(e,t):merge(mergeSort(e.slice(0,n),t),mergeSort(e.slice(n),t),t)},insertionSort=function(e,t){for(var r,n,o=e.length,i=1;i<o;){for(n=i,r=e[i];n&&t(e[n-1],r)>0;)e[n]=e[--n];n!==i++&&(e[n]=r)}return e},merge=function(e,t,r){for(var n=e.length,o=t.length,i=0,a=0,c=[];i<n||a<o;)i<n&&a<o?c.push(r(e[i],t[a])<=0?e[i++]:t[a++]):c.push(i<n?e[i++]:t[a++]);return c},Nt=mergeSort,Ut=N.match(/firefox\/(\d+)/i),kt=!!Ut&&+Ut[1],Ft=/MSIE|Trident/.test(N),Dt=N.match(/AppleWebKit\/(\d+)\./),Qt=!!Dt&&+Dt[1],$t=fails$7,Vt=aFunction$l,qt=toLength$3,zt=Nt,Kt=kt,Lt=Ft,Yt=$,Wt=Qt,Gt=Rt.aTypedArray,Ht=Rt.exportTypedArrayMethod,Jt=n.Uint16Array,Zt=Jt&&Jt.prototype.sort,Xt=!!Zt&&!$t((function(){var e=new Jt(2);e.sort(null),e.sort({})})),er=!!Zt&&!$t((function(){if(Yt)return Yt<74;if(Kt)return Kt<67;if(Lt)return!0;if(Wt)return Wt<602;var e,t,r=new Jt(516),n=Array(516);for(e=0;e<516;e++)t=e%4,r[e]=515-e,n[e]=e-2*t+3;for(r.sort((function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(r[e]!==n[e])return!0}));
/**
 * @name        Bitmask
 * @description Utilities for handling and manipulating bitmask arrays
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function setBitOn(e,t){const r=8*e.BYTES_PER_ELEMENT;return e[Math.floor(t/r)]|=1<<t%r,e}function setBitOff(e,t){const r=8*e.BYTES_PER_ELEMENT;return e[Math.floor(t/r)]&=~(1<<t%r),e}function isBitOn(e,t){const r=8*e.BYTES_PER_ELEMENT;return Boolean(e[Math.floor(t/r)]&1<<t%r)}function getFirstFree(e){const t=function getMaxBit(e){return e.BYTES_PER_ELEMENT*e.length*8}(e);for(let r=0;r<t;r++)if(!isBitOn(e,r))return r}function createBitmask(e=32){return new Uint32Array(e/32)}
/**
 * @description Utilities for handling and manipulating objects
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */function isObject(e){return Boolean(null!=e&&"object"==typeof e&&!Array.isArray(e))}function deepAssignObjects(e,...t){if(!t||!t.length)return e;const r=t.shift(),n=Object.getOwnPropertyDescriptors(r);return Object.entries(n).forEach((([t,r])=>{void 0!==r.value&&(isObject(r.value)?r.value=deepAssignObjects({},r.value):Array.isArray(r.value)&&(r.value=r.value.slice())),Object.defineProperty(e,t,r)})),deepAssignObjects(e,...t)}
/**
 * @description Utilities for handling and manipulating strings
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */Ht("sort",(function sort(e){var t=this;if(void 0!==e&&Vt(e),er)return Zt.call(t,e);Gt(t);var r,n=qt(t.length),o=Array(n);for(r=0;r<n;r++)o[r]=t[r];for(o=zt(t,function(e){return function(t,r){return void 0!==e?+e(t,r)||0:r!=r?-1:t!=t?1:0===t&&0===r?1/t>0&&1/r<0?1:-1:t>r}}(e)),r=0;r<n;r++)t[r]=o[r];return t}),!er||Xt);const tr=["defaults","id","name","entities","schema","world","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"];function isValidName(e){if("string"!=typeof e)throw new TypeError(`Expected name to be of type "string", found ${typeof e}.`);return(e=e.trim()).length>0&&/^(?![0-9])[a-zA-Z0-9$_]+$/.test(e)&&!tr.includes(e)}var rr={},nr={},or={}.propertyIsEnumerable,ir=Object.getOwnPropertyDescriptor,ar=ir&&!or.call({1:2},1);nr.f=ar?function propertyIsEnumerable(e){var t=ir(this,e);return!!t&&t.enumerable}:or;var cr=classofRaw$1,ur="".split,sr=fails$7((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==cr(e)?ur.call(e,""):Object(e)}:Object,fr=requireObjectCoercible$2,toIndexedObject$3=function(e){return sr(fr(e))},pr=r,lr=nr,yr=createPropertyDescriptor$2,dr=toIndexedObject$3,mr=toPrimitive$2,gr=c,hr=y,br=Object.getOwnPropertyDescriptor;rr.f=pr?br:function getOwnPropertyDescriptor(e,t){if(e=dr(e),t=mr(t,!0),hr)try{return br(e,t)}catch(e){}if(gr(e,t))return yr(!lr.f.call(e,t),e[t])};var Er={},vr=toInteger$2,wr=Math.max,Sr=Math.min,Tr=toIndexedObject$3,Ar=toLength$3,toAbsoluteIndex=function(e,t){var r=vr(e);return r<0?wr(r+t,0):Sr(r,t)},createMethod=function(e){return function(t,r,n){var o,i=Tr(t),a=Ar(i.length),c=toAbsoluteIndex(n,a);if(e&&r!=r){for(;a>c;)if((o=i[c++])!=o)return!0}else for(;a>c;c++)if((e||c in i)&&i[c]===r)return e||c||0;return!e&&-1}},Or={includes:createMethod(!0),indexOf:createMethod(!1)},_r=c,jr=toIndexedObject$3,Ir=Or.indexOf,Rr=Se,internalObjectKeys=function(e,t){var r,n=jr(e),o=0,i=[];for(r in n)!_r(Rr,r)&&_r(n,r)&&i.push(r);for(;t.length>o;)_r(n,r=t[o++])&&(~Ir(i,r)||i.push(r));return i},Cr=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"].concat("length","prototype");Er.f=Object.getOwnPropertyNames||function getOwnPropertyNames(e){return internalObjectKeys(e,Cr)};var Pr={};Pr.f=Object.getOwnPropertySymbols;var Mr=Er,Br=Pr,xr=anObject$z,Nr=getBuiltIn$c("Reflect","ownKeys")||function ownKeys(e){var t=Mr.f(xr(e)),r=Br.f;return r?t.concat(r(e)):t},Ur=c,kr=Nr,Fr=rr,Dr=s,Qr=fails$7,$r=/#|\.prototype\./,isForced$1=function(e,t){var r=qr[Vr(e)];return r==Kr||r!=zr&&("function"==typeof t?Qr(t):!!t)},Vr=isForced$1.normalize=function(e){return String(e).replace($r,".").toLowerCase()},qr=isForced$1.data={},zr=isForced$1.NATIVE="N",Kr=isForced$1.POLYFILL="P",Lr=isForced$1,Yr=n,Wr=rr.f,Gr=T,Hr=se.exports,Jr=setGlobal$3,copyConstructorProperties=function(e,t){for(var r=kr(t),n=Dr.f,o=Fr.f,i=0;i<r.length;i++){var a=r[i];Ur(e,a)||n(e,a,o(t,a))}},Zr=Lr,_export=function(e,t){var r,n,o,i,a,c=e.target,u=e.global,s=e.stat;if(r=u?Yr:s?Yr[c]||Jr(c,{}):(Yr[c]||{}).prototype)for(n in t){if(i=t[n],o=e.noTargetGet?(a=Wr(r,n))&&a.value:r[n],!Zr(u?n:c+(s?".":"#")+n,e.forced)&&void 0!==o){if(typeof i==typeof o)continue;copyConstructorProperties(i,o)}(e.sham||o&&o.sham)&&Gr(i,"sham",!0),Hr(r,n,i,e)}},Xr=anObject$z,en=aFunction$l,collectionDeleteAll$2=function(){for(var e,t=Xr(this),r=en(t.delete),n=!0,o=0,i=arguments.length;o<i;o++)e=r.call(t,arguments[o]),n=n&&e;return!!n},tn=collectionDeleteAll$2;_export({target:"Map",proto:!0,real:!0,forced:false},{deleteAll:function deleteAll(){return tn.apply(this,arguments)}});var rn=aFunction$l,functionBindContext=function(e,t,r){if(rn(e),void 0===t)return e;switch(r){case 0:return function(){return e.call(t)};case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,o){return e.call(t,r,n,o)}}return function(){return e.apply(t,arguments)}},nn={},on=ue,an=nn,cn=wellKnownSymbol$6("iterator"),getIteratorMethod$2=function(e){if(null!=e)return e[cn]||e["@@iterator"]||an[on(e)]},un=anObject$z,sn=getIteratorMethod$2,getMapIterator$a=function(e){return Map.prototype.entries.call(e)},fn=nn,pn=wellKnownSymbol$6("iterator"),ln=Array.prototype,yn=anObject$z,dn=anObject$z,isArrayIteratorMethod=function(e){return void 0!==e&&(fn.Array===e||ln[pn]===e)},mn=toLength$3,gn=functionBindContext,hn=getIteratorMethod$2,iteratorClose=function(e){var t=e.return;if(void 0!==t)return yn(t.call(e)).value},Result=function(e,t){this.stopped=e,this.result=t},iterate$p=function(e,t,r){var n,o,i,a,c,u,s,f=r&&r.that,p=!(!r||!r.AS_ENTRIES),l=!(!r||!r.IS_ITERATOR),y=!(!r||!r.INTERRUPTED),d=gn(t,f,1+p+y),stop=function(e){return n&&iteratorClose(n),new Result(!0,e)},callFn=function(e){return p?(dn(e),y?d(e[0],e[1],stop):d(e[0],e[1])):y?d(e,stop):d(e)};if(l)n=e;else{if("function"!=typeof(o=hn(e)))throw TypeError("Target is not iterable");if(isArrayIteratorMethod(o)){for(i=0,a=mn(e.length);a>i;i++)if((c=callFn(e[i]))&&c instanceof Result)return c;return new Result(!1)}n=o.call(e)}for(u=n.next;!(s=u.call(n)).done;){try{c=callFn(s.value)}catch(e){throw iteratorClose(n),e}if("object"==typeof c&&c&&c instanceof Result)return c}return new Result(!1)},bn=anObject$z,En=functionBindContext,vn=getMapIterator$a,wn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{every:function every(e){var t=bn(this),r=vn(t),n=En(e,arguments.length>1?arguments[1]:void 0,3);return!wn(r,(function(e,r,o){if(!n(r,e,t))return o()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Sn=anObject$z,Tn=aFunction$l,An=wellKnownSymbol$6("species"),speciesConstructor$9=function(e,t){var r,n=Sn(e).constructor;return void 0===n||null==(r=Sn(n)[An])?t:Tn(r)},On=getBuiltIn$c,_n=anObject$z,jn=aFunction$l,In=functionBindContext,Rn=speciesConstructor$9,Cn=getMapIterator$a,Pn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{filter:function filter(e){var t=_n(this),r=Cn(t),n=In(e,arguments.length>1?arguments[1]:void 0,3),o=new(Rn(t,On("Map"))),i=jn(o.set);return Pn(r,(function(e,r){n(r,e,t)&&i.call(o,e,r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),o}});var Mn=anObject$z,Bn=functionBindContext,xn=getMapIterator$a,Nn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{find:function find(e){var t=Mn(this),r=xn(t),n=Bn(e,arguments.length>1?arguments[1]:void 0,3);return Nn(r,(function(e,r,o){if(n(r,e,t))return o(r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Un=anObject$z,kn=functionBindContext,Fn=getMapIterator$a,Dn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{findKey:function findKey(e){var t=Un(this),r=Fn(t),n=kn(e,arguments.length>1?arguments[1]:void 0,3);return Dn(r,(function(e,r,o){if(n(r,e,t))return o(e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Qn=anObject$z,$n=getMapIterator$a,sameValueZero=function(e,t){return e===t||e!=e&&t!=t},Vn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{includes:function includes(e){return Vn($n(Qn(this)),(function(t,r,n){if(sameValueZero(r,e))return n()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var qn=anObject$z,zn=getMapIterator$a,Kn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{keyOf:function keyOf(e){return Kn(zn(qn(this)),(function(t,r,n){if(r===e)return n(t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Ln=getBuiltIn$c,Yn=anObject$z,Wn=aFunction$l,Gn=functionBindContext,Hn=speciesConstructor$9,Jn=getMapIterator$a,Zn=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{mapKeys:function mapKeys(e){var t=Yn(this),r=Jn(t),n=Gn(e,arguments.length>1?arguments[1]:void 0,3),o=new(Hn(t,Ln("Map"))),i=Wn(o.set);return Zn(r,(function(e,r){i.call(o,n(r,e,t),r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),o}});var Xn=getBuiltIn$c,eo=anObject$z,to=aFunction$l,ro=functionBindContext,no=speciesConstructor$9,oo=getMapIterator$a,io=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{mapValues:function mapValues(e){var t=eo(this),r=oo(t),n=ro(e,arguments.length>1?arguments[1]:void 0,3),o=new(no(t,Xn("Map"))),i=to(o.set);return io(r,(function(e,r){i.call(o,e,n(r,e,t))}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),o}});var ao=anObject$z,co=aFunction$l,uo=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{merge:function merge(e){for(var t=ao(this),r=co(t.set),n=0;n<arguments.length;)uo(arguments[n++],r,{that:t,AS_ENTRIES:!0});return t}});var so=anObject$z,fo=aFunction$l,po=getMapIterator$a,lo=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{reduce:function reduce(e){var t=so(this),r=po(t),n=arguments.length<2,o=n?void 0:arguments[1];if(fo(e),lo(r,(function(r,i){n?(n=!1,o=i):o=e(o,i,r,t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),n)throw TypeError("Reduce of empty map with no initial value");return o}});var yo=anObject$z,mo=functionBindContext,go=getMapIterator$a,ho=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{some:function some(e){var t=yo(this),r=go(t),n=mo(e,arguments.length>1?arguments[1]:void 0,3);return ho(r,(function(e,r,o){if(n(r,e,t))return o()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var bo=anObject$z,Eo=aFunction$l;_export({target:"Map",proto:!0,real:!0,forced:false},{update:function update(e,t){var r=bo(this),n=arguments.length;Eo(t);var o=r.has(e);if(!o&&n<3)throw TypeError("Updating absent value");var i=o?r.get(e):Eo(n>2?arguments[2]:void 0)(e,r);return r.set(e,t(i,e,r)),r}});var vo=anObject$z,wo=aFunction$l,collectionAddAll=function(){for(var e=vo(this),t=wo(e.add),r=0,n=arguments.length;r<n;r++)t.call(e,arguments[r]);return e};_export({target:"Set",proto:!0,real:!0,forced:false},{addAll:function addAll(){return collectionAddAll.apply(this,arguments)}});var So=collectionDeleteAll$2;_export({target:"Set",proto:!0,real:!0,forced:false},{deleteAll:function deleteAll(){return So.apply(this,arguments)}});var To=getBuiltIn$c,Ao=anObject$z,Oo=aFunction$l,_o=speciesConstructor$9,jo=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{difference:function difference(e){var t=Ao(this),r=new(_o(t,To("Set")))(t),n=Oo(r.delete);return jo(e,(function(e){n.call(r,e)})),r}});var getSetIterator$7=function(e){return Set.prototype.values.call(e)},Io=anObject$z,Ro=functionBindContext,Co=getSetIterator$7,Po=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{every:function every(e){var t=Io(this),r=Co(t),n=Ro(e,arguments.length>1?arguments[1]:void 0,3);return!Po(r,(function(e,r){if(!n(e,e,t))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Mo=getBuiltIn$c,Bo=anObject$z,xo=aFunction$l,No=functionBindContext,Uo=speciesConstructor$9,ko=getSetIterator$7,Fo=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{filter:function filter(e){var t=Bo(this),r=ko(t),n=No(e,arguments.length>1?arguments[1]:void 0,3),o=new(Uo(t,Mo("Set"))),i=xo(o.add);return Fo(r,(function(e){n(e,e,t)&&i.call(o,e)}),{IS_ITERATOR:!0}),o}});var Do=anObject$z,Qo=functionBindContext,$o=getSetIterator$7,Vo=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{find:function find(e){var t=Do(this),r=$o(t),n=Qo(e,arguments.length>1?arguments[1]:void 0,3);return Vo(r,(function(e,r){if(n(e,e,t))return r(e)}),{IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var qo=getBuiltIn$c,zo=anObject$z,Ko=aFunction$l,Lo=speciesConstructor$9,Yo=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{intersection:function intersection(e){var t=zo(this),r=new(Lo(t,qo("Set"))),n=Ko(t.has),o=Ko(r.add);return Yo(e,(function(e){n.call(t,e)&&o.call(r,e)})),r}});var Wo=anObject$z,Go=aFunction$l,Ho=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{isDisjointFrom:function isDisjointFrom(e){var t=Wo(this),r=Go(t.has);return!Ho(e,(function(e,n){if(!0===r.call(t,e))return n()}),{INTERRUPTED:!0}).stopped}});var Jo=getBuiltIn$c,Zo=anObject$z,Xo=aFunction$l,getIterator=function(e){var t=sn(e);if("function"!=typeof t)throw TypeError(String(e)+" is not iterable");return un(t.call(e))},ei=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{isSubsetOf:function isSubsetOf(e){var t=getIterator(this),r=Zo(e),n=r.has;return"function"!=typeof n&&(r=new(Jo("Set"))(e),n=Xo(r.has)),!ei(t,(function(e,t){if(!1===n.call(r,e))return t()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var ti=anObject$z,ri=aFunction$l,ni=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{isSupersetOf:function isSupersetOf(e){var t=ti(this),r=ri(t.has);return!ni(e,(function(e,n){if(!1===r.call(t,e))return n()}),{INTERRUPTED:!0}).stopped}});var oi=anObject$z,ii=getSetIterator$7,ai=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{join:function join(e){var t=oi(this),r=ii(t),n=void 0===e?",":String(e),o=[];return ai(r,o.push,{that:o,IS_ITERATOR:!0}),o.join(n)}});var ci=getBuiltIn$c,ui=anObject$z,si=aFunction$l,fi=functionBindContext,pi=speciesConstructor$9,li=getSetIterator$7,yi=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{map:function map(e){var t=ui(this),r=li(t),n=fi(e,arguments.length>1?arguments[1]:void 0,3),o=new(pi(t,ci("Set"))),i=si(o.add);return yi(r,(function(e){i.call(o,n(e,e,t))}),{IS_ITERATOR:!0}),o}});var di=anObject$z,mi=aFunction$l,gi=getSetIterator$7,hi=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{reduce:function reduce(e){var t=di(this),r=gi(t),n=arguments.length<2,o=n?void 0:arguments[1];if(mi(e),hi(r,(function(r){n?(n=!1,o=r):o=e(o,r,r,t)}),{IS_ITERATOR:!0}),n)throw TypeError("Reduce of empty set with no initial value");return o}});var bi=anObject$z,Ei=functionBindContext,vi=getSetIterator$7,wi=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{some:function some(e){var t=bi(this),r=vi(t),n=Ei(e,arguments.length>1?arguments[1]:void 0,3);return wi(r,(function(e,r){if(n(e,e,t))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Si=getBuiltIn$c,Ti=anObject$z,Ai=aFunction$l,Oi=speciesConstructor$9,_i=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{symmetricDifference:function symmetricDifference(e){var t=Ti(this),r=new(Oi(t,Si("Set")))(t),n=Ai(r.delete),o=Ai(r.add);return _i(e,(function(e){n.call(r,e)||o.call(r,e)})),r}});var ji=getBuiltIn$c,Ii=anObject$z,Ri=aFunction$l,Ci=speciesConstructor$9,Pi=iterate$p;
/**
 * @description Utilities for handling and manipulating schema types
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 *
 * Heavily inspired by ECSY
 */
function isTypedArray(e){return Boolean(e&&ArrayBuffer.isView(e)&&!(e instanceof DataView))}function copyValue(e,t){return e}function cloneValue(e){return e}function copyObject(e,t){if(!1===isObject(e))throw new TypeError(`copyObject: Invalid source object, found ${typeof e}.`);if(!1===isObject(t))throw new TypeError(`copyObject: Invalid destination object, found ${typeof t}.`);return deepAssignObjects(t,e),t}function copyTypedArray(e,t,r=0){if(!1===isTypedArray(e))throw new TypeError("copyTypedArray: Expected source to be a typed array.");if(!1===isTypedArray(t))throw new TypeError("copyTypedArray: Expected destination to be a typed array.");if(isNaN(r)||r<0)throw new TypeError("copyTypedArray: Offset must be a positive integer of type Number.");return t.set(e,r),t}function cloneTypedArray(e){if(!1===isTypedArray(e))throw new TypeError("cloneTypedArray: Expected source to be a typed array.");return e.slice()}
/**
 * @name        Schema
 * @description Schemas determine the acceptable shape of component properties
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 * @example
 *              import { Schema, Types } from './schema';
 *
 *              // first, define the shape of the schema:
 *
 *              interface Point {
 *                x: Int32Array,
 *                y: Int32Array,
 *              }
 *
 *              // then, define the schema object:
 *
 *              const Vec2: Schema<Point> = {
 *                // properties can be a SchemaProperty object from the `Types` object:
 *                x: Types.i32,
 *
 *                // or properties can p
 *                x: {
 *                  type: Types.i32,  // get the type from the Types object to avoid undefined behavior
 *                  init: 0,       // define a default property to initialize entities with,
 *                                    // if no default is provided, the default from the type is used
 *                },
 *              }
 *
 *              // the schema can then be used in component creation:
 *
 *              const position = createComponent({
 *                name: "position",
 *                schema: Vec2,
 *              });
 *
 *              const velocity = createComponent({
 *                name: "velocity",
 *                schema: Vec2,
 *              });
 */_export({target:"Set",proto:!0,real:!0,forced:false},{union:function union(e){var t=Ii(this),r=new(Ci(t,ji("Set")))(t);return Pi(e,Ri(r.add),{that:r}),r}});const Mi={Array:{copy:function copyArray(e,t){if(!Array.isArray(e))throw new TypeError(`copyArray: Source must be an array, found ${typeof e}.`);if(!Array.isArray(t))throw new TypeError(`copyArray: Destination must be an array, found ${typeof t}.`);return t.length=0,e.forEach((e=>t.push(e))),t},clone:function cloneArray(e){if(!Array.isArray(e))throw new TypeError(`cloneArray: Source must be an array, found ${typeof e}.`);return[...e]},init:[],create:function(e){return new Array(e)}},Boolean:{copy:copyValue,clone:cloneValue,init:!1,create:function(e){return Boolean(e)}},JSON:{copy:copyValue,clone:cloneValue,init:null,create:function(e,t){return JSON.parse(e,t)}},Map:{copy:function copyMap(e,t){if(!(e instanceof Map))throw new TypeError("copyMap: Expected source to be a Map object.");if(!(t instanceof Map))throw new TypeError("copyMap: Expected destination to be a Map object.");return t.clear(),e.forEach(((e,r)=>t.set(r,e))),t},clone:function cloneMap(e){if(!(e instanceof Map))throw new TypeError("cloneMap: Expected source to be a Map object.");return new Map(e.entries())},init:new Map,create:function(e){return new Map(e)}},Number:{copy:copyValue,clone:cloneValue,init:0,create:function(e){return Number(e||this.init)}},Object:{copy:copyObject,clone:function cloneObject(e){return copyObject(e,{})},init:{},create:function(e=Object.prototype,t){return Object.create(e,t??{})}},Ref:{copy:copyValue,clone:cloneValue,init:void 0,create:function(e){return e}},Set:{copy:function copySet(e,t){if(!(e instanceof Set))throw new TypeError("copySet: Expected source to be a Set object.");if(!(t instanceof Set))throw new TypeError("copySet: Expected destination to be a Set object.");return t.clear(),e.forEach((e=>t.add(e))),t},clone:function cloneSet(e){if(!(e instanceof Set))throw new TypeError("cloneSet: Expected source to be a Set object.");return new Set(e)},init:new Set,create:function(e){return new Set(e)}},String:{copy:copyValue,clone:cloneValue,init:"",create:function(e){return String(e)}},i8:{copy:copyTypedArray,clone:cloneTypedArray,init:new Int8Array,create:function(e,t,r){return new Int8Array(e,t,r)}},u8:{copy:copyTypedArray,clone:cloneTypedArray,init:new Uint8Array,create:function(e,t,r){return new Uint8Array(e,t,r)}},u8c:{copy:copyTypedArray,clone:cloneTypedArray,init:new Uint8ClampedArray,create:function(e,t,r){return new Uint8ClampedArray(e,t,r)}},i16:{copy:copyTypedArray,clone:cloneTypedArray,init:new Int16Array,create:function(e,t,r){return new Int16Array(e,t,r)}},u16:{copy:copyTypedArray,clone:cloneTypedArray,init:new Uint16Array,create:function(e,t,r){return new Uint16Array(e,t,r)}},i32:{copy:copyTypedArray,clone:cloneTypedArray,init:new Int32Array,create:function(e,t,r){return new Int32Array(e,t,r)}},u32:{copy:copyTypedArray,clone:cloneTypedArray,init:new Uint32Array,create:function(e,t,r){return new Uint32Array(e,t,r)}},f32:{copy:copyTypedArray,clone:cloneTypedArray,init:new Float32Array,create:function(e,t,r){return new Float32Array(e,t,r)}},f64:{copy:copyTypedArray,clone:cloneTypedArray,init:new Float64Array,create:function(e,t,r){return new Float64Array(e,t,r)}},i64:{copy:copyTypedArray,clone:cloneTypedArray,init:new BigInt64Array,create:function(e,t,r){return new BigInt64Array(e,t,r)}},u64:{copy:copyTypedArray,clone:cloneTypedArray,init:new BigUint64Array,create:function(e,t,r){return new BigUint64Array(e,t,r)}}},Bi=Symbol(),xi=Symbol(),Ni=Object.create(Object.prototype,{[Bi]:{value:!0,enumerable:!0,configurable:!1,writable:!1}}),Ui={[xi]:{value:!0,enumerable:!0,configurable:!1,writable:!1}};function isComponent(e){return isObject(e)&&Object.is(Ni,Object.getPrototypeOf(e))}function isComponentInstance(e){return isObject(e)&&!0===e[xi]}function createComponent(e){const{name:t,schema:r}=e;if(!isValidName(t))throw new SyntaxError("createComponent: supplied name is invalid.");if(!function isValidSchema(e){return Boolean(isObject(e)&&Object.keys(e).length>0)}(r))throw new TypeError(`createComponent: Schema for "${t}" is invalid.`);return Object.create(Ni,{name:{value:t,enumerable:!0,configurable:!1,writable:!1},schema:{value:_objectSpread2({},r),enumerable:!0,configurable:!1,writable:!1}})}
/**
 * @name        Archetype
 * @description Archetypes are unique groups of components
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */const ki=Symbol(),Fi={add:function(e){return this.has(e)||(this.entities.add(e),this[ki]=!0),this},has:function(e){return this.entities.has(e)},remove:function(e){return this.has(e)?(this.entities.delete(e),this[ki]=!0,this):this},reset:function(){return this.entities.clear(),this[ki]=!0,this}};function createArchetype(e){return Object.create(Fi,{[ki]:{value:!0,configurable:!1,enumerable:!0,writable:!0},entities:{value:new Set,configurable:!1,enumerable:!0,writable:!1},mask:{value:e,configurable:!1,enumerable:!0,writable:!1},name:{value:e.toString(),configurable:!1,enumerable:!0,writable:!1}})}
/**
 * @name        ArchetypeManager
 * @description The archetype manager creates, destroys & assigns archetypes
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */function _resetEntityArchetype(e,t,r){return function resetEntityArchetype(n){const o=t[n];return void 0!==o&&(o.remove(n),0===o.entities.size&&delete e[o.name]),r.add(n),t[n]=r,r}}function _updateEntityArchetype(e,t,r){return function updateEntityArchetype(n,o){const i=t[n];if(void 0!==i&&(i.remove(n),0===i.entities.size&&(r.getQueries().forEach((e=>e.remove(i))),delete e[i.name])),void 0===o?.id)throw new TypeError("updateEntityArchetype: Expected component to be an instance!");const a=t[n]?.mask??createBitmask(r.config.maxComponents);!function toggleBit(e,t){return isBitOn(e,t)?setBitOff(e,t):setBitOn(e,t)}(a,o.id);const c=a.toString();let u;return c in e?u=e[c]:(u=createArchetype(a),r.getQueries().forEach((e=>e.isMatch(u))),e[c]=u),u.add(n),t[n]=u,u}}
/**
 * @name        ComponentManager
 * @description The component manager brokers the relationship between components and entities.
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function componentsToMask(e,...t){if(!e)throw new SyntaxError("componentsToMask: a world object is required.");const r=createBitmask(e.config.maxComponents);return t&&t.length?(t.forEach((t=>{if(t.world.id!==e.id)throw new SyntaxError("componentsToMask: all components must be from the same world.");setBitOn(r,t.id)})),r):r}function _registerComponent(e,t,r){return function registerComponent(n){if(Object.keys(t).length>=r.config.maxComponents)throw new Error("registerComponent: maximum components reached.");if(!1===isComponent(n))throw new TypeError(`registerComponent: expected Component, found "${typeof n}".`);if(n.name in t)throw new Error(`registerComponent: component "${n.name}" is already registered.`);const o=getFirstFree(e);if(void 0===o)throw new Error("registerComponent: no ids available!");const i=function createComponentInstance(e,t){if(!1===isComponent(e))throw new TypeError("createComponentInstance: Invalid component provided.");const{schema:r}=e,{id:n,world:o}=t,i=Object.create(e,Ui),a=Object.create(i,{entities:{value:createBitmask(o.config.maxEntities),enumerable:!0,configurable:!1,writable:!1},id:{value:n,enumerable:!0,writable:!1,configurable:!1},world:{value:o,enumerable:!0,writable:!1,configurable:!1},getPropertyArrays:{value:function(){const e=Object.keys(this.schema);return Object.entries(this).filter((([t,r])=>e.includes(t)))},enumerable:!0,writable:!1,configurable:!1}});return Object.entries(r).forEach((([e,t])=>{const{clone:r,create:n,init:i}=t;let c;c=isTypedArray(i)?n(new ArrayBuffer(i.BYTES_PER_ELEMENT*o.config.maxEntities)):new Array(o.config.maxEntities).fill(r(i)),Object.defineProperty(a,e,{value:c,enumerable:!0,configurable:!1,writable:!1})})),a}(n,{id:o,world:r});return setBitOn(e,o),t[n.name]=i,i}}function _unregisterComponent(e,t,r){return function unregisterComponent(n,o=!1){if(!isComponent(n))throw new TypeError(`unregisterComponent: expected Component, found "${typeof n}".`);const i=t[n.name];if(!i)throw new Error(`unregisterComponent: component "${n.name}" is not registered.`);const a=i.entities;return!1!==o&&0!==a.length||(a.forEach((e=>r.removeComponentFromEntity(e,n))),setBitOff(e,i.id),delete t[n.name]),r}}function _addComponentToEntity(e,t){return function addComponentToEntity(r,n,o){if(1!==t.getEntityState(r))throw new Error(`addComponentToEntity: Entity "${r}" does not exist in this world.`);if(!1===isComponent(n)&&!1===isComponentInstance(n)&&"string"!=typeof n)throw new TypeError("addComponentToEntity: Invalid component provided.");const i="string"==typeof n?n:n.name,a=e[i];if(!a)throw new Error(`addComponentToEntity: Component "${i}" is not registered in this world.`);if(isBitOn(a.entities,r))throw new Error(`addComponentToEntity: Entity "${r}" already has component "${i}".`);return void 0!==o&&isObject(o)&&Object.keys(o).forEach((e=>{e in a?a[e][r]=o[e]:console.warn(`addComponentToEntity: Key "${e}" does not exist in component "${a.name}".`)})),setBitOn(a.entities,r),t.updateEntityArchetype(r,a),t}}function _removeComponentFromEntity(e,t){return function removeComponentFromEntity(r,n){if(!t.getEntityState(r))throw new Error(`removeComponentFromEntity: entity "${r}" is not active in this world.`);if(!1===isComponent(n)&&!1===isComponentInstance(n)&&"string"!=typeof n)throw new TypeError("removeComponentFromEntity: invalid component provided.");const o="string"==typeof n?n:n.name,i=e[o];if(!i)throw new Error(`removeComponentFromEntity: component "${o}" is not registered in this world.`);if(!1===isBitOn(i.entities,r))throw new Error(`removeComponentFromEntity: entity "${r}" does not have component "${o}" to remove.`);return setBitOff(i.entities,r),t.updateEntityArchetype(r,i),t}}function _entityHasComponent(e){return function entityHasComponent(t,r){const n="string"==typeof r?r:r.name,o=e[n];return void 0!==o&&isBitOn(o.entities,t)}}function _getProperties(e){return function getProperties(t,r){const n=e["string"==typeof r?r:r.name];if(void 0===n)throw new Error("getProperty: component not registered.");if(!1!==isBitOn(n.entities,t))return n.getPropertyArrays().reduce(((e,[r,n])=>(e[r]=n[t],e)),{})}}function _getComponentById(e){return function getComponentById(t){return[...Object.values(e)].find((e=>e.id===t))}}function _getComponentByName(e){return function getComponentByName(t){return e[t]}}function _getComponents(e){return function getComponents(){return[...Object.values(e)]}}function _isComponentRegistered(e){return function isComponentRegistered(t){return("string"==typeof t?t:t.name)in e}}function _getEntitiesWithComponent(e){return function getEntitiesWithComponent(t){const r=e["string"==typeof t?t:t.name];return r?[...r.entities]:[]}}function _collateEntityProperties(e){const t=_getProperties(e);return function collateEntityProperties(r){return Object.keys(e).reduce(((e,n)=>(e[n]=t(r,n),e)),{})}}function _getComponentId(e){return function getComponentId(t){return e["string"==typeof t?t:t.name]?.id}}function _stripEntity(e,t){return function stripEntity(r){t.resetEntityArchetype(r),Object.values(e).forEach((e=>setBitOff(e.entities,r)))}}
/**
 * @name        EntityManager
 * @description The entity manager creates, destroys and manages the state of entities in the world.
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function _createEntity(e){return function createEntity(){const t=getFirstFree(e);if(void 0===t)throw new Error("createEntity: No available entities. Maximum entities reached.");return setBitOn(e,t),t}}function _destroyEntity(e,t){return function destroyEntity(r){return isBitOn(e,r)&&(t.stripEntity(r),setBitOff(e,r)),t}}function _isEntityRegistered(e){return function isEntityRegistered(t){return isBitOn(e,t)}}function _getEntityState(e){return function getEntityState(t){return function getBitFromMask(e,t){return!0===isBitOn(e,t)?1:0}(e,t)}}const Di=Object.create(Object.prototype,{add:{value:function(e){return this.archetypes.includes(e)||this.archetypes.push(e),this},configurable:!1,enumerable:!0,writable:!1},getEntities:{value:function(){if(!Object.keys(this.archetypes)?.length)return[];const e=Object.values(this.archetypes).flatMap((e=>[...e.entities]));return[...new Set(e)]},configurable:!1,enumerable:!0,writable:!1},isMatch:{value:function(e){if(!this.query||!e)return!1;const t=
/**
 * @name        Query
 * @description Queries group Archetypes
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function isMatch(e,t){const{mask:r}=t;if(!r)return!1;const n=e[0],o=e[1],i=e[2];for(let e=0,t=i.length;e<t;e++)if(0!=(i[e]&r[e]))return!1;for(let e=0,t=n.length;e<t;e++)if((n[e]&r[e])!==r[e])return!1;for(let e=0,t=o.length;e<t;e++)if((o[e]&r[e])>0)return!1;return!0}(this.query,e);return t&&this.add(e),t},configurable:!1,enumerable:!0,writable:!1},isQuery:{value:!0,configurable:!1,enumerable:!0,writable:!1},remove:{value:function(e){return this.archetypes.includes(e)?(this.archetypes.splice(this.archetypes.indexOf(e),1),this):this},configurable:!1,enumerable:!0,writable:!1}});
/**
 * @name        QueryManager
 * @description Handles the creation, destruction of Queries
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function _getQueries(e){return function getQueries(){return[...Object.values(e)]}}function _isQueryRegistered(e){return function isQueryRegistered(t){return Boolean(t.name in e)}}function _registerQuery(e,t){const r=_refreshQuery(t);return function registerQuery(n){if(!isValidName(n.name))throw new Error("Invalid name provided for query.");if(n.name in e)throw new Error(`Query with name "${n.name}" is already registered in this world.`);const o=function createQuery(e,t){const{all:r=[],any:n=[],none:o=[],name:i}=t,a=r.every((e=>void 0!==e.id)),c=n.every((e=>void 0!==e.id)),u=o.every((e=>void 0!==e.id));if(!a||!c||!u)throw new TypeError("createQuery: query spec must contain component instances only, not components or strings.");const s=componentsToMask(e,...r),f=componentsToMask(e,...n),p=componentsToMask(e,...o);return Object.create(Di,{archetypes:{value:[],configurable:!1,enumerable:!0,writable:!1},name:{value:i,configurable:!1,enumerable:!0,writable:!1},query:{value:[s,f,p],configurable:!1,enumerable:!0,writable:!1}})}(t,n);return e[o.name]=o,r(o),o}}function _refreshQuery(e){return function refreshQuery(t){if(!("archetypes"in t))throw new TypeError("invalid query provided.");return e.getArchetypes().forEach((e=>{!0===e[ki]&&t.isMatch(e)})),t}}function _refreshQueries(e,t){const r=_refreshQuery(t);return function refreshQueries(){return Object.values(e).forEach((e=>r(e))),t.getArchetypes().forEach((e=>e[ki]=!1)),t}}function _unregisterQuery(e,t){return function unregisterQuery(r){return delete e[r.name],t}}
/**
 * @name        StepManager
 * @description Manages the game loop/time step functions
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function _pre(e){return function pre(){return e.getPreSystems().forEach((e=>e.pre(e.entities))),e}}function _post(e){return function post(t=0){return e.getPostSystems().forEach((e=>e.post(e.entities,t))),e.refreshQueries(),e}}function _step(e,t,r){let n=0,o=null,i=0;const a=_pre(r),c=_post(r),u=_update(r);return function step(r=0,s=t){if(null!==o)for(n+=.001*(r-o),i=0,a();n>s;){if(i>=e){n=1;break}u(s),n-=s,i++}o=r,c(n/t)}}function _update(e){return function update(t=0){return e.getUpdateSystems().forEach((e=>e.update(e.entities,t))),e}}
/**
 * @description Utilities for handling and manipulating number types
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function clamp(e,t,r){return null!=t&&e<t?t:null!=r&&e>r?r:e}
/**
 * @name        System
 * @description Systems provide the functionality for sets of archetypes
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */const Qi=Object.create(Object.prototype,{isSystem:{value:!0,enumerable:!0,configurable:!1,writable:!1},enabled:{value:!1,enumerable:!0,configurable:!1,writable:!0},disable:{value:function(){return!1===this.enabled},enumerable:!0,configurable:!1,writable:!1},enable:{value:function(){return!0===this.enabled},enumerable:!0,configurable:!1,writable:!1},pre:{value:function noopPre(e){},enumerable:!0,configurable:!1,writable:!0},post:{value:function noopPost(e,t){},enumerable:!0,configurable:!1,writable:!0},update:{value:function noopUpdate(e,t){},enumerable:!0,configurable:!1,writable:!0}});
/**
 * @name        SystemManager
 * @description Manages the creation, destruction of Systems
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function _getSystems(e){return function getSystems(){return[...e]}}function _getPostSystems(e){return function getPostSystems(){return e.filter((e=>"post"in e))}}function _getPreSystems(e){return function getPreSystems(){return e.filter((e=>"pre"in e))}}function _getUpdateSystems(e){return function getUpdateSystems(){return e.filter((e=>"update"in e))}}function _getSystemByIdx(e){return function getSystemByIdx(t){return e[t]}}function _getSystemByName(e){return function getSystemByName(t){return e[t]}}function _isSystemRegistered(e){return function isSystemRegistered(t){return t.name in e}}function _moveSystem(e){return function moveSystem(t,r){const n=e.indexOf(t);if(-1===n)return-1;const o=clamp(r,0,e.length);return e.splice(o,1),e.splice(n,0,t),o}}function _registerSystem(e,t){return function registerSystem(r,n){if(!isValidName(r.name))throw new SyntaxError(`"${r.name}" is not a valid system name.`);if(r.name in t)throw new Error(`System "${r.name}" is already registered!`);if(!r.pre&&!r.post&&!r.update)throw new SyntaxError('No functions provided for system. Please provide a "pre"');const o=function createSystem(e){const{name:t,query:r,pre:n,post:o,update:i}=e,a=Object.create(Qi,{name:{value:t,enumerable:!0,configurable:!1,writable:!1},query:{value:r,enumerable:!0,configurable:!1,writable:!1},entities:{get(){return this.query?.getEntities()??[]},enumerable:!0,configurable:!1}});return n&&(a.pre=n),o&&(a.post=o),i&&(a.update=i),a}(r);return void 0!==n?e.splice(clamp(n,0,e.length),0,o):e.push(o),t[o.name]=o,o}}function _unregisterSystem(e,t,r){return function unregisterSystem(n){if(!(n.name in t))throw new Error(`System "${n.name}" is not registered!`);delete t[n.name];const o=e.indexOf(n);return o>-1&&e.splice(o,1),r}}
/**
 * @name        World
 * @description The primary context for the ECS.
 * @author      P. Hughes <peter@phugh.es> (https://www.phugh.es)
 * @copyright   2021 P. Hughes. All rights reserved.
 * @license     MIT
 */
function createWorld(e={}){const{maxComponents:t=256,maxEntities:r=1e5,maxUpdates:n=240,tempo:o=1/60}=e,i={config:Object.freeze({maxComponents:t,maxEntities:r,maxUpdates:n,tempo:o}),id:`${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`};return Object.assign(i,function createArchetypeManager(e){const{maxComponents:t,maxEntities:r}=e.config,n=createArchetype(createBitmask(t)),o={},i=new Array(r).fill(n);return{archetypeHasComponent:function archetypeHasComponent(e,t){return isBitOn(e.mask,t.id)},getArchetypes:(c=o,function getArchetypes(){return[...Object.values(c)]}),getEntityArchetype:(a=i,function getEntityArchetype(e){return a[e]}),resetEntityArchetype:_resetEntityArchetype(o,i,n),updateEntityArchetype:_updateEntityArchetype(o,i,e)};var a,c}(i),function createComponentManager(e){const{maxComponents:t}=e.config,r=createBitmask(t),n={};return{addComponentToEntity:_addComponentToEntity(n,e),collateEntityProperties:_collateEntityProperties(n),entityHasComponent:_entityHasComponent(n),getComponentById:_getComponentById(n),getComponentByName:_getComponentByName(n),getComponentId:_getComponentId(n),getComponents:_getComponents(n),getEntitiesWithComponent:_getEntitiesWithComponent(n),getProperties:_getProperties(n),isComponentRegistered:_isComponentRegistered(n),registerComponent:_registerComponent(r,n,e),removeComponentFromEntity:_removeComponentFromEntity(n,e),stripEntity:_stripEntity(n,e),unregisterComponent:_unregisterComponent(r,n,e)}}(i),function createEntityManager(e){const{maxEntities:t}=e.config,r=createBitmask(t);return{createEntity:_createEntity(r),destroyEntity:_destroyEntity(r,e),getEntityState:_getEntityState(r),isEntityRegistered:_isEntityRegistered(r)}}(i),function createQueryManager(e){const t={};return{getQueries:_getQueries(t),isQueryRegistered:_isQueryRegistered(t),registerQuery:_registerQuery(t,e),refreshQuery:_refreshQuery(e),refreshQueries:_refreshQueries(t,e),unregisterQuery:_unregisterQuery(t,e)}}(i),function createStepManager(e){const{maxUpdates:t,tempo:r}=e.config;return{pre:_pre(e),post:_post(e),step:_step(t,r,e),update:_update(e)}}(i),function createSystemManager(e){const t=[],r={};return{getSystems:_getSystems(t),getPostSystems:_getPostSystems(t),getPreSystems:_getPreSystems(t),getUpdateSystems:_getUpdateSystems(t),getSystemByIdx:_getSystemByIdx(t),getSystemByName:_getSystemByName(r),isSystemRegistered:_isSystemRegistered(r),moveSystem:_moveSystem(t),registerSystem:_registerSystem(t,r),unregisterSystem:_unregisterSystem(t,r,e)}}(i)),i}export{Mi as Types,createComponent,createWorld};
//# sourceMappingURL=index.min.js.map
