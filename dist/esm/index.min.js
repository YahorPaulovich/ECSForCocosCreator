/*! *****************************************************************************
 *
 * miski
 * v0.5.0
 *
 * MIT License
 * 
 * Copyright (C) 2021 Peter Hughes<https://www.phugh.es>, all rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
***************************************************************************** */
var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},check=function(t){return t&&t.Math==Math&&t},e=check("object"==typeof globalThis&&globalThis)||check("object"==typeof window&&window)||check("object"==typeof self&&self)||check("object"==typeof t&&t)||function(){return this}()||Function("return this")(),r={},fails$9=function(t){try{return!!t()}catch(t){return!0}},n=!fails$9((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),o={},i={}.propertyIsEnumerable,a=Object.getOwnPropertyDescriptor,u=a&&!i.call({1:2},1);o.f=u?function propertyIsEnumerable(t){var e=a(this,t);return!!e&&e.enumerable}:i;var f,c,createPropertyDescriptor$3=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},s={}.toString,classofRaw$1=function(t){return s.call(t).slice(8,-1)},l=classofRaw$1,p="".split,y=fails$9((function(){return!Object("z").propertyIsEnumerable(0)}))?function(t){return"String"==l(t)?p.call(t,""):Object(t)}:Object,requireObjectCoercible$2=function(t){if(null==t)throw TypeError("Can't call method on "+t);return t},d=y,h=requireObjectCoercible$2,toIndexedObject$3=function(t){return d(h(t))},isObject$c=function(t){return"object"==typeof t?null!==t:"function"==typeof t},m=e,aFunction$m=function(t){return"function"==typeof t?t:void 0},getBuiltIn$f=function(t,e){return arguments.length<2?aFunction$m(m[t]):m[t]&&m[t][e]},g=getBuiltIn$f("navigator","userAgent")||"",v=e,w=g,E=v.process,b=v.Deno,S=E&&E.versions||b&&b.version,T=S&&S.v8;T?c=(f=T.split("."))[0]<4?1:f[0]+f[1]:w&&(!(f=w.match(/Edge\/(\d+)/))||f[1]>=74)&&(f=w.match(/Chrome\/(\d+)/))&&(c=f[1]);var A=c&&+c,O=A,I=fails$9,R=!!Object.getOwnPropertySymbols&&!I((function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&O&&O<41})),_=R&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,P=getBuiltIn$f,x=_?function(t){return"symbol"==typeof t}:function(t){var e=P("Symbol");return"function"==typeof e&&Object(t)instanceof e},j=isObject$c,D={exports:{}},C=e,setGlobal$3=function(t,e){try{Object.defineProperty(C,t,{value:e,configurable:!0,writable:!0})}catch(r){C[t]=e}return e},N=setGlobal$3,U=e["__core-js_shared__"]||N("__core-js_shared__",{}),M=U;(D.exports=function(t,e){return M[t]||(M[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.16.0",mode:"global",copyright:"Â© 2021 Denis Pushkarev (zloirock.ru)"});var B=requireObjectCoercible$2,toObject$5=function(t){return Object(B(t))},V=toObject$5,k={}.hasOwnProperty,L=Object.hasOwn||function hasOwn(t,e){return k.call(V(t),e)},G=0,W=Math.random(),uid$3=function(t){return"Symbol("+String(void 0===t?"":t)+")_"+(++G+W).toString(36)},$=e,q=D.exports,Y=L,Q=uid$3,Z=R,z=_,K=q("wks"),X=$.Symbol,H=z?X:X&&X.withoutSetter||Q,wellKnownSymbol$b=function(t){return Y(K,t)&&(Z||"string"==typeof K[t])||(Z&&Y(X,t)?K[t]=X[t]:K[t]=H("Symbol."+t)),K[t]},J=isObject$c,tt=x,ordinaryToPrimitive=function(t,e){var r,n;if("string"===e&&"function"==typeof(r=t.toString)&&!j(n=r.call(t)))return n;if("function"==typeof(r=t.valueOf)&&!j(n=r.call(t)))return n;if("string"!==e&&"function"==typeof(r=t.toString)&&!j(n=r.call(t)))return n;throw TypeError("Can't convert object to primitive value")},et=wellKnownSymbol$b("toPrimitive"),toPrimitive=function(t,e){if(!J(t)||tt(t))return t;var r,n=t[et];if(void 0!==n){if(void 0===e&&(e="default"),r=n.call(t,e),!J(r)||tt(r))return r;throw TypeError("Can't convert object to primitive value")}return void 0===e&&(e="number"),ordinaryToPrimitive(t,e)},rt=x,toPropertyKey$3=function(t){var e=toPrimitive(t,"string");return rt(e)?e:String(e)},nt=isObject$c,ot=e.document,it=nt(ot)&&nt(ot.createElement),documentCreateElement$1=function(t){return it?ot.createElement(t):{}},at=documentCreateElement$1,ut=!n&&!fails$9((function(){return 7!=Object.defineProperty(at("div"),"a",{get:function(){return 7}}).a})),ft=n,ct=o,st=createPropertyDescriptor$3,lt=toIndexedObject$3,pt=toPropertyKey$3,yt=L,dt=ut,ht=Object.getOwnPropertyDescriptor;r.f=ft?ht:function getOwnPropertyDescriptor(t,e){if(t=lt(t),e=pt(e),dt)try{return ht(t,e)}catch(t){}if(yt(t,e))return st(!ct.f.call(t,e),t[e])};var mt={},gt=isObject$c,anObject$B=function(t){if(!gt(t))throw TypeError(String(t)+" is not an object");return t},vt=n,wt=ut,Et=anObject$B,bt=toPropertyKey$3,St=Object.defineProperty;mt.f=vt?St:function defineProperty(t,e,r){if(Et(t),e=bt(e),Et(r),wt)try{return St(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(t[e]=r.value),t};var Tt=mt,At=createPropertyDescriptor$3,Ot=n?function(t,e,r){return Tt.f(t,e,At(1,r))}:function(t,e,r){return t[e]=r,t},It={exports:{}},Rt=U,_t=Function.toString;"function"!=typeof Rt.inspectSource&&(Rt.inspectSource=function(t){return _t.call(t)});var Pt,xt,jt,Dt=Rt.inspectSource,Ct=Dt,Nt=e.WeakMap,Ut="function"==typeof Nt&&/native code/.test(Ct(Nt)),Ft=D.exports,Mt=uid$3,Bt=Ft("keys"),sharedKey$3=function(t){return Bt[t]||(Bt[t]=Mt(t))},Vt={},kt=Ut,Lt=isObject$c,Gt=Ot,Wt=L,$t=U,qt=sharedKey$3,Yt=Vt,Qt=e.WeakMap;if(kt||$t.state){var Zt=$t.state||($t.state=new Qt),zt=Zt.get,Kt=Zt.has,Xt=Zt.set;Pt=function(t,e){if(Kt.call(Zt,t))throw new TypeError("Object already initialized");return e.facade=t,Xt.call(Zt,t,e),e},xt=function(t){return zt.call(Zt,t)||{}},jt=function(t){return Kt.call(Zt,t)}}else{var Ht=qt("state");Yt[Ht]=!0,Pt=function(t,e){if(Wt(t,Ht))throw new TypeError("Object already initialized");return e.facade=t,Gt(t,Ht,e),e},xt=function(t){return Wt(t,Ht)?t[Ht]:{}},jt=function(t){return Wt(t,Ht)}}var Jt={set:Pt,get:xt,has:jt,enforce:function(t){return jt(t)?xt(t):Pt(t,{})},getterFor:function(t){return function(e){var r;if(!Lt(e)||(r=xt(e)).type!==t)throw TypeError("Incompatible receiver, "+t+" required");return r}}},te=e,ee=Ot,re=L,ne=setGlobal$3,oe=Dt,ie=Jt.get,ae=Jt.enforce,ue=String(String).split("String");(It.exports=function(t,e,r,n){var o,i=!!n&&!!n.unsafe,a=!!n&&!!n.enumerable,u=!!n&&!!n.noTargetGet;"function"==typeof r&&("string"!=typeof e||re(r,"name")||ee(r,"name",e),(o=ae(r)).source||(o.source=ue.join("string"==typeof e?e:""))),t!==te?(i?!u&&t[e]&&(a=!0):delete t[e],a?t[e]=r:ee(t,e,r)):a?t[e]=r:ne(e,r)})(Function.prototype,"toString",(function toString(){return"function"==typeof this&&ie(this).source||oe(this)}));var fe={},ce=Math.ceil,se=Math.floor,toInteger$5=function(t){return isNaN(t=+t)?0:(t>0?se:ce)(t)},le=toInteger$5,pe=Math.min,toLength$9=function(t){return t>0?pe(le(t),9007199254740991):0},ye=toInteger$5,de=Math.max,he=Math.min,toAbsoluteIndex$2=function(t,e){var r=ye(t);return r<0?de(r+e,0):he(r,e)},me=toIndexedObject$3,ge=toLength$9,ve=toAbsoluteIndex$2,createMethod$1=function(t){return function(e,r,n){var o,i=me(e),a=ge(i.length),u=ve(n,a);if(t&&r!=r){for(;a>u;)if((o=i[u++])!=o)return!0}else for(;a>u;u++)if((t||u in i)&&i[u]===r)return t||u||0;return!t&&-1}},we={includes:createMethod$1(!0),indexOf:createMethod$1(!1)},Ee=L,be=toIndexedObject$3,Se=we.indexOf,Te=Vt,objectKeysInternal=function(t,e){var r,n=be(t),o=0,i=[];for(r in n)!Ee(Te,r)&&Ee(n,r)&&i.push(r);for(;e.length>o;)Ee(n,r=e[o++])&&(~Se(i,r)||i.push(r));return i},Ae=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Oe=objectKeysInternal,Ie=Ae.concat("length","prototype");fe.f=Object.getOwnPropertyNames||function getOwnPropertyNames(t){return Oe(t,Ie)};var Re={};Re.f=Object.getOwnPropertySymbols;var _e=fe,Pe=Re,xe=anObject$B,je=getBuiltIn$f("Reflect","ownKeys")||function ownKeys(t){var e=_e.f(xe(t)),r=Pe.f;return r?e.concat(r(t)):e},De=L,Ce=je,Ne=r,Ue=mt,Fe=fails$9,Me=/#|\.prototype\./,isForced$1=function(t,e){var r=Ve[Be(t)];return r==Le||r!=ke&&("function"==typeof e?Fe(e):!!e)},Be=isForced$1.normalize=function(t){return String(t).replace(Me,".").toLowerCase()},Ve=isForced$1.data={},ke=isForced$1.NATIVE="N",Le=isForced$1.POLYFILL="P",Ge=isForced$1,We=e,$e=r.f,qe=Ot,Ye=It.exports,Qe=setGlobal$3,copyConstructorProperties=function(t,e){for(var r=Ce(e),n=Ue.f,o=Ne.f,i=0;i<r.length;i++){var a=r[i];De(t,a)||n(t,a,o(e,a))}},Ze=Ge,_export=function(t,e){var r,n,o,i,a,u=t.target,f=t.global,c=t.stat;if(r=f?We:c?We[u]||Qe(u,{}):(We[u]||{}).prototype)for(n in e){if(i=e[n],o=t.noTargetGet?(a=$e(r,n))&&a.value:r[n],!Ze(f?n:u+(c?".":"#")+n,t.forced)&&void 0!==o){if(typeof i==typeof o)continue;copyConstructorProperties(i,o)}(t.sham||o&&o.sham)&&qe(i,"sham",!0),Ye(r,n,i,t)}},aFunction$l=function(t){if("function"!=typeof t)throw TypeError(String(t)+" is not a function");return t},ze=anObject$B,Ke=aFunction$l,collectionAddAll=function(){for(var t=ze(this),e=Ke(t.add),r=0,n=arguments.length;r<n;r++)e.call(t,arguments[r]);return t};_export({target:"Set",proto:!0,real:!0,forced:false},{addAll:function addAll(){return collectionAddAll.apply(this,arguments)}});var Xe=anObject$B,He=aFunction$l,collectionDeleteAll$2=function(){for(var t,e=Xe(this),r=He(e.delete),n=!0,o=0,i=arguments.length;o<i;o++)t=r.call(e,arguments[o]),n=n&&t;return!!n},Je=collectionDeleteAll$2;_export({target:"Set",proto:!0,real:!0,forced:false},{deleteAll:function deleteAll(){return Je.apply(this,arguments)}});var tr=anObject$B,er=aFunction$l,rr=wellKnownSymbol$b("species"),speciesConstructor$9=function(t,e){var r,n=tr(t).constructor;return void 0===n||null==(r=tr(n)[rr])?e:er(r)},nr={},or=nr,ir=wellKnownSymbol$b("iterator"),ar=Array.prototype,isArrayIteratorMethod$2=function(t){return void 0!==t&&(or.Array===t||ar[ir]===t)},ur=aFunction$l,functionBindContext=function(t,e,r){if(ur(t),void 0===e)return t;switch(r){case 0:return function(){return t.call(e)};case 1:return function(r){return t.call(e,r)};case 2:return function(r,n){return t.call(e,r,n)};case 3:return function(r,n,o){return t.call(e,r,n,o)}}return function(){return t.apply(e,arguments)}},fr={};fr[wellKnownSymbol$b("toStringTag")]="z";var cr="[object z]"===String(fr),sr=classofRaw$1,lr=wellKnownSymbol$b("toStringTag"),pr="Arguments"==sr(function(){return arguments}()),yr=cr?sr:function(t){var e,r,n;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=function(t,e){try{return t[e]}catch(t){}}(e=Object(t),lr))?r:pr?sr(e):"Object"==(n=sr(e))&&"function"==typeof e.callee?"Arguments":n},dr=yr,hr=nr,mr=wellKnownSymbol$b("iterator"),getIteratorMethod$3=function(t){if(null!=t)return t[mr]||t["@@iterator"]||hr[dr(t)]},gr=anObject$B,vr=anObject$B,wr=isArrayIteratorMethod$2,Er=toLength$9,br=functionBindContext,Sr=getIteratorMethod$3,iteratorClose=function(t){var e=t.return;if(void 0!==e)return gr(e.call(t)).value},Result=function(t,e){this.stopped=t,this.result=e},iterate$p=function(t,e,r){var n,o,i,a,u,f,c,s=r&&r.that,l=!(!r||!r.AS_ENTRIES),p=!(!r||!r.IS_ITERATOR),y=!(!r||!r.INTERRUPTED),d=br(e,s,1+l+y),stop=function(t){return n&&iteratorClose(n),new Result(!0,t)},callFn=function(t){return l?(vr(t),y?d(t[0],t[1],stop):d(t[0],t[1])):y?d(t,stop):d(t)};if(p)n=t;else{if("function"!=typeof(o=Sr(t)))throw TypeError("Target is not iterable");if(wr(o)){for(i=0,a=Er(t.length);a>i;i++)if((u=callFn(t[i]))&&u instanceof Result)return u;return new Result(!1)}n=o.call(t)}for(f=n.next;!(c=f.call(n)).done;){try{u=callFn(c.value)}catch(t){throw iteratorClose(n),t}if("object"==typeof u&&u&&u instanceof Result)return u}return new Result(!1)},Tr=getBuiltIn$f,Ar=anObject$B,Or=aFunction$l,Ir=speciesConstructor$9,Rr=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{difference:function difference(t){var e=Ar(this),r=new(Ir(e,Tr("Set")))(e),n=Or(r.delete);return Rr(t,(function(t){n.call(r,t)})),r}});var getSetIterator$7=function(t){return Set.prototype.values.call(t)},_r=anObject$B,Pr=functionBindContext,xr=getSetIterator$7,jr=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{every:function every(t){var e=_r(this),r=xr(e),n=Pr(t,arguments.length>1?arguments[1]:void 0,3);return!jr(r,(function(t,r){if(!n(t,t,e))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Dr=getBuiltIn$f,Cr=anObject$B,Nr=aFunction$l,Ur=functionBindContext,Fr=speciesConstructor$9,Mr=getSetIterator$7,Br=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{filter:function filter(t){var e=Cr(this),r=Mr(e),n=Ur(t,arguments.length>1?arguments[1]:void 0,3),o=new(Fr(e,Dr("Set"))),i=Nr(o.add);return Br(r,(function(t){n(t,t,e)&&i.call(o,t)}),{IS_ITERATOR:!0}),o}});var Vr=anObject$B,kr=functionBindContext,Lr=getSetIterator$7,Gr=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{find:function find(t){var e=Vr(this),r=Lr(e),n=kr(t,arguments.length>1?arguments[1]:void 0,3);return Gr(r,(function(t,r){if(n(t,t,e))return r(t)}),{IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Wr=getBuiltIn$f,$r=anObject$B,qr=aFunction$l,Yr=speciesConstructor$9,Qr=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{intersection:function intersection(t){var e=$r(this),r=new(Yr(e,Wr("Set"))),n=qr(e.has),o=qr(r.add);return Qr(t,(function(t){n.call(e,t)&&o.call(r,t)})),r}});var Zr=anObject$B,zr=aFunction$l,Kr=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{isDisjointFrom:function isDisjointFrom(t){var e=Zr(this),r=zr(e.has);return!Kr(t,(function(t,n){if(!0===r.call(e,t))return n()}),{INTERRUPTED:!0}).stopped}});var Xr=anObject$B,Hr=getIteratorMethod$3,Jr=getBuiltIn$f,tn=anObject$B,en=aFunction$l,getIterator=function(t){var e=Hr(t);if("function"!=typeof e)throw TypeError(String(t)+" is not iterable");return Xr(e.call(t))},rn=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{isSubsetOf:function isSubsetOf(t){var e=getIterator(this),r=tn(t),n=r.has;return"function"!=typeof n&&(r=new(Jr("Set"))(t),n=en(r.has)),!rn(e,(function(t,e){if(!1===n.call(r,t))return e()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var nn=anObject$B,on=aFunction$l,an=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{isSupersetOf:function isSupersetOf(t){var e=nn(this),r=on(e.has);return!an(t,(function(t,n){if(!1===r.call(e,t))return n()}),{INTERRUPTED:!0}).stopped}});var un=anObject$B,fn=getSetIterator$7,cn=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{join:function join(t){var e=un(this),r=fn(e),n=void 0===t?",":String(t),o=[];return cn(r,o.push,{that:o,IS_ITERATOR:!0}),o.join(n)}});var sn=getBuiltIn$f,ln=anObject$B,pn=aFunction$l,yn=functionBindContext,dn=speciesConstructor$9,hn=getSetIterator$7,mn=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{map:function map(t){var e=ln(this),r=hn(e),n=yn(t,arguments.length>1?arguments[1]:void 0,3),o=new(dn(e,sn("Set"))),i=pn(o.add);return mn(r,(function(t){i.call(o,n(t,t,e))}),{IS_ITERATOR:!0}),o}});var gn=anObject$B,vn=aFunction$l,wn=getSetIterator$7,En=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{reduce:function reduce(t){var e=gn(this),r=wn(e),n=arguments.length<2,o=n?void 0:arguments[1];if(vn(t),En(r,(function(r){n?(n=!1,o=r):o=t(o,r,r,e)}),{IS_ITERATOR:!0}),n)throw TypeError("Reduce of empty set with no initial value");return o}});var bn=anObject$B,Sn=functionBindContext,Tn=getSetIterator$7,An=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{some:function some(t){var e=bn(this),r=Tn(e),n=Sn(t,arguments.length>1?arguments[1]:void 0,3);return An(r,(function(t,r){if(n(t,t,e))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var On=getBuiltIn$f,In=anObject$B,Rn=aFunction$l,_n=speciesConstructor$9,Pn=iterate$p;_export({target:"Set",proto:!0,real:!0,forced:false},{symmetricDifference:function symmetricDifference(t){var e=In(this),r=new(_n(e,On("Set")))(e),n=Rn(r.delete),o=Rn(r.add);return Pn(t,(function(t){n.call(r,t)||o.call(r,t)})),r}});var xn=getBuiltIn$f,jn=anObject$B,Dn=aFunction$l,Cn=speciesConstructor$9,Nn=iterate$p;async function indexOf(t,e){for(let r=0,n=t.length;r!=n;r++)if(t[r]===e)return Promise.resolve(r);return Promise.resolve(-1)}function spliceOne(t,e){const r=t.length;if(!r)return t;for(;e<r;)t[e]=t[e+1],e++;return t.length=t.length-1,t}function isObject$6(t){return Boolean("object"==typeof t&&!Array.isArray(t))}function systemNoop(t){}_export({target:"Set",proto:!0,real:!0,forced:false},{union:function union(t){var e=jn(this),r=new(Cn(e,xn("Set")))(e);return Nn(t,Dn(r.add),{that:r}),r}});const Un=/^(?![0-9])[a-zA-Z0-9$_]+$/;function isValidName(t){return"string"==typeof t&&((t=t.trim()).length>0&&Un.test(t)&&!Fn.has(t))}const Fn=new Set(["entities","id","instances","name","schema","world","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]);function createQuery(t){if(!t)throw new Error("Query spec object required.");const{all:e=[],any:r=[],none:n=[]}=t;return{instances:[],all:[...e],any:[...r],none:[...n]}}function isQueryCandidate(t,e){for(let r=0,n=t.and.length;r<n;r++){const n=e.mask[r];if(0!=(t.not[r]&n))return!1;if((t.and[r]&n)!==t.and[r])return!1;if((t.or[r]&n)>0)return!1}return function addArchetypeToQuery(t,e){return-1!==t.archetypes.indexOf(e)||t.archetypes.push(e),t}(t,e),!0}function removeArchetypeFromQuery(t,e){const r=t.archetypes.indexOf(e);return-1===r||spliceOne(t.archetypes,r),t}function _getComponents(t){return[...t.components]}function getComponentsFromQuery(t){return t.archetypes.flatMap(_getComponents).reduce(((t,e)=>(t[e.name]=e,t)),{})}function _getEntities(t){return[...t.entities]}function getEntitiesFromQuery(t){return t.archetypes.flatMap(_getEntities)}async function updateEntityArchetype(t,e,r,n=!1){const{archetypes:o,entities:i,queries:a}=t,u=[...a.values()];let f=[];const c=i[e];if(c&&(c.entities.delete(e),f=[...c.components],0===c.entities.size)){const _removeArchetype=t=>removeArchetypeFromQuery(t,c);await Promise.all(u.map(_removeArchetype)),delete o[c.name]}if(r)if(!1===n)f.push(r);else{const t=f.indexOf(r);t>-1&&spliceOne(f,t)}const s=await async function createArchetype(t,...e){const r=await createBitmaskFromComponents(t,...e);return{components:new Set(e),entities:new Set,mask:r,name:r.toString()}}(t,...f);let l;if(s.name in o){if(l=o[s.name],void 0===l)throw new Error("Could not get archetype")}else{l=s,o[l.name]=l;const _isMatch=t=>isQueryCandidate(t,l);await Promise.all(u.map(_isMatch))}return l.entities.add(e),i[e]=l,l}var Mn={exports:{}},Bn=wellKnownSymbol$b("iterator"),Vn=!1;try{var kn=0,Ln={next:function(){return{done:!!kn++}},return:function(){Vn=!0}};Ln[Bn]=function(){return this},Array.from(Ln,(function(){throw 2}))}catch(t){}var Gn,Wn,$n,qn="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Yn=!fails$9((function(){function F(){}return F.prototype.constructor=null,Object.getPrototypeOf(new F)!==F.prototype})),Qn=L,Zn=toObject$5,zn=Yn,Kn=sharedKey$3("IE_PROTO"),Xn=Object.prototype,Hn=zn?Object.getPrototypeOf:function(t){return t=Zn(t),Qn(t,Kn)?t[Kn]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?Xn:null},Jn=isObject$c,to=anObject$B,aPossiblePrototype=function(t){if(!Jn(t)&&null!==t)throw TypeError("Can't set "+String(t)+" as a prototype");return t},eo=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,r={};try{(t=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(r,[]),e=r instanceof Array}catch(t){}return function setPrototypeOf(r,n){return to(r),aPossiblePrototype(n),e?t.call(r,n):r.__proto__=n,r}}():void 0),ro=qn,no=n,oo=e,io=isObject$c,ao=L,uo=yr,fo=Ot,co=It.exports,so=mt.f,lo=Hn,po=eo,yo=wellKnownSymbol$b,ho=uid$3,mo=oo.Int8Array,go=mo&&mo.prototype,vo=oo.Uint8ClampedArray,wo=vo&&vo.prototype,Eo=mo&&lo(mo),bo=go&&lo(go),So=Object.prototype,To=So.isPrototypeOf,Ao=yo("toStringTag"),Oo=ho("TYPED_ARRAY_TAG"),Io=ho("TYPED_ARRAY_CONSTRUCTOR"),Ro=ro&&!!po&&"Opera"!==uo(oo.opera),_o=!1,Po={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},xo={BigInt64Array:8,BigUint64Array:8},isTypedArray$1=function(t){if(!io(t))return!1;var e=uo(t);return ao(Po,e)||ao(xo,e)};for(Gn in Po)($n=(Wn=oo[Gn])&&Wn.prototype)?fo($n,Io,Wn):Ro=!1;for(Gn in xo)($n=(Wn=oo[Gn])&&Wn.prototype)&&fo($n,Io,Wn);if((!Ro||"function"!=typeof Eo||Eo===Function.prototype)&&(Eo=function TypedArray(){throw TypeError("Incorrect invocation")},Ro))for(Gn in Po)oo[Gn]&&po(oo[Gn],Eo);if((!Ro||!bo||bo===So)&&(bo=Eo.prototype,Ro))for(Gn in Po)oo[Gn]&&po(oo[Gn].prototype,bo);if(Ro&&lo(wo)!==bo&&po(wo,bo),no&&!ao(bo,Ao))for(Gn in _o=!0,so(bo,Ao,{get:function(){return io(this)?this[Oo]:void 0}}),Po)oo[Gn]&&fo(oo[Gn],Oo,Gn);var jo={NATIVE_ARRAY_BUFFER_VIEWS:Ro,TYPED_ARRAY_CONSTRUCTOR:Io,TYPED_ARRAY_TAG:_o&&Oo,aTypedArray:function(t){if(isTypedArray$1(t))return t;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(t){if(po&&!To.call(Eo,t))throw TypeError("Target is not a typed array constructor");return t},exportTypedArrayMethod:function(t,e,r){if(no){if(r)for(var n in Po){var o=oo[n];if(o&&ao(o.prototype,t))try{delete o.prototype[t]}catch(t){}}bo[t]&&!r||co(bo,t,r?e:Ro&&go[t]||e)}},exportTypedArrayStaticMethod:function(t,e,r){var n,o;if(no){if(po){if(r)for(n in Po)if((o=oo[n])&&ao(o,t))try{delete o[t]}catch(t){}if(Eo[t]&&!r)return;try{return co(Eo,t,r?e:Ro&&Eo[t]||e)}catch(t){}}for(n in Po)!(o=oo[n])||o[t]&&!r||co(o,t,e)}},isView:function isView(t){if(!io(t))return!1;var e=uo(t);return"DataView"===e||ao(Po,e)||ao(xo,e)},isTypedArray:isTypedArray$1,TypedArray:Eo,TypedArrayPrototype:bo},Do=e,Co=fails$9,checkCorrectnessOfIteration=function(t,e){if(!e&&!Vn)return!1;var r=!1;try{var n={};n[Bn]=function(){return{next:function(){return{done:r=!0}}}},t(n)}catch(t){}return r},No=jo.NATIVE_ARRAY_BUFFER_VIEWS,Uo=Do.ArrayBuffer,Fo=Do.Int8Array,Mo=!No||!Co((function(){Fo(1)}))||!Co((function(){new Fo(-1)}))||!checkCorrectnessOfIteration((function(t){new Fo,new Fo(null),new Fo(1.5),new Fo(t)}),!0)||Co((function(){return 1!==new Fo(new Uo(2),1,void 0).length})),Bo=It.exports,anInstance$2=function(t,e,r){if(!(t instanceof e))throw TypeError("Incorrect "+(r?r+" ":"")+"invocation");return t},Vo=toInteger$5,ko=toLength$9,toIndex$2=function(t){if(void 0===t)return 0;var e=Vo(t),r=ko(e);if(e!==r)throw RangeError("Wrong length or index");return r},Lo=Math.abs,Go=Math.pow,Wo=Math.floor,$o=Math.log,qo=Math.LN2,Yo={pack:function(t,e,r){var n,o,i,a=new Array(r),u=8*r-e-1,f=(1<<u)-1,c=f>>1,s=23===e?Go(2,-24)-Go(2,-77):0,l=t<0||0===t&&1/t<0?1:0,p=0;for((t=Lo(t))!=t||t===1/0?(o=t!=t?1:0,n=f):(n=Wo($o(t)/qo),t*(i=Go(2,-n))<1&&(n--,i*=2),(t+=n+c>=1?s/i:s*Go(2,1-c))*i>=2&&(n++,i/=2),n+c>=f?(o=0,n=f):n+c>=1?(o=(t*i-1)*Go(2,e),n+=c):(o=t*Go(2,c-1)*Go(2,e),n=0));e>=8;a[p++]=255&o,o/=256,e-=8);for(n=n<<e|o,u+=e;u>0;a[p++]=255&n,n/=256,u-=8);return a[--p]|=128*l,a},unpack:function(t,e){var r,n=t.length,o=8*n-e-1,i=(1<<o)-1,a=i>>1,u=o-7,f=n-1,c=t[f--],s=127&c;for(c>>=7;u>0;s=256*s+t[f],f--,u-=8);for(r=s&(1<<-u)-1,s>>=-u,u+=e;u>0;r=256*r+t[f],f--,u-=8);if(0===s)s=1-a;else{if(s===i)return r?NaN:c?-1/0:1/0;r+=Go(2,e),s-=a}return(c?-1:1)*r*Go(2,s-e)}},Qo=toObject$5,Zo=toAbsoluteIndex$2,zo=toLength$9,Ko=mt.f,Xo=L,Ho=wellKnownSymbol$b("toStringTag"),Jo=e,ti=n,ei=qn,ri=Ot,redefineAll=function(t,e,r){for(var n in e)Bo(t,n,e[n],r);return t},ni=fails$9,oi=anInstance$2,ii=toInteger$5,ai=toLength$9,ui=toIndex$2,fi=Yo,ci=Hn,si=eo,li=fe.f,pi=mt.f,yi=function fill(t){for(var e=Qo(this),r=zo(e.length),n=arguments.length,o=Zo(n>1?arguments[1]:void 0,r),i=n>2?arguments[2]:void 0,a=void 0===i?r:Zo(i,r);a>o;)e[o++]=t;return e},setToStringTag=function(t,e,r){t&&!Xo(t=r?t:t.prototype,Ho)&&Ko(t,Ho,{configurable:!0,value:e})},di=Jt.get,hi=Jt.set,mi=Jo.ArrayBuffer,gi=mi,vi=Jo.DataView,wi=vi&&vi.prototype,Ei=Object.prototype,bi=Jo.RangeError,Si=fi.pack,Ti=fi.unpack,packInt8=function(t){return[255&t]},packInt16=function(t){return[255&t,t>>8&255]},packInt32=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},unpackInt32=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},packFloat32=function(t){return Si(t,23,4)},packFloat64=function(t){return Si(t,52,8)},addGetter$1=function(t,e){pi(t.prototype,e,{get:function(){return di(this)[e]}})},get=function(t,e,r,n){var o=ui(r),i=di(t);if(o+e>i.byteLength)throw bi("Wrong index");var a=di(i.buffer).bytes,u=o+i.byteOffset,f=a.slice(u,u+e);return n?f:f.reverse()},set=function(t,e,r,n,o,i){var a=ui(r),u=di(t);if(a+e>u.byteLength)throw bi("Wrong index");for(var f=di(u.buffer).bytes,c=a+u.byteOffset,s=n(+o),l=0;l<e;l++)f[c+l]=s[i?l:e-l-1]};if(ei){if(!ni((function(){mi(1)}))||!ni((function(){new mi(-1)}))||ni((function(){return new mi,new mi(1.5),new mi(NaN),"ArrayBuffer"!=mi.name}))){for(var Ai,Oi=(gi=function ArrayBuffer(t){return oi(this,gi),new mi(ui(t))}).prototype=mi.prototype,Ii=li(mi),Ri=0;Ii.length>Ri;)(Ai=Ii[Ri++])in gi||ri(gi,Ai,mi[Ai]);Oi.constructor=gi}si&&ci(wi)!==Ei&&si(wi,Ei);var _i=new vi(new gi(2)),Pi=wi.setInt8;_i.setInt8(0,2147483648),_i.setInt8(1,2147483649),!_i.getInt8(0)&&_i.getInt8(1)||redefineAll(wi,{setInt8:function setInt8(t,e){Pi.call(this,t,e<<24>>24)},setUint8:function setUint8(t,e){Pi.call(this,t,e<<24>>24)}},{unsafe:!0})}else gi=function ArrayBuffer(t){oi(this,gi,"ArrayBuffer");var e=ui(t);hi(this,{bytes:yi.call(new Array(e),0),byteLength:e}),ti||(this.byteLength=e)},vi=function DataView(t,e,r){oi(this,vi,"DataView"),oi(t,gi,"DataView");var n=di(t).byteLength,o=ii(e);if(o<0||o>n)throw bi("Wrong offset");if(o+(r=void 0===r?n-o:ai(r))>n)throw bi("Wrong length");hi(this,{buffer:t,byteLength:r,byteOffset:o}),ti||(this.buffer=t,this.byteLength=r,this.byteOffset=o)},ti&&(addGetter$1(gi,"byteLength"),addGetter$1(vi,"buffer"),addGetter$1(vi,"byteLength"),addGetter$1(vi,"byteOffset")),redefineAll(vi.prototype,{getInt8:function getInt8(t){return get(this,1,t)[0]<<24>>24},getUint8:function getUint8(t){return get(this,1,t)[0]},getInt16:function getInt16(t){var e=get(this,2,t,arguments.length>1?arguments[1]:void 0);return(e[1]<<8|e[0])<<16>>16},getUint16:function getUint16(t){var e=get(this,2,t,arguments.length>1?arguments[1]:void 0);return e[1]<<8|e[0]},getInt32:function getInt32(t){return unpackInt32(get(this,4,t,arguments.length>1?arguments[1]:void 0))},getUint32:function getUint32(t){return unpackInt32(get(this,4,t,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function getFloat32(t){return Ti(get(this,4,t,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function getFloat64(t){return Ti(get(this,8,t,arguments.length>1?arguments[1]:void 0),52)},setInt8:function setInt8(t,e){set(this,1,t,packInt8,e)},setUint8:function setUint8(t,e){set(this,1,t,packInt8,e)},setInt16:function setInt16(t,e){set(this,2,t,packInt16,e,arguments.length>2?arguments[2]:void 0)},setUint16:function setUint16(t,e){set(this,2,t,packInt16,e,arguments.length>2?arguments[2]:void 0)},setInt32:function setInt32(t,e){set(this,4,t,packInt32,e,arguments.length>2?arguments[2]:void 0)},setUint32:function setUint32(t,e){set(this,4,t,packInt32,e,arguments.length>2?arguments[2]:void 0)},setFloat32:function setFloat32(t,e){set(this,4,t,packFloat32,e,arguments.length>2?arguments[2]:void 0)},setFloat64:function setFloat64(t,e){set(this,8,t,packFloat64,e,arguments.length>2?arguments[2]:void 0)}});setToStringTag(gi,"ArrayBuffer"),setToStringTag(vi,"DataView");var xi,ji={ArrayBuffer:gi,DataView:vi},Di=isObject$c,Ci=Math.floor,Ni=toInteger$5,toPositiveInteger=function(t){var e=Ni(t);if(e<0)throw RangeError("The argument can't be less than 0");return e},Ui=objectKeysInternal,Fi=Ae,Mi=Object.keys||function keys(t){return Ui(t,Fi)},Bi=mt,Vi=anObject$B,ki=Mi,Li=n?Object.defineProperties:function defineProperties(t,e){Vi(t);for(var r,n=ki(e),o=n.length,i=0;o>i;)Bi.f(t,r=n[i++],e[r]);return t},Gi=getBuiltIn$f("document","documentElement"),Wi=anObject$B,$i=Li,qi=Ae,Yi=Vt,Qi=Gi,Zi=documentCreateElement$1,zi=sharedKey$3("IE_PROTO"),EmptyConstructor=function(){},scriptTag=function(t){return"<script>"+t+"<\/script>"},NullProtoObjectViaActiveX=function(t){t.write(scriptTag("")),t.close();var e=t.parentWindow.Object;return t=null,e},NullProtoObject=function(){try{xi=new ActiveXObject("htmlfile")}catch(t){}NullProtoObject=document.domain&&xi?NullProtoObjectViaActiveX(xi):function(){var t,e=Zi("iframe");if(e.style)return e.style.display="none",Qi.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write(scriptTag("document.F=Object")),t.close(),t.F}()||NullProtoObjectViaActiveX(xi);for(var t=qi.length;t--;)delete NullProtoObject.prototype[qi[t]];return NullProtoObject()};Yi[zi]=!0;var Ki=Object.create||function create(t,e){var r;return null!==t?(EmptyConstructor.prototype=Wi(t),r=new EmptyConstructor,EmptyConstructor.prototype=null,r[zi]=t):r=NullProtoObject(),void 0===e?r:$i(r,e)},Xi=toObject$5,Hi=toLength$9,Ji=getIteratorMethod$3,ta=isArrayIteratorMethod$2,ea=functionBindContext,ra=jo.aTypedArrayConstructor,na=classofRaw$1,oa=Array.isArray||function isArray(t){return"Array"==na(t)},ia=isObject$c,aa=oa,ua=wellKnownSymbol$b("species"),arraySpeciesConstructor=function(t){var e;return aa(t)&&("function"!=typeof(e=t.constructor)||e!==Array&&!aa(e.prototype)?ia(e)&&null===(e=e[ua])&&(e=void 0):e=void 0),void 0===e?Array:e},fa=functionBindContext,ca=y,sa=toObject$5,la=toLength$9,arraySpeciesCreate=function(t,e){return new(arraySpeciesConstructor(t))(0===e?0:e)},pa=[].push,createMethod=function(t){var e=1==t,r=2==t,n=3==t,o=4==t,i=6==t,a=7==t,u=5==t||i;return function(f,c,s,l){for(var p,y,d=sa(f),h=ca(d),m=fa(c,s,3),g=la(h.length),v=0,w=l||arraySpeciesCreate,E=e?w(f,g):r||a?w(f,0):void 0;g>v;v++)if((u||v in h)&&(y=m(p=h[v],v,d),t))if(e)E[v]=y;else if(y)switch(t){case 3:return!0;case 5:return p;case 6:return v;case 2:pa.call(E,p)}else switch(t){case 4:return!1;case 7:pa.call(E,p)}return i?-1:n||o?o:E}},ya={forEach:createMethod(0),map:createMethod(1),filter:createMethod(2),some:createMethod(3),every:createMethod(4),find:createMethod(5),findIndex:createMethod(6),filterReject:createMethod(7)},da=getBuiltIn$f,ha=mt,ma=n,ga=wellKnownSymbol$b("species"),va=isObject$c,wa=eo,Ea=_export,ba=e,Sa=n,Ta=Mo,Aa=jo,Oa=ji,Ia=anInstance$2,Ra=createPropertyDescriptor$3,_a=Ot,Pa=function isInteger(t){return!Di(t)&&isFinite(t)&&Ci(t)===t},xa=toLength$9,ja=toIndex$2,toOffset=function(t,e){var r=toPositiveInteger(t);if(r%e)throw RangeError("Wrong offset");return r},Da=toPropertyKey$3,Ca=L,Na=yr,Ua=isObject$c,Fa=x,Ma=Ki,Ba=eo,Va=fe.f,ka=function from(t){var e,r,n,o,i,a,u=Xi(t),f=arguments.length,c=f>1?arguments[1]:void 0,s=void 0!==c,l=Ji(u);if(null!=l&&!ta(l))for(a=(i=l.call(u)).next,u=[];!(o=a.call(i)).done;)u.push(o.value);for(s&&f>2&&(c=ea(c,arguments[2],2)),r=Hi(u.length),n=new(ra(this))(r),e=0;r>e;e++)n[e]=s?c(u[e],e):u[e];return n},La=ya.forEach,setSpecies=function(t){var e=da(t),r=ha.f;ma&&e&&!e[ga]&&r(e,ga,{configurable:!0,get:function(){return this}})},Ga=mt,Wa=r,inheritIfRequired=function(t,e,r){var n,o;return wa&&"function"==typeof(n=e.constructor)&&n!==r&&va(o=n.prototype)&&o!==r.prototype&&wa(t,o),t},$a=Jt.get,qa=Jt.set,Ya=Ga.f,Qa=Wa.f,Za=Math.round,za=ba.RangeError,Ka=Oa.ArrayBuffer,Xa=Oa.DataView,Ha=Aa.NATIVE_ARRAY_BUFFER_VIEWS,Ja=Aa.TYPED_ARRAY_CONSTRUCTOR,tu=Aa.TYPED_ARRAY_TAG,eu=Aa.TypedArray,ru=Aa.TypedArrayPrototype,nu=Aa.aTypedArrayConstructor,ou=Aa.isTypedArray,fromList=function(t,e){for(var r=0,n=e.length,o=new(nu(t))(n);n>r;)o[r]=e[r++];return o},addGetter=function(t,e){Ya(t,e,{get:function(){return $a(this)[e]}})},isArrayBuffer=function(t){var e;return t instanceof Ka||"ArrayBuffer"==(e=Na(t))||"SharedArrayBuffer"==e},isTypedArrayIndex=function(t,e){return ou(t)&&!Fa(e)&&e in t&&Pa(+e)&&e>=0},iu=function getOwnPropertyDescriptor(t,e){return e=Da(e),isTypedArrayIndex(t,e)?Ra(2,t[e]):Qa(t,e)},au=function defineProperty(t,e,r){return e=Da(e),!(isTypedArrayIndex(t,e)&&Ua(r)&&Ca(r,"value"))||Ca(r,"get")||Ca(r,"set")||r.configurable||Ca(r,"writable")&&!r.writable||Ca(r,"enumerable")&&!r.enumerable?Ya(t,e,r):(t[e]=r.value,t)};Sa?(Ha||(Wa.f=iu,Ga.f=au,addGetter(ru,"buffer"),addGetter(ru,"byteOffset"),addGetter(ru,"byteLength"),addGetter(ru,"length")),Ea({target:"Object",stat:!0,forced:!Ha},{getOwnPropertyDescriptor:iu,defineProperty:au}),Mn.exports=function(t,e,r){var n=t.match(/\d+$/)[0]/8,o=t+(r?"Clamped":"")+"Array",i="get"+t,a="set"+t,u=ba[o],f=u,c=f&&f.prototype,s={},addElement=function(t,e){Ya(t,e,{get:function(){return function(t,e){var r=$a(t);return r.view[i](e*n+r.byteOffset,!0)}(this,e)},set:function(t){return function(t,e,o){var i=$a(t);r&&(o=(o=Za(o))<0?0:o>255?255:255&o),i.view[a](e*n+i.byteOffset,o,!0)}(this,e,t)},enumerable:!0})};Ha?Ta&&(f=e((function(t,e,r,i){return Ia(t,f,o),inheritIfRequired(Ua(e)?isArrayBuffer(e)?void 0!==i?new u(e,toOffset(r,n),i):void 0!==r?new u(e,toOffset(r,n)):new u(e):ou(e)?fromList(f,e):ka.call(f,e):new u(ja(e)),t,f)})),Ba&&Ba(f,eu),La(Va(u),(function(t){t in f||_a(f,t,u[t])})),f.prototype=c):(f=e((function(t,e,r,i){Ia(t,f,o);var a,u,c,s=0,l=0;if(Ua(e)){if(!isArrayBuffer(e))return ou(e)?fromList(f,e):ka.call(f,e);a=e,l=toOffset(r,n);var p=e.byteLength;if(void 0===i){if(p%n)throw za("Wrong length");if((u=p-l)<0)throw za("Wrong length")}else if((u=xa(i)*n)+l>p)throw za("Wrong length");c=u/n}else c=ja(e),a=new Ka(u=c*n);for(qa(t,{buffer:a,byteOffset:l,byteLength:u,length:c,view:new Xa(a)});s<c;)addElement(t,s++)})),Ba&&Ba(f,eu),c=f.prototype=Ma(ru)),c.constructor!==f&&_a(c,"constructor",f),_a(c,Ja,f),tu&&_a(c,tu,o),s[o]=f,Ea({global:!0,forced:f!=u,sham:!Ha},s),"BYTES_PER_ELEMENT"in f||_a(f,"BYTES_PER_ELEMENT",n),"BYTES_PER_ELEMENT"in c||_a(c,"BYTES_PER_ELEMENT",n),setSpecies(o)}):Mn.exports=function(){},(0,Mn.exports)("Uint32",(function(t){return function Uint32Array(e,r,n){return t(this,e,r,n)}}));var uu=Math.floor,mergeSort=function(t,e){var r=t.length,n=uu(r/2);return r<8?insertionSort(t,e):merge(mergeSort(t.slice(0,n),e),mergeSort(t.slice(n),e),e)},insertionSort=function(t,e){for(var r,n,o=t.length,i=1;i<o;){for(n=i,r=t[i];n&&e(t[n-1],r)>0;)t[n]=t[--n];n!==i++&&(t[n]=r)}return t},merge=function(t,e,r){for(var n=t.length,o=e.length,i=0,a=0,u=[];i<n||a<o;)i<n&&a<o?u.push(r(t[i],e[a])<=0?t[i++]:e[a++]):u.push(i<n?t[i++]:e[a++]);return u},fu=mergeSort,cu=g.match(/firefox\/(\d+)/i),su=!!cu&&+cu[1],lu=/MSIE|Trident/.test(g),pu=g.match(/AppleWebKit\/(\d+)\./),yu=!!pu&&+pu[1],du=fails$9,hu=aFunction$l,mu=toLength$9,gu=fu,vu=su,wu=lu,Eu=A,bu=yu,Su=jo.aTypedArray,Tu=jo.exportTypedArrayMethod,Au=e.Uint16Array,Ou=Au&&Au.prototype.sort,Iu=!!Ou&&!du((function(){var t=new Au(2);t.sort(null),t.sort({})})),Ru=!!Ou&&!du((function(){if(Eu)return Eu<74;if(vu)return vu<67;if(wu)return!0;if(bu)return bu<602;var t,e,r=new Au(516),n=Array(516);for(t=0;t<516;t++)e=t%4,r[t]=515-t,n[t]=t-2*e+3;for(r.sort((function(t,e){return(t/4|0)-(e/4|0)})),t=0;t<516;t++)if(r[t]!==n[t])return!0}));function isValidSchema(t){if(!t)return!1;return isObject$6(t)}function getDataFromStore(t,e){return t[e]}function setDataInStore(t,e,r){if(e<0||e>t.length)throw new SyntaxError("Entity is out of range.");if(!t.guard(r))throw new TypeError("Value is not correct type.");return t[e]=r,t}function defineDataStore(t){const{name:e,initial:r,guard:n,arrayType:o=Array,prefill:i=!1}=t;if(!e||!n)throw new SyntaxError("Invalid datastore spec - mandatory properties missing.");if(!isValidName(e))throw new Error("Invalid name.");const a=r();if(!n(a))throw new TypeError("Initial property is of invalid type. Make sure guard(initial()) returns true.");const u=new o,f=function isTypedArray$2(t){return Boolean(ArrayBuffer.isView(t)&&!(t instanceof DataView))}(u);if(f&&("number"!=typeof a||Number.isNaN(a)))throw new TypeError(`Initial property for typed array type must be a number. Found ${typeof a}.`);return Object.create(Object.getPrototypeOf(u),{getProp:{value:function(t){return this[t]},enumerable:!0},setProp:{value:function(t,e){if(t<0||t>this.length)throw new SyntaxError("Entity is out of range.");if(!this.guard(e))throw new TypeError("Property is not correct type.");return this[t]=e,this},enumerable:!0},arrayType:{value:o,enumerable:!0},guard:{value:n,enumerable:!0},initial:{value:r,enumerable:!0},isTypedArray:{value:f,enumerable:!0},name:{value:e,enumerable:!0},prefill:{value:i,enumerable:!0}})}function createDataStorage(t,e){const{arrayType:r,initial:n,prefill:o}=e,i=new r(t.spec.maxEntities);return Object.setPrototypeOf(i,e),!0===o&&i.fill(n()),i.world=t,i}async function createBitmaskFromComponents(t,...e){const r=function createBitmask(t=32){return new Uint32Array(Math.ceil(t/32))}(t.spec.maxComponents||32);if(!e.length)return r;return await Promise.all(e.map((e=>{if(e.world.id!==t.id)throw new Error("Components are not from the same world.");!function setBitOn(t,e){if(!function isValidBit(t,e){return!(e<0||e>function getMaxBit(t){return 32*t.length}(t))}(t,e))throw new SyntaxError(`Bit ${e} does not exist on mask.`);return t[Math.floor(e/32)]|=1<<e%32,t}(r,e.id)}))),r}function createComponent(t){if(!t)throw new SyntaxError("Component creation requires a specification object.");const{name:e,schema:r}=t;if(!isValidName(e))throw new SyntaxError("Component name is invalid.");if(!isValidSchema(r))throw new SyntaxError("Component schema is invalid.");return{instances:[],name:e,schema:r}}async function registerComponent(t,e){if(!t)throw new SyntaxError("Component registration requires a World object.");if(!e)throw new SyntaxError("Component registration requires a Component object.");const{instances:r,name:n,schema:o}=e,{components:i}=t;if(n in i)throw new Error(`Component with name "${n}" is already registered.`);const a=await indexOf(i,void 0);if(-1===a)throw new Error("Maximum components reached.");const u=Object.create(e,{entities:{value:new Set,enumerable:!0},id:{value:a,configurable:!1,enumerable:!0,writeable:!1},world:{value:t,configurable:!1,enumerable:!0,writeable:!1}});return await Promise.all(Object.entries(o).map((([e,r])=>{if(!isValidName(e))throw new SyntaxError(`Property name "${String(e)}" is invalid or forbidden.`);Object.defineProperty(u,e,{value:createDataStorage(t,r),configurable:!1,enumerable:!0,writable:!1})}))),r.push(u),i[a]=u,u}async function unregisterComponent(t){if(!t)throw new SyntaxError("Component instance required.");const{id:e,name:r,world:n}=t,{components:o}=n,i=o[e];if(!i||t!==i)throw new Error(`Component "${r}" does not exist in this world.`);return await Promise.all([...i.entities].map((t=>removeComponentFromEntity(i,t)))),delete o[e],n}async function addComponentToEntity(t,e,r){if(!t)throw new SyntaxError("Component instance required.");if("number"!=typeof e)throw new SyntaxError("Invalid or undefined entity provided.");const{id:n,name:o,schema:i,world:a}=t,{spec:u,components:f}=a;if(e<0||e>u.maxEntities)throw new Error(`Invalid entity provided: "${e}".`);const c=f[n];if(!c||t!==c)throw new Error(`Component "${o}" does not exist in this world.`);if(c.entities.has(e))throw new Error(`Entity "${e}" already has component "${o}".`);if(c.entities.add(e),r){const _resetData=t=>setDataInStore(c[t],e,r[t]);await Promise.all(Object.keys(i).map(_resetData))}return await updateEntityArchetype(a,e,c,!1),t}async function removeComponentFromEntity(t,e){if(!t)throw new SyntaxError("Component instance required.");if("number"!=typeof e)throw new SyntaxError("Invalid or undefined entity provided.");const{id:r,name:n,schema:o,world:i}=t,{spec:a,components:u}=i;if(e<0||e>a.maxEntities)throw new Error(`Invalid entity provided: "${e}".`);const f=u[r];if(void 0===f||t!==f)throw new Error(`Component "${n}" does not exist in this world.`);if(!f.entities.has(e))throw new Error(`Entity "${e}" does not have component "${n}" to remove.`);f.entities.delete(e);return await Promise.all(Object.keys(o).map((t=>function resetDataInStore(t,e){const{initial:r,isTypedArray:n,prefill:o}=t;if(e<0||e>t.length)throw new SyntaxError("Entity is out of range.");try{delete t[e]}catch(r){if(!n)throw new Error(r);t[e]=0}return!0===o&&(t[e]=r()),t}(f[t],e)))),await updateEntityArchetype(i,e,t,!0),t}async function createEntity(t){if(!t)throw new SyntaxError("Entity creation requires a World object.");const e=await indexOf(t.entities,void 0);if(-1===e)throw new Error("Maximum entities reached.");return await updateEntityArchetype(t,e),e}async function destroyEntity(t,e){if(!t)throw new SyntaxError("Entity destruction requires a World object.");if("number"!=typeof e)throw new SyntaxError("Invalid or undefined entity provided.");const{archetypes:r,spec:n,entities:o,queries:i}=t;if(e<0||e>n.maxEntities)throw new Error("Entity is out of range.");const a=o[e];if(delete o[e],void 0===a)return t;if(a.entities.delete(e),0===a.entities.size){const _removeArchetype=t=>removeArchetypeFromQuery(t,a);await Promise.all([...i.values()].map(_removeArchetype)),delete r[a.name]}return t}Tu("sort",(function sort(t){var e=this;if(void 0!==t&&hu(t),Ru)return Ou.call(e,t);Su(e);var r,n=mu(e.length),o=Array(n);for(r=0;r<n;r++)o[r]=e[r];for(o=gu(e,function(t){return function(e,r){return void 0!==t?+t(e,r)||0:r!=r?-1:e!=e?1:0===e&&0===r?1/e>0&&1/r<0?1:-1:e>r}}(t)),r=0;r<n;r++)e[r]=o[r];return e}),!Ru||Iu);const _filterEnabled=t=>!0===t.enabled;function runPreSystems(t){[...t.systems].filter(_filterEnabled).forEach((t=>t.pre(getEntitiesFromQuery(t.query))))}function runPostSystems(t,e=1){[...t.systems].filter(_filterEnabled).forEach((t=>{t.post(getEntitiesFromQuery(t.query),getComponentsFromQuery(t.query),e)}))}function runUpdateSystems(t,e=0){[...t.systems].filter(_filterEnabled).forEach((t=>{t.update(getEntitiesFromQuery(t.query),getComponentsFromQuery(t.query),e)}))}function createSystem(t){const{name:e,pre:r=systemNoop,post:n=systemNoop,update:o=systemNoop}=t;if(!isValidName(e))throw new SyntaxError("System name is invalid.");return{instances:[],name:e,post:n,pre:r,update:o}}async function registerSystem(t,e,r){const{systems:n}=t,o=await async function createQueryInstance(t,e){const{archetypes:r,components:n,queries:o}=t;if(o.has(e))return o.get(e);const _getInstance=async t=>{const e=await indexOf(n,t);if(-1===e)throw new Error("ComponentInstance not found.");return n[e]},[i,a,u]=await Promise.all([await Promise.all(e.all.map(_getInstance)),await Promise.all(e.any.map(_getInstance)),await Promise.all(e.none.map(_getInstance))]),[f,c,s]=await Promise.all([await createBitmaskFromComponents(t,...i),await createBitmaskFromComponents(t,...a),await createBitmaskFromComponents(t,...u)]),l={archetypes:[],and:f,or:c,not:s,world:t};return await Promise.all(Object.values(r).map((t=>isQueryCandidate(l,t)))),o.set(e,l),l}(t,r);let i=!1;const a=Object.create(e,{enabled:{get:()=>i,set(t){i=t},configurable:!1,enumerable:!0},query:{value:o,configurable:!1,enumerable:!0,writeable:!1},world:{value:t,configurable:!1,enumerable:!0,writeable:!1}});return e.instances.push(a),n.push(a),a}async function unregisterSystem(t){const{world:e}=t,{systems:r}=e,n=await indexOf(r,t);return void 0===n||spliceOne(r,n),e}function enableSystem(t){return t.enabled=!0,t}function disableSystem(t){return t.enabled=!1,t}function isSystemEnabled(t){return t.enabled}function numberGuard(t){return"number"==typeof t&&!Number.isNaN(t)}function initToZero(){return 0}(0,Mn.exports)("Int8",(function(t){return function Int8Array(e,r,n){return t(this,e,r,n)}})),(0,Mn.exports)("Uint8",(function(t){return function Uint8Array(e,r,n){return t(this,e,r,n)}})),(0,Mn.exports)("Uint8",(function(t){return function Uint8ClampedArray(e,r,n){return t(this,e,r,n)}}),!0),(0,Mn.exports)("Int16",(function(t){return function Int16Array(e,r,n){return t(this,e,r,n)}})),(0,Mn.exports)("Uint16",(function(t){return function Uint16Array(e,r,n){return t(this,e,r,n)}})),(0,Mn.exports)("Int32",(function(t){return function Int32Array(e,r,n){return t(this,e,r,n)}})),(0,Mn.exports)("Float32",(function(t){return function Float32Array(e,r,n){return t(this,e,r,n)}}));const _u=defineDataStore({guard:t=>!0,initial:()=>{},name:"any"}),Pu=defineDataStore({arrayType:Int8Array,guard:numberGuard,initial:initToZero,name:"i8"}),xu=defineDataStore({arrayType:Uint8Array,guard:numberGuard,initial:initToZero,name:"ui8"}),ju=defineDataStore({arrayType:Uint8ClampedArray,guard:numberGuard,initial:initToZero,name:"ui8c"}),Du=defineDataStore({arrayType:Int16Array,guard:numberGuard,initial:initToZero,name:"i16"}),Cu=defineDataStore({arrayType:Uint16Array,guard:numberGuard,initial:initToZero,name:"ui16"}),Nu=defineDataStore({arrayType:Int32Array,guard:numberGuard,initial:initToZero,name:"i32"}),Uu=defineDataStore({arrayType:Uint32Array,guard:numberGuard,initial:initToZero,name:"ui32"}),Fu=defineDataStore({arrayType:BigInt64Array,guard:numberGuard,initial:initToZero,name:"i64"}),Mu=defineDataStore({arrayType:BigUint64Array,guard:numberGuard,initial:initToZero,name:"ui64"}),Bu=defineDataStore({arrayType:Float32Array,guard:numberGuard,initial:initToZero,name:"f32"}),Vu=defineDataStore({arrayType:Int32Array,guard:numberGuard,initial:initToZero,name:"f64"}),ku=defineDataStore({guard:t=>Array.isArray(t),initial:()=>[],name:"array"}),Lu=defineDataStore({guard:t=>"boolean"==typeof t,initial:()=>!1,name:"boolean"}),Gu=defineDataStore({guard:t=>"function"==typeof t,initial:()=>()=>{},name:"function"}),Wu=defineDataStore({guard:numberGuard,initial:initToZero,name:"number"}),$u=defineDataStore({guard:t=>isObject$6(t),initial:()=>({}),name:"object"}),qu=defineDataStore({guard:t=>"string"==typeof t,initial:()=>"",name:"string"});var Yu=collectionDeleteAll$2;_export({target:"Map",proto:!0,real:!0,forced:false},{deleteAll:function deleteAll(){return Yu.apply(this,arguments)}});var getMapIterator$a=function(t){return Map.prototype.entries.call(t)},Qu=anObject$B,Zu=functionBindContext,zu=getMapIterator$a,Ku=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{every:function every(t){var e=Qu(this),r=zu(e),n=Zu(t,arguments.length>1?arguments[1]:void 0,3);return!Ku(r,(function(t,r,o){if(!n(r,t,e))return o()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Xu=getBuiltIn$f,Hu=anObject$B,Ju=aFunction$l,tf=functionBindContext,ef=speciesConstructor$9,rf=getMapIterator$a,nf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{filter:function filter(t){var e=Hu(this),r=rf(e),n=tf(t,arguments.length>1?arguments[1]:void 0,3),o=new(ef(e,Xu("Map"))),i=Ju(o.set);return nf(r,(function(t,r){n(r,t,e)&&i.call(o,t,r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),o}});var of=anObject$B,af=functionBindContext,uf=getMapIterator$a,ff=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{find:function find(t){var e=of(this),r=uf(e),n=af(t,arguments.length>1?arguments[1]:void 0,3);return ff(r,(function(t,r,o){if(n(r,t,e))return o(r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var cf=anObject$B,sf=functionBindContext,lf=getMapIterator$a,pf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{findKey:function findKey(t){var e=cf(this),r=lf(e),n=sf(t,arguments.length>1?arguments[1]:void 0,3);return pf(r,(function(t,r,o){if(n(r,t,e))return o(t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var yf=anObject$B,df=getMapIterator$a,sameValueZero=function(t,e){return t===e||t!=t&&e!=e},hf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{includes:function includes(t){return hf(df(yf(this)),(function(e,r,n){if(sameValueZero(r,t))return n()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var mf=anObject$B,gf=getMapIterator$a,vf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{keyOf:function keyOf(t){return vf(gf(mf(this)),(function(e,r,n){if(r===t)return n(e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var wf=getBuiltIn$f,Ef=anObject$B,bf=aFunction$l,Sf=functionBindContext,Tf=speciesConstructor$9,Af=getMapIterator$a,Of=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{mapKeys:function mapKeys(t){var e=Ef(this),r=Af(e),n=Sf(t,arguments.length>1?arguments[1]:void 0,3),o=new(Tf(e,wf("Map"))),i=bf(o.set);return Of(r,(function(t,r){i.call(o,n(r,t,e),r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),o}});var If=getBuiltIn$f,Rf=anObject$B,_f=aFunction$l,Pf=functionBindContext,xf=speciesConstructor$9,jf=getMapIterator$a,Df=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{mapValues:function mapValues(t){var e=Rf(this),r=jf(e),n=Pf(t,arguments.length>1?arguments[1]:void 0,3),o=new(xf(e,If("Map"))),i=_f(o.set);return Df(r,(function(t,r){i.call(o,t,n(r,t,e))}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),o}});var Cf=anObject$B,Nf=aFunction$l,Uf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{merge:function merge(t){for(var e=Cf(this),r=Nf(e.set),n=arguments.length,o=0;o<n;)Uf(arguments[o++],r,{that:e,AS_ENTRIES:!0});return e}});var Ff=anObject$B,Mf=aFunction$l,Bf=getMapIterator$a,Vf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{reduce:function reduce(t){var e=Ff(this),r=Bf(e),n=arguments.length<2,o=n?void 0:arguments[1];if(Mf(t),Vf(r,(function(r,i){n?(n=!1,o=i):o=t(o,i,r,e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),n)throw TypeError("Reduce of empty map with no initial value");return o}});var kf=anObject$B,Lf=functionBindContext,Gf=getMapIterator$a,Wf=iterate$p;_export({target:"Map",proto:!0,real:!0,forced:false},{some:function some(t){var e=kf(this),r=Gf(e),n=Lf(t,arguments.length>1?arguments[1]:void 0,3);return Wf(r,(function(t,r,o){if(n(r,t,e))return o()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var $f=anObject$B,qf=aFunction$l;_export({target:"Map",proto:!0,real:!0,forced:false},{update:function update(t,e){var r=$f(this),n=arguments.length;qf(e);var o=r.has(t);if(!o&&n<3)throw TypeError("Updating absent value");var i=o?r.get(t):qf(n>2?arguments[2]:void 0)(t,r);return r.set(t,e(i,t,r)),r}});const Yf=128,Qf=1e4,Zf={maxComponents:Yf,maxEntities:Qf};function createWorld(t=Zf){const{maxComponents:e=Yf,maxEntities:r=Qf}=t;return{archetypes:{},components:new Array(e),entities:new Array(r),id:`${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`,queries:new Map,spec:Object.freeze({maxComponents:e,maxEntities:r}),systems:[]}}export{addComponentToEntity,_u as any,ku as array,Lu as boolean,createComponent,createEntity,createQuery,createSystem,createWorld,defineDataStore,destroyEntity,disableSystem,enableSystem,Bu as f32,Vu as f64,Gu as fnc,getDataFromStore,Du as i16,Nu as i32,Fu as i64,Pu as i8,initToZero,isSystemEnabled,isValidName,isValidSchema,Wu as number,numberGuard,$u as object,registerComponent,registerSystem,removeComponentFromEntity,runPostSystems,runPreSystems,runUpdateSystems,setDataInStore,qu as string,Cu as ui16,Uu as ui32,Mu as ui64,xu as ui8,ju as ui8c,unregisterComponent,unregisterSystem};
//# sourceMappingURL=index.min.js.map
