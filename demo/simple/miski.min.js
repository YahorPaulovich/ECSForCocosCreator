/*! *****************************************************************************
 *
 * miski
 * v0.3.0
 *
 * MIT License
 * 
 * Copyright (C) 2021 Peter Hughes<https://www.phugh.es>, all rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
***************************************************************************** */
const e=Object.freeze(["_world","defaults","id","name","constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","prototype","toLocaleString","toString","valueOf","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupGetter__","__proto__"]);function bitIntersection(e,t){return e&t}function clamp(e,t,r){return null!=t&&e<t?t:null!=r&&e>r?r:e}function validName(t){return/^(?![0-9])[a-zA-Z0-9$_]+$/.test(t)&&!e.includes(t)}function isObject(e){return Boolean(e&&"object"==typeof e&&!Array.isArray(e))}function deepAssignObjects(e,...t){if(!t||!t.length)return e;const r={},n=t.shift();return isObject(e)&&isObject(n)&&(Object.keys(n).forEach((e=>{const t=Object.getOwnPropertyDescriptor(n,e);void 0!==t&&(r[e]={...t},isObject(t.value)?deepAssignObjects(t.value,n[e]):Array.isArray(t.value)&&(t.value=[...n[e]]))})),Object.getOwnPropertySymbols(n).forEach((e=>{const t=Object.getOwnPropertyDescriptor(n,e);void 0!==t&&t.enumerable&&(r[e]={...t},isObject(t.value)?deepAssignObjects(t.value,n[e]):Array.isArray(t.value)&&(t.value=[...n[e]]))})),Object.defineProperties(e,r)),deepAssignObjects(e,...t)}class Archetype{constructor(e,t=[]){this.id=e,this._registry=new Set(t)}addEntity(e){this._registry.add(e)}getEntities(){return[...this._registry]}isEmpty(){return 0===this._registry.size}removeEntity(e){this._registry.delete(e)}}function createGetArchetype(e){return function getArchetype(t){return e.get(t)}}function createGetArchetypes(e){return function getArchetypes(){return[...e.values()]}}function createGetEntitiesByComponents(e){return function getEntitiesByComponents(...t){const r=new Set;return t.forEach((t=>{e.forEach(((e,n)=>{bitIntersection(t.id,n)>0&&e.getEntities().forEach((e=>r.add(e)))}))})),[...r]}}function createIsArchetypeRegistered(e){return function isArchetypeRegistered(t){return e.has(t.id)||[...e.values()].includes(t)}}function createUpdateArchetype(e,t){return function updateArchetype(r,n){if(void 0!==n){const t=e.get(n);t&&(t.removeEntity(r),t.isEmpty()&&e.delete(n))}const s=r.getArchetype();return e.has(s)?e.get(s)?.addEntity(r):e.set(s,new Archetype(s,[r])),t}}class Component{constructor(e,t,r){const{name:n}=r;this.id=t,this.name=n,this._world=e,this.defaults=deepAssignObjects({},r.defaults),Object.keys(this.defaults).forEach((e=>{Object.defineProperty(this,e,Object.getOwnPropertyDescriptor(this.defaults,e))}))}getEntities(){return this._world.getEntitiesByComponents(this)}isRegistered(){return this._world.isComponentRegistered(this)}}function createGetComponents(e){return function getComponents(){return[...e.values()]}}function createGetComponentById(e){return function getComponentById(t){return[...e.values()].find((e=>e.id===t))}}function createGetComponentByName(e){return function getComponentByName(t){return e.get(t)}}function createIsComponentRegistered(e){return function isComponentRegistered(t){return e.has(t.name)||[...e.values()].includes(t)}}function createRegisterComponent(e,t,r,n){return function registerComponent(s){if(e.size>=r)throw new Error("Maximum number of components reached.");if(!validName(s.name))throw new SyntaxError(`"${s.name}" is not a valid component name.`);if(e.has(s.name))throw new Error(`Component with name "${s.name}" already registered.`);t.value+=1n;const i=new Component(n,t.value,s);return e.set(i.name,i),i}}function createUnregisterComponent(e,t){return function unregisterComponent(r){if(!e.has(r.name))throw new Error(`Component "${r.name}" is not registered.`);return r.getEntities().forEach((e=>e.removeComponent(r))),e.delete(r.name),t}}class Pool{constructor(e){const{create:t,destroy:r,initialSize:n,growthFactor:s,maxSize:i,world:o}=e;this.initialSize=n,this.growthFactor=s,this.maxSize=i,this._create=t,this._destroy=r,this._firstAvailable=null,this._pool=new Array(n),this._world=o,this.add(n)}add(e=1){for(let t=0;t<e;t++){if(this._pool.length>=this.maxSize)throw new Error("The pool is full!");const e=this._create(this._world);e.next=this._firstAvailable,this._firstAvailable=e,this._pool.push(e)}}clear(){this._pool.length=0,this._firstAvailable=null,this.add(this.initialSize)}get(){this._firstAvailable||this.add(this.initialSize*this.growthFactor);const e=this._firstAvailable;return this._firstAvailable=e.next,e}release(e){this._destroy(e),e.next=this._firstAvailable,this._firstAvailable=e}}class Mask{constructor(e=0n){this.mask=0n,this.mask=e}get value(){return this.mask}clear(){this.mask=0n}hasAll(e){return Boolean((e&this.mask)===this.mask)}hasAny(e){return Boolean(0n===this.mask||(e&this.mask)>0)}hasNone(e){return Boolean(0n===(e&this.mask))}off(e){return this.mask&=~(1n<<BigInt(e)),this.mask}on(e){return this.mask|=1n<<BigInt(e),this.mask}}class Entity{constructor(e){this.id=`${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`,this._archetype=new Mask,this._enabled=!1,this._next=null,this._properties=new Map,this._world=e}get enabled(){return this._enabled}get next(){return this._next}set next(e){this._next=e}addComponent(e,t){if("string"==typeof e){const t=this._world.getComponentByName(e);if(!t)throw new Error(`Component "${e}" not found!`);e=t}if(e instanceof Component){if(this._properties.has(e))throw new Error(`Entity already has component "${e.name}".`);this._properties.set(e,deepAssignObjects({},e.defaults,t??{})),Object.defineProperty(this,e.name,{get:()=>this._properties.get(e),set:t=>{const r=this._properties.get(e);if(Object.isFrozen(r))throw new Error(`Properties in component "${e.name}" cannot be modified.`);if(!r)throw new Error(`Component "${e.name}" does not exist in entity.`);Object.entries(t).forEach((([t,n])=>{if(!(t in r))throw new Error(`Property "${t}" does not exist in component "${e.name}".`);r[t]=n}))},enumerable:!0,configurable:!0});const r=this._archetype.value;return this._archetype.on(e.id),this._world.updateArchetype(this,r),!0}throw new SyntaxError("Invalid or unregistered component.")}clear(){Object.keys(this._properties).forEach((e=>delete this[e])),this._properties.clear();const e=this._archetype.value;this._archetype.clear(),this._world.updateArchetype(this,e)}disable(){this._enabled=!1}enable(){this._enabled=!0}getArchetype(){return this._archetype.value}hasComponent(e){const t="string"==typeof e?e:e.name;return Boolean(Reflect.has(this._properties,t))}removeComponent(e){if("string"==typeof e){const t=this._world.getComponentByName(e);if(!t)throw new Error(`Component "${e}" not found!`);e=t}if(!this._properties.has(e))throw new Error(`Entity ${this.id} has no component "${e.name}".`);this._properties.delete(e);try{delete this[e.name]}catch(t){console.warn(`Could not remove property ${e.name} from entity.`)}const t=this._archetype.value;return this._archetype.off(e.id),this._world.updateArchetype(this,t),!0}}function createCreateEntity(e,t,r){return function createEntity(){const n=e.get();if(!(n&&n instanceof Entity))throw new Error("No entities left! Pool is empty.");return t.set(n.id,n),r.updateArchetype(n),n}}function createDestroyEntity(e,t,r){return function destroyEntity(n){if(n===r.global)throw new Error("Destroying the global entity is forbidden.");return!!t.has(n.id)&&(r.getArchetype(n.getArchetype())?.removeEntity(n),t.delete(n.id),e.release(n),!0)}}function createGetEntities(e){return function getEntities(){return[...e.values()]}}function createGetEntityById(e){return function getEntityById(t){return e.get(t)}}function createIsEntityRegistered(e){return function isEntityRegistered(t){return e.has(t.id)||[...e.values()].includes(t)}}class Query{constructor(e,t){this._registry=new Set,this._world=e,this._all=new Set(t.all),this._any=new Set(t.any),this._none=new Set(t.none),this._mskAll=new Mask,this._mskAny=new Mask,this._mskNone=new Mask,this._refresh()}get size(){return this._registry.size}getEntities(){return[...this._registry]}hasEntity(e){return this._registry.has(e)}matches(e){const t=0n===this._mskAny.value||bitIntersection(e,this._mskAny.value)>0,r=bitIntersection(e,this._mskAll.value)===this._mskAll.value,n=0n===bitIntersection(e,this._mskNone.value);return t&&r&&n}_refresh(){this._all.forEach((e=>{this._mskAll.on(e.id),!1===e.isRegistered()&&console.warn(`Query has unregistered component ("${e.id}") in _all.`,this)})),this._any.forEach((e=>{this._mskAny.on(e.id),!0===e.isRegistered()&&console.warn(`Query has unregistered component ("${e.id}") in _any.`,this)})),this._none.forEach((e=>{this._mskNone.on(e.id),!0===e.isRegistered()&&console.warn(`Query has unregistered component ("${e.id}") in _none.`,this)}))}update(){this._refresh(),this._registry.clear(),this._world.getArchetypes().forEach((e=>{this.matches(e.id)&&e.getEntities().forEach((e=>this._registry.add(e)))}))}}function createIsQueryRegistered(e){return function isQueryRegistered(t){return e.has(t)}}function createRegisterQuery(e,t){return function registerQuery(r){const n=new Query(t,r);return e.add(n),n}}function createRefreshQueries(e,t){return function refreshQueries(){return e.forEach((e=>e.update())),t}}function createUnregisterQuery(e,t){return function unregisterQuery(r){return e.delete(r),t}}function createPre(e){return function pre(){return e.getPreSystems().forEach((t=>t.pre(t.entities,e.global))),e}}function createPost(e){return function post(t=0){return e.getPostSystems().forEach((r=>r.post(r.entities,e.global,t))),e.refreshQueries(),e}}function createStep(e,t,r){let n=null,s=0;const i=t;return function step(o=0){if(null!==n){s+=.001*(o-n);let t=0;for(r.pre();s>i;){if(t>=e){s=1;break}r.update(i),s-=i,t++}}return n=o,r.post(s/t),r}}function createUpdate(e){return function update(t=0){return e.getUpdateSystems().forEach((r=>r.update(r.entities,e.global,t))),e}}function noopPre(e,t){}function noopPost(e,t,r){}function noopUpdate(e,t,r){}class System{constructor(e,t){const{name:r,query:n=null,pre:s=noopPre,post:i=noopPost,update:o=noopUpdate}=t;this.name=r,this.query=n,this.pre=s,this.post=i,this.update=o,this._enabled=!1,this._world=e}get enabled(){return this._enabled}get entities(){return null===this.query?this._world.getEntities():this.query.getEntities()}disable(){this._enabled=!1}enable(){this._enabled=!0}}function createGetSystems(e){return function getSystems(){return[...e]}}function createGetPostSystems(e){return function getPostSystems(){return e.filter((e=>e.post&&e.post!==noopPost&&e.enabled))}}function createGetPreSystems(e){return function getPreSystems(){return e.filter((e=>e.pre&&e.pre!==noopPre&&e.enabled))}}function createGetUpdateSystems(e){return function getUpdateSystems(){return e.filter((e=>e.update&&e.update!==noopUpdate&&e.enabled))}}function createGetSystemByIdx(e){return function getSystemByIdx(t){return e[t]}}function createGetSystemByName(e){return function getSystemByName(t){return e.get(t)}}function createIsSystemRegistered(e){return function isSystemRegistered(t){return e.has(t.name)||[...e.values()].includes(t)}}function createMoveSystem(e){return function moveSystem(t,r){const n=e.indexOf(t);if(-1===n)return-1;const s=clamp(r,0,e.length);return e.splice(s,1),e.splice(n,0,t),s}}function createRegisterSystem(e,t,r){return function registerSystem(n,s){if(!validName(n.name))throw new SyntaxError(`"${n.name}" is not a valid system name.`);if(t.has(n.name))throw new Error(`System "${n.name}" is already registered!`);const i=new System(r,n);return void 0!==s?e.splice(clamp(s,0,e.length),0,i):e.push(i),t.set(i.name,i),i}}function createUnregisterSystem(e,t,r){return function unregisterSystem(n){if(!t.has(n.name))throw new Error(`System "${n.name}" is not registered!`);t.delete(n.name);const s=e.indexOf(n);return s>-1&&e.splice(s,1),r}}function createWorld(t={}){const{entityPoolGrowthFactor:r=.25,initialEntityPoolSize:n=128,maxComponents:s=256,maxEntities:i=Number.POSITIVE_INFINITY,maxUpdates:o=240,tempo:a=1/60}=t,c=Object.create(null);return Object.assign(c,function createArchetypeManager(e,t){const r=new Map;return{getArchetype:createGetArchetype(r),getArchetypes:createGetArchetypes(r),getEntitiesByComponents:createGetEntitiesByComponents(r),isArchetypeRegistered:createIsArchetypeRegistered(r),updateArchetype:createUpdateArchetype(r,e)}}(c),function createComponentManager(e,t){const{maxComponents:r}=t,n=new Map;return{getComponentById:createGetComponentById(n),getComponentByName:createGetComponentByName(n),getComponents:createGetComponents(n),isComponentRegistered:createIsComponentRegistered(n),registerComponent:createRegisterComponent(n,{value:0n},r,e),unregisterComponent:createUnregisterComponent(n,e)}}(c,{maxComponents:s}),function createEntityManager(e,t){const{entityPoolGrowthFactor:r,initialEntityPoolSize:n,maxEntities:s}=t,i=new Pool({create:function(){return new Entity(e)},destroy:function(e){e.clear()},initialSize:n,growthFactor:r,maxSize:s,world:e}),o=new Map;return{createEntity:createCreateEntity(i,o,e),destroyEntity:createDestroyEntity(i,o,e),getEntities:createGetEntities(o),getEntityById:createGetEntityById(o),isEntityRegistered:createIsEntityRegistered(o)}}(c,{entityPoolGrowthFactor:r,initialEntityPoolSize:n,maxEntities:i}),function createQueryManager(e,t){const r=new Set;return{isQueryRegistered:createIsQueryRegistered(r),registerQuery:createRegisterQuery(r,e),refreshQueries:createRefreshQueries(r,e),unregisterQuery:createUnregisterQuery(r,e)}}(c),function createStepManager(e,t){const{maxUpdates:r,tempo:n}=t;return{post:createPost(e),pre:createPre(e),step:createStep(r,n,e),update:createUpdate(e)}}(c,{maxUpdates:o,tempo:a}),function createSystemManager(e,t){const r=[],n=new Map;return{getSystems:createGetSystems(r),getPostSystems:createGetPostSystems(r),getPreSystems:createGetPreSystems(r),getUpdateSystems:createGetUpdateSystems(r),getSystemByIdx:createGetSystemByIdx(r),getSystemByName:createGetSystemByName(n),isSystemRegistered:createIsSystemRegistered(n),moveSystem:createMoveSystem(r),registerSystem:createRegisterSystem(r,n,e),unregisterSystem:createUnregisterSystem(r,n,e)}}(c)),c.global=c.createEntity(),c.FORBIDDEN_NAMES=[...e],c}export{createWorld};
//# sourceMappingURL=index.min.js.map
